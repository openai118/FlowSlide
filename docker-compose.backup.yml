version: '3.8'

services:
  # ä¸»è¦çš?LandPPT æœåŠ¡
  landppt:
    extends:
      file: docker-compose.yml
      service: landppt
    
  # å®šæ—¶å¤‡ä»½æœåŠ¡
  backup-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.ci-compatible
    container_name: landppt-backup-scheduler
    depends_on:
      - landppt
    environment:
      # ç»§æ‰¿ä¸»æœåŠ¡çš„ç¯å¢ƒå˜é‡
      - DB_HOST=your-supabase-host
      - DB_PORT=5432
      - DB_NAME=postgres
      - DB_USER=your_db_user
      - DB_PASSWORD=your_secure_password
      
      # Supabase settings
      - SUPABASE_URL=https://your-project.supabase.co
      - SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpdXpldGF6cGVyZWJ1cXdtcm5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTI2NjgsImV4cCI6MjA3MDUyODY2OH0.aQwP7h_SFau6UsfsGbUHY3kf-RDYM8LEOLu0hsbv5Ns
      - SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpdXpldGF6cGVyZWJ1cXdtcm5hIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDk1MjY2OCwiZXhwIjoyMDcwNTI4NjY4fQ.8vdb7DH860INPx5ZhDd9JTdsfJtDAhOizQNZgEqONNE
      
      # R2 å¤‡ä»½é…ç½®
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - BACKUP_WEBHOOK_URL=${BACKUP_WEBHOOK_URL}
      
      # å¤‡ä»½è°ƒåº¦é…ç½®
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}  # é»˜è®¤æ¯å¤©å‡Œæ™¨2ç‚?
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-30}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # è®¿é—®ä¸»å®¹å™¨æ•°æ?
      - landppt_data:/app/data:ro
      - landppt_reports:/app/research_reports:ro
      - landppt_logs:/app/logs:ro
    restart: unless-stopped
    command: >
      sh -c "
        echo 'å¤‡ä»½è°ƒåº¦å™¨å¯åŠ?..'
        echo '$${BACKUP_SCHEDULE} /app/backup-active.sh' > /etc/crontabs/root
        echo 'å®šæ—¶ä»»åŠ¡å·²è®¾ç½? $${BACKUP_SCHEDULE}'
        crond -f -l 2
      "
    healthcheck:
      test: ["CMD", "pgrep", "crond"]
      interval: 60s
      timeout: 10s
      retries: 3
    labels:
      - "landppt.service=backup-scheduler"
      - "landppt.description=Automated backup service for LandPPT"

  # æŒ‰éœ€å¤‡ä»½æœåŠ¡
  manual-backup:
    build:
      context: .
      dockerfile: Dockerfile.ci-compatible
    container_name: landppt-manual-backup
    profiles: ["backup"]  # åªåœ¨å¤‡ä»½é…ç½®æ–‡ä»¶ä¸­å¯åŠ?
    environment:
      # ç»§æ‰¿ç›¸åŒçš„ç¯å¢ƒå˜é‡?
      - DB_HOST=your-supabase-host
      - DB_PORT=5432
      - DB_NAME=postgres
      - DB_USER=your_db_user
      - DB_PASSWORD=your_secure_password
      - SUPABASE_URL=https://your-project.supabase.co
      - SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpdXpldGF6cGVyZWJ1cXdtcm5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTI2NjgsImV4cCI6MjA3MDUyODY2OH0.aQwP7h_SFau6UsfsGbUHY3kf-RDYM8LEOLu0hsbv5Ns
      - SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpdXpldGF6cGVyZWJ1cXdtcm5hIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDk1MjY2OCwiZXhwIjoyMDcwNTI4NjY4fQ.8vdb7DH860INPx5ZhDd9JTdsfJtDAhOizQNZgEqONNE
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - BACKUP_WEBHOOK_URL=${BACKUP_WEBHOOK_URL}
    volumes:
      - landppt_data:/app/data:ro
      - landppt_reports:/app/research_reports:ro
      - landppt_logs:/app/logs:ro
    command: ["./backup-active.sh"]
    labels:
      - "landppt.service=manual-backup"
      - "landppt.description=On-demand backup service for LandPPT"

# é‡ç”¨ä¸»é…ç½®æ–‡ä»¶çš„å?
volumes:
  landppt_data:
    external: true
  landppt_reports:
    external: true
  landppt_logs:
    external: true

networks:
  default:
    name: landppt_network
