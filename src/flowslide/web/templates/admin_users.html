{% extends "base.html" %}

{% block title %}用户管理{% endblock %}

{% block extra_css %}
<style>
.admin-users { max-width: 1000px; margin: 0 auto; }
.toolbar { display:flex; gap:8px; align-items:center; justify-content: space-between; margin-bottom: 12px; }
.table { width:100%; border-collapse: collapse; background: var(--glass-bg); border:1px solid var(--glass-border); border-radius:8px; overflow:hidden; }
.table th, .table td { padding:10px 12px; border-bottom:1px solid var(--glass-border); font-size: 14px; }
.table th { background: var(--panel-bg); text-align:left; }
.table tr:hover { background: rgba(0,0,0,0.03); }
.inline { display:flex; gap:8px; }
input, select { padding:8px 10px; border:1px solid var(--glass-border); border-radius:6px; }
.badge { display:inline-block; padding:4px 8px; border-radius:6px; font-size:12px; }
.badge-admin { background: var(--tint-purple); color: var(--accent-purple); border:1px solid rgba(130,80,223,0.3); }
.badge-user { background: var(--tint-blue); color: var(--accent-blue); border:1px solid rgba(9,105,218,0.3); }
</style>
{% endblock %}

{% block content %}
<div class="admin-users">
  <h2 style="margin-bottom:8px;">用户管理</h2>
  <p style="color: var(--text-secondary); margin-top:0;">创建、查看与删除用户（仅管理员）</p>

  <div class="toolbar">
    <div class="inline">
      <input id="new-username" placeholder="用户名" />
      <input id="new-email" placeholder="邮箱(可选)" />
      <input id="new-password" type="password" placeholder="密码" />
      <select id="new-is-admin">
        <option value="false">普通用户</option>
        <option value="true">管理员</option>
      </select>
      <button class="btn btn-primary" id="create-user">创建</button>
    </div>
    <button class="btn btn-secondary" id="refresh">刷新</button>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>用户名</th>
        <th>邮箱</th>
        <th>角色</th>
        <th>创建时间</th>
        <th style="text-align:right;">操作</th>
      </tr>
    </thead>
    <tbody id="users-body">
      <tr><td colspan="6" style="text-align:center; color:var(--text-secondary);">加载中...</td></tr>
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadUsers() {
  const body = document.getElementById('users-body');
  body.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-secondary);">加载中...</td></tr>';
  const r = await fetch('/api/admin/users', { cache: 'no-store' });
  if (!r.ok) { body.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#d1242f;">加载失败</td></tr>'; return; }
  const data = await r.json();
  const users = (data && data.users) ? data.users : [];
  // 标记当前用户，防止删除自己（后端也阻止，但前端友好展示）
  const me = (data && data.user) ? data.user : null;
  if (!users.length) { body.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-secondary);">暂无用户</td></tr>'; return; }
  body.innerHTML = users.map(u => `
    <tr>
      <td>${u.id}</td>
      <td>${u.username}</td>
      <td>${u.email || ''}</td>
      <td>${u.is_admin ? '<span class="badge badge-admin">管理员</span>' : '<span class="badge badge-user">普通用户</span>'}</td>
      <td>${u.created_at ? new Date(u.created_at * 1000).toLocaleString() : ''}</td>
      <td style="text-align:right;">
        ${(me && me.id === u.id) ? '' : `<button class="btn btn-danger btn-sm" onclick="delUser(${u.id})">删除</button>`}
      </td>
    </tr>
  `).join('');
}

async function createUser() {
  const username = document.getElementById('new-username').value.trim();
  const email = document.getElementById('new-email').value.trim();
  const password = document.getElementById('new-password').value;
  const is_admin = document.getElementById('new-is-admin').value === 'true';
  if (!username || !password) { alert('请输入用户名和密码'); return; }
  const form = new FormData();
  form.append('username', username);
  form.append('password', password);
  if (email) form.append('email', email);
  form.append('is_admin', String(is_admin));
  const r = await fetch('/api/admin/users', { method: 'POST', body: form });
  if (!r.ok) { const e = await r.json().catch(()=>({detail:'创建失败'})); alert(e.detail || '创建失败'); return; }
  document.getElementById('new-username').value = '';
  document.getElementById('new-email').value = '';
  document.getElementById('new-password').value = '';
  document.getElementById('new-is-admin').value = 'false';
  await loadUsers();
}

async function delUser(id) {
  if (!confirm('确定删除该用户吗？')) return;
  const r = await fetch('/api/admin/users/' + id, { method: 'DELETE' });
  if (!r.ok) { const e = await r.json().catch(()=>({detail:'删除失败'})); alert(e.detail || '删除失败'); return; }
  await loadUsers();
}

document.getElementById('create-user').addEventListener('click', createUser);

document.getElementById('refresh').addEventListener('click', loadUsers);

loadUsers();
</script>
{% endblock %}
