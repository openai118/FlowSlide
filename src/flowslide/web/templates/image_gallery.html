{% extends "base.html" %}

{% block title %}æœ¬åœ°å›¾åºŠç®¡ç† - FlowSlide{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 40px;">
    <h2 style="color: var(--text-primary); margin-bottom: 20px;">ğŸ–¼ï¸ æœ¬åœ°å›¾åºŠç®¡ç†</h2>
    <p style="font-size: 1.1em; color: var(--text-secondary);">
        ç®¡ç†å’Œæµè§ˆæ‚¨çš„æœ¬åœ°å›¾ç‰‡åº“
    </p>
</div>

<!-- æ“ä½œå·¥å…·æ  -->
<div class="toolbar" style="margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <!-- åˆ†ç±»ç­›é€‰ -->
            <select id="category-filter" onchange="filterImages()" style="padding: 10px 12px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-primary); border-radius: 8px;">
                <option value="all">å…¨éƒ¨åˆ†ç±»</option>
                <option value="ai_generated">AIç”Ÿæˆ</option>
                <option value="web_search">ç½‘ç»œæœç´¢</option>
                <option value="local_storage">æœ¬åœ°ä¸Šä¼ </option>
            </select>

            <!-- æœç´¢æ¡† -->
            <div style="position: relative;">
                <input type="text" id="search-input" placeholder="æœç´¢å›¾ç‰‡..."
                       style="padding: 10px 40px 10px 15px; border: 2px solid var(--glass-border); background: var(--glass-bg); color: var(--text-primary); border-radius: 8px; width: 420px;"
                       onkeyup="searchImages(event)">
                <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">ğŸ”</span>
            </div>

            <!-- æ’åºé€‰é¡¹ -->
            <select id="sort-option" onchange="sortImages()" style="padding: 10px 12px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-primary); border-radius: 8px;">
                <option value="created_desc">æœ€æ–°åˆ›å»º</option>
                <option value="created_asc">æœ€æ—©åˆ›å»º</option>
                <option value="accessed_desc">æœ€è¿‘è®¿é—®</option>
                <option value="size_desc">æ–‡ä»¶å¤§å°â†“</option>
                <option value="size_asc">æ–‡ä»¶å¤§å°â†‘</option>
            </select>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
            <!-- ä¸Šä¼ æŒ‰é’® -->
            <button type="button" id="open-upload-modal-btn" onclick="showUploadModal()" class="btn btn-primary">
                ğŸ“¤ ä¸Šä¼ å›¾ç‰‡
            </button>

            <!-- æ‰¹é‡æ“ä½œ -->
            <button onclick="toggleBatchMode()" class="btn btn-info" id="batch-mode-btn">
                â˜‘ï¸ æ‰¹é‡é€‰æ‹©
            </button>

            <!-- åˆ·æ–°æŒ‰é’® -->
            <button onclick="refreshGallery()" class="btn btn-success">
                ğŸ”„ åˆ·æ–°
            </button>
        </div>
    </div>
</div>

<!-- æœ€å°å†…è”å…œåº•ï¼Œç¡®ä¿ showUploadModal æ€»æ˜¯å¯ç”¨ -->
<script>
  window.showUploadModal = window.showUploadModal || function() {
    var modal = document.getElementById('upload-modal');
    if (modal) modal.style.display = 'flex';
  };
</script>

<!-- å…³é”®äº‹ä»¶å…œåº•ï¼ˆcloseUploadModal / handleFileSelectï¼‰ -->
<script>
(function(){
  try {
    if (!('selectedFiles' in window)) window.selectedFiles = [];
    if (!window.closeUploadModal) window.closeUploadModal = function(){
      try{
        var m=document.getElementById('upload-modal'); if(m) m.style.display='none';
        var up=document.getElementById('upload-progress'); if(up) up.style.display='none';
        var info=document.getElementById('image-info-section'); if(info) info.style.display='none';
        var pf=document.getElementById('progress-fill'); if(pf) pf.style.width='0%';
        var fi=document.getElementById('file-input'); if(fi) fi.value='';
        window.selectedFiles = [];
      }catch(e){ console.error(e); }
    };
    // å¼ºåŒ–å…œåº•ï¼šä¸ä¸»é€»è¾‘ä¿æŒä¸€è‡´ï¼Œä»…è´Ÿè´£æ”¶é›†æ–‡ä»¶å¹¶è§¦å‘ç»Ÿä¸€çš„ startUpload
    window.handleFileSelect = function(event){
      try{
        var files = (event && event.target && event.target.files) ? Array.from(event.target.files) : [];
        if (!files || !files.length) return;
        // ä»…ä¿ç•™åç«¯æ”¯æŒçš„æ ¼å¼
        var allowed = ['image/jpeg','image/jpg','image/png','image/webp','image/gif'];
        var valid = files.filter(function(f){ return allowed.indexOf(f.type)>=0; });
        if (!valid.length) { try{ alert('è¯·é€‰æ‹© JPG/PNG/WEBP/GIF å›¾ç‰‡'); }catch(e){} return; }
        window.selectedFiles = valid;
        // å±•ç¤ºä¿¡æ¯è¾“å…¥åŒºï¼Œä¸ç«‹å³ä¸Šä¼ ï¼Œä¿æŒä¸ä¸»æµç¨‹ä¸€è‡´
        var info=document.getElementById('image-info-section'); if(info) info.style.display='block';
        var up=document.getElementById('upload-progress'); if(up) up.style.display='none';
        var title=document.getElementById('image-title'); if(title && valid.length===1){ title.value=(valid[0].name||'').replace(/\.[^.]+$/,''); }
        // è‹¥é¡µé¢æ²¡æœ‰â€œå¼€å§‹ä¸Šä¼ â€æŒ‰é’®ï¼ˆæç«¯æƒ…å†µï¼‰ï¼Œåˆ™ç›´æ¥è°ƒç”¨ä¸»ä¸Šä¼ æµç¨‹
        var btn=document.getElementById('start-upload-btn');
        if (!btn && typeof window.startUpload==='function') { window.startUpload(); }
      }catch(e){ console.error('fallback handleFileSelect error', e); }
    };
    // å…œåº•ï¼šå¦‚æœé¡µé¢ä¸»è„šæœ¬æœªæˆåŠŸåŠ è½½ï¼Œæä¾›ä¸€ä¸ªæœ€å°å¯ç”¨çš„ startUpload
    if (!window.startUpload) window.startUpload = async function(){
      try{
        var files = Array.isArray(window.selectedFiles) ? window.selectedFiles : [];
        if (!files.length) { (window.showError||function(m){console.error(m); alert(m);})("è¯·å…ˆé€‰æ‹©æ–‡ä»¶"); return; }

        var titleEl=document.getElementById('image-title');
        var descEl=document.getElementById('image-description');
        var tagsEl=document.getElementById('image-tags');
        var catEl=document.getElementById('image-category');
        var title=(titleEl&&titleEl.value||'').trim();
        var description=(descEl&&descEl.value||'').trim();
        var tags=(tagsEl&&tagsEl.value||'').trim();
        var category=(catEl&&catEl.value)||'local_storage';

        var info=document.getElementById('image-info-section'); if(info) info.style.display='none';
        var up=document.getElementById('upload-progress'); if(up) up.style.display='block';
        var statusEl=document.getElementById('upload-status');
        var fill=document.getElementById('progress-fill');

        var uploaded=0, total=files.length;
        for (var i=0;i<files.length;i++){
          var f=files[i];
          try{
            if (statusEl) statusEl.textContent = 'æ­£åœ¨ä¸Šä¼  ' + (f.name||('ç¬¬'+(i+1)+'ä¸ªæ–‡ä»¶')) + ' ('+(i+1)+'/'+total+')';
            var fd=new FormData();
            fd.append('file', f);
            fd.append('title', title || (f.name||'').replace(/\.[^.]+$/,''));
            fd.append('description', description);
            fd.append('tags', tags);
            fd.append('category', category);
            var resp = await fetch('/api/image/upload', { method:'POST', body: fd });
            var data = {};
            try{ data = await resp.json(); }catch(_){ }
            if (resp.ok && data && data.success) uploaded++; else console.error('upload failed', data||resp.status);
          }catch(e){ console.error('upload error', e); }
          if (fill) fill.style.width = (((i+1)/total)*100)+'%';
        }
        if (statusEl) statusEl.textContent = 'ä¸Šä¼ å®Œæˆï¼æˆåŠŸä¸Šä¼  '+uploaded+'/'+total+' ä¸ªæ–‡ä»¶';
        if (uploaded>0){ setTimeout(function(){ try{ if (typeof window.closeUploadModal==='function') window.closeUploadModal(); }catch(e){}; try{ if (typeof window.refreshGallery==='function') window.refreshGallery(); }catch(e){}; (window.showSuccess||function(m){console.log(m);})('æˆåŠŸä¸Šä¼  '+uploaded+' å¼ å›¾ç‰‡'); }, 1200); }
      }catch(e){ console.error('fallback startUpload error', e); }
    };

  } catch(e) { console.error('fallback init error', e); }
})();
</script>

<!-- å›¾åº“åŠ è½½å…œåº•ï¼šè‹¥ä¸»è„šæœ¬æœªæ³¨å†Œ loadImages/renderImageGrid/refreshGalleryï¼Œåˆ™æä¾›æœ€å°å®ç° -->
<script>
(function(){
  try{
    if (typeof window.loadImages !== 'function' || typeof window.renderImageGrid !== 'function' || typeof window.refreshGallery !== 'function'){
      if (!('itemsPerPage' in window)) window.itemsPerPage = 20;
      if (!('currentPage' in window)) window.currentPage = 1;
      if (!('currentImages' in window)) window.currentImages = [];
      if (!('filteredImages' in window)) window.filteredImages = [];

      window.refreshGallery = window.refreshGallery || function(){
        try { window.loadImages(window.currentPage||1); } catch(e){ console.error(e); }
      };

      window.renderImageGrid = window.renderImageGrid || function(){
        var grid = document.getElementById('image-grid');
        if (!grid) return;
        var images = window.filteredImages || [];
        if (!Array.isArray(images) || !images.length){
          grid.innerHTML = '<div class="loading-placeholder" style="text-align: center; padding: 60px; color: var(--text-secondary); grid-column: 1 / -1;">\
<div style="font-size: 3em; margin-bottom: 20px;">ğŸ“·</div><p>æš‚æ— å›¾ç‰‡</p></div>';
          return;
        }
        var origin = (window.location && window.location.origin) || '';
        var bm = !!window.batchMode;
        if (!('selectedImages' in window) || !(window.selectedImages instanceof Set)) window.selectedImages = new Set();
        grid.innerHTML = images.map(function(image){
          var id = image.image_id || image.id || '';
          var title = (image && (image.title || image.filename)) || id;
          var fileSize = image && image.file_size ? (Math.round(image.file_size/1024)+' KB') : '';
          var checked = window.selectedImages.has(id) ? 'checked' : '';
          var checkbox = bm ? '<input type="checkbox" class="batch-checkbox" '+checked+' onchange="toggleImageSelection(\''+id+'\')">' : '';
          return '<div class="image-item" data-image-id="'+id+'">'+
            checkbox+
            '<img class="image-thumbnail" src="'+ origin + '/api/image/thumbnail/' + id + '" alt="'+ title.replace(/"/g,'&quot;') +'" onclick="showImageDetail(\''+id+'\')" onerror="this.src=\'/static/images/placeholder.svg\'">'+
            '<div class="image-info">'+
              '<div class="image-title">'+ title +'</div>'+
              '<div class="image-meta"><span>'+ fileSize +'</span></div>'+
              '<div class="image-actions">'+
                '<button onclick="downloadSingleImage(\''+id+'\')" class="btn btn-sm btn-primary">ä¸‹è½½</button>'+
                '<button onclick="deleteSingleImage(\''+id+'\')" class="btn btn-sm btn-danger">åˆ é™¤</button>'+
              '</div>'+
            '</div>'+
          '</div>';
        }).join('');
      };

      window.loadImages = window.loadImages || async function(page){
        try{
          page = page || 1; window.currentPage = page;
          var categoryEl = document.getElementById('category-filter');
          var searchEl = document.getElementById('search-input');
          var sortEl = document.getElementById('sort-option');
          var params = new URLSearchParams({
            page: page,
            per_page: window.itemsPerPage || 20,
            category: (categoryEl && categoryEl.value && categoryEl.value !== 'all') ? categoryEl.value : '',
            search: (searchEl && searchEl.value) || '',
            sort: (sortEl && sortEl.value) || 'created_desc'
          });
          var resp = await fetch('/api/image/gallery/list?' + params.toString());
      // äº¤äº’ç›¸å…³å…œåº•å‡½æ•°ï¼šæ‰¹é‡æ¨¡å¼/é€‰æ‹©/ä¸‹è½½/åˆ é™¤/æç¤º
      if (!('batchMode' in window)) window.batchMode = false;
      if (!('selectedImages' in window) || !(window.selectedImages instanceof Set)) window.selectedImages = new Set();
      window.showError = window.showError || function(msg){ try{ alert(msg); }catch(e){ console.error(msg); } };
      window.showSuccess = window.showSuccess || function(msg){ try{ console.log(msg); }catch(e){} };

      window.updateSelectedCount = window.updateSelectedCount || function(){
        var el = document.getElementById('selected-count');
        if (el) el.textContent = window.selectedImages.size;
      };

      window.toggleImageSelection = window.toggleImageSelection || function(imageId){
        try{
          if (!imageId) return;
          if (window.selectedImages.has(imageId)) window.selectedImages.delete(imageId); else window.selectedImages.add(imageId);
          var card = document.querySelector('[data-image-id="'+imageId+'"]');
          if (card) card.classList.toggle('selected');
          window.updateSelectedCount();
        }catch(e){ console.error('toggleImageSelection error', e); }
      };

      window.toggleBatchMode = window.toggleBatchMode || function(){
        try{
          window.batchMode = !window.batchMode;
          var btn = document.getElementById('batch-mode-btn');
          var toolbar = document.getElementById('batch-toolbar');
          if (btn){
            if (window.batchMode){ btn.textContent = 'âŒ é€€å‡ºæ‰¹é‡'; btn.className = 'btn btn-warning'; }
            else { btn.textContent = 'â˜‘ï¸ æ‰¹é‡é€‰æ‹©'; btn.className = 'btn btn-info'; }
          }
          if (toolbar) toolbar.style.display = window.batchMode ? 'block' : 'none';
          if (!window.batchMode) window.selectedImages.clear();
          if (typeof window.renderImageGrid === 'function') window.renderImageGrid();
          window.updateSelectedCount();
        }catch(e){ console.error('toggleBatchMode error', e); }
      };

      window.downloadSingleImage = window.downloadSingleImage || async function(imageId){
        try{
          var resp = await fetch('/api/image/download/'+imageId);
          if (!resp.ok) { window.showError('ä¸‹è½½å¤±è´¥'); return; }
          var blob = await resp.blob();
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href = url; a.download = 'image'; a.click();
          setTimeout(function(){ window.URL.revokeObjectURL(url); }, 1000);
        }catch(e){ console.error('download error', e); window.showError('ä¸‹è½½å¤±è´¥'); }
      };

      window.deleteSingleImage = window.deleteSingleImage || async function(imageId){
        try{
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
          var resp = await fetch('/api/image/delete/'+imageId, { method: 'DELETE' });
          var data = {}; try{ data = await resp.json(); }catch(_){ }
          if (resp.ok && data && data.success){ window.showSuccess('å›¾ç‰‡åˆ é™¤æˆåŠŸ'); if (typeof window.refreshGallery==='function') window.refreshGallery(); }
          else { window.showError('åˆ é™¤å¤±è´¥' + (data && data.message ? (': '+data.message) : '')); }
        }catch(e){ console.error('delete error', e); window.showError('åˆ é™¤å¤±è´¥'); }
      };

      window.showImageDetail = window.showImageDetail || async function(imageId){
        try{
          // è®¾ç½®å½“å‰å›¾ç‰‡ ID
          window.currentImageDetail = { image_id: imageId };
          var origin = (window.location && window.location.origin) || '';
          var modal = document.getElementById('image-detail-modal');
          if (!modal){ window.open('/api/image/view/'+imageId, '_blank'); return; }
          // å…ˆæ˜¾ç¤ºé¢„è§ˆ
          var img = document.getElementById('detail-image');
          if (img) img.src = origin + '/api/image/view/' + imageId;
          // æ‹‰å–è¯¦æƒ…å¡«å……å³ä¾§ä¿¡æ¯ï¼ˆå¿½ç•¥å¤±è´¥ï¼‰
          try{
            var resp = await fetch('/api/image/detail/' + imageId);
            var data = await resp.json();
            if (data && data.success){
              window.currentImageDetail = data.image || { image_id: imageId };
              var t = document.getElementById('image-detail-title'); if (t) t.textContent = window.currentImageDetail.title || window.currentImageDetail.filename || imageId;
              var fn = document.getElementById('detail-filename'); if (fn) fn.textContent = window.currentImageDetail.filename || '-';
              var fs = document.getElementById('detail-size'); if (fs) fs.textContent = (window.currentImageDetail.file_size ? (Math.round(window.currentImageDetail.file_size/1024)+' KB') : '-');
              var dm = document.getElementById('detail-dimensions'); if (dm) dm.textContent = (window.currentImageDetail.width && window.currentImageDetail.height ? (window.currentImageDetail.width+' x '+window.currentImageDetail.height) : '-');
              var fmt = document.getElementById('detail-format'); if (fmt) fmt.textContent = window.currentImageDetail.format || '-';
              var src = document.getElementById('detail-source'); if (src) src.textContent = window.currentImageDetail.source_type || '-';
            }
          }catch(e){ console.warn('load detail failed', e); }
          modal.style.display = 'flex';
        }catch(e){ window.open('/api/image/view/'+imageId, '_blank'); }
      };

      // æ‰¹é‡å·¥å…·å‡½æ•°å…œåº•ï¼šå…¨é€‰/æ¸…é™¤/æ‰¹é‡åˆ é™¤/æ‰¹é‡ä¸‹è½½/æ¸…ç©ºå›¾åºŠ
      window.selectAll = window.selectAll || function(){
        try{
          var ids=(window.filteredImages||[]).map(function(it){ return it.image_id||it.id; });
          window.selectedImages = new Set(ids);
          if (typeof window.renderImageGrid==='function') window.renderImageGrid();
          window.updateSelectedCount();
        }catch(e){ console.error('selectAll error', e); }
      };

      window.clearSelection = window.clearSelection || function(){
        try{
          if (window.selectedImages) window.selectedImages.clear();
          if (typeof window.renderImageGrid==='function') window.renderImageGrid();
          window.updateSelectedCount();
        }catch(e){ console.error('clearSelection error', e); }
      };

      window.batchDelete = window.batchDelete || async function(){
        try{
          var ids = Array.from(window.selectedImages||[]);
          if (!ids.length){ window.showError('è¯·å…ˆé€‰æ‹©å›¾ç‰‡'); return; }
          if (!confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ '+ids.length+' å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
          var resp = await fetch('/api/image/gallery/batch-delete', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ image_ids: ids }) });
          var data = {}; try{ data = await resp.json(); }catch(_){ }
          if (resp.ok && data && data.success){ window.showSuccess('æˆåŠŸåˆ é™¤ '+(data.deleted_count||ids.length)+' å¼ å›¾ç‰‡'); if (typeof window.refreshGallery==='function') window.refreshGallery(); window.selectedImages.clear(); window.updateSelectedCount(); }
          else { window.showError('æ‰¹é‡åˆ é™¤å¤±è´¥' + (data && data.message ? (': '+data.message) : '')); }
        }catch(e){ console.error('batchDelete error', e); window.showError('æ‰¹é‡åˆ é™¤å¤±è´¥'); }
      };

      window.batchDownload = window.batchDownload || async function(){
        try{
          var ids = Array.from(window.selectedImages||[]);
          if (!ids.length){ window.showError('è¯·å…ˆé€‰æ‹©å›¾ç‰‡'); return; }
          var resp = await fetch('/api/image/gallery/batch-download', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ image_ids: ids }) });
          if (!resp.ok) { window.showError('æ‰¹é‡ä¸‹è½½è¯·æ±‚å¤±è´¥'); return; }
          var blob = await resp.blob();
          var url = window.URL.createObjectURL(blob);
          var a=document.createElement('a'); a.href=url; a.download='images.zip'; a.click();
          setTimeout(function(){ window.URL.revokeObjectURL(url); }, 1500);
        }catch(e){ console.error('batchDownload error', e); window.showError('æ‰¹é‡ä¸‹è½½å¤±è´¥'); }
      };

      window.clearAllImages = window.clearAllImages || async function(){
        try{
          if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
          var resp = await fetch('/api/image/gallery/clear-all', { method:'POST' });
          var data = {}; try{ data = await resp.json(); }catch(_){ }
          if (resp.ok && data && data.success){ window.showSuccess('å·²æ¸…ç©º ' + (data.deleted_count||0) + ' å¼ å›¾ç‰‡'); if (typeof window.refreshGallery==='function') window.refreshGallery(); window.selectedImages.clear(); window.updateSelectedCount(); }
          else { window.showError('æ¸…ç©ºå¤±è´¥' + (data && data.message ? (': '+data.message) : '')); }
        }catch(e){ console.error('clearAllImages error', e); window.showError('æ¸…ç©ºå›¾åºŠå¤±è´¥'); }
      };

      // è¯¦æƒ…å¼¹çª—ç›¸å…³å…œåº•
      window.closeImageDetailModal = window.closeImageDetailModal || function(){
        try{ var modal=document.getElementById('image-detail-modal'); if (modal) modal.style.display='none'; }catch(e){ console.error('closeImageDetailModal error', e); }
      };
      window.downloadImage = window.downloadImage || async function(){ try{ if (window.currentImageDetail) await window.downloadSingleImage(window.currentImageDetail.image_id || window.currentImageDetail.id); }catch(e){ console.error('downloadImage error', e); } };
      window.copyImageUrl = window.copyImageUrl || async function(){
        try{
          if (!window.currentImageDetail) return;
          var url=(window.location.origin||'')+'/api/image/view/'+(window.currentImageDetail.image_id||window.currentImageDetail.id);
          try{ await navigator.clipboard.writeText(url); window.showSuccess('é“¾æ¥å·²å¤åˆ¶'); }
          catch(_){ var ta=document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); window.showSuccess('é“¾æ¥å·²å¤åˆ¶'); }
        }catch(e){ console.error('copyImageUrl error', e); }
      };
      window.deleteImage = window.deleteImage || async function(){ try{ if (window.currentImageDetail) { await window.deleteSingleImage(window.currentImageDetail.image_id||window.currentImageDetail.id); window.closeImageDetailModal(); } }catch(e){ console.error('deleteImage error', e); } };
      window.toggleEditMode = window.toggleEditMode || function(){ try{ var display=document.getElementById('info-display-mode'); var edit=document.getElementById('info-edit-mode'); if (!display||!edit) return; if (edit.style.display==='none'||!edit.style.display){ edit.style.display='block'; display.style.display='none'; } else { edit.style.display='none'; display.style.display='block'; } }catch(e){ console.error('toggleEditMode error', e); } };


      // å·¥å…·æ å…œåº•ï¼šåˆ†ç±»/æœç´¢/æ’åº/åˆ·æ–°
      (function(){
        try{
          // ç®€å•é˜²æŠ–
          var _debTimer=null; function _debounce(fn){ clearTimeout(_debTimer); _debTimer=setTimeout(fn, 250); }
          window.filterImages = window.filterImages || function(){ try{ window.loadImages(1); }catch(e){ console.error('filterImages error', e); } };
          window.sortImages = window.sortImages || function(){ try{ window.loadImages(1); }catch(e){ console.error('sortImages error', e); } };
          window.searchImages = window.searchImages || function(ev){ try{ var ok = !ev || ev.key==='Enter' || ev.type==='change' || ev.type==='input'; if (ok) _debounce(function(){ window.loadImages(1); }); }catch(e){ console.error('searchImages error', e); } };
          // ä¸»åŠ¨ç»‘å®šä¸€æ¬¡äº‹ä»¶ï¼Œé˜²æ­¢å†…è”å¤±è´¥
          document.addEventListener('DOMContentLoaded', function(){
            try{
              var cat=document.getElementById('category-filter'); if (cat) cat.addEventListener('change', function(){ window.filterImages(); });
              var s=document.getElementById('search-input'); if (s){ s.addEventListener('keyup', function(e){ window.searchImages(e); }); s.addEventListener('change', function(e){ window.searchImages(e); }); s.addEventListener('input', function(e){ window.searchImages(e); }); }
              var sort=document.getElementById('sort-option'); if (sort) sort.addEventListener('change', function(){ window.sortImages(); });
            }catch(e){ console.error('bind toolbar events error', e); }
          });
        }catch(e){ console.error('toolbar fallback init error', e); }
      })();


      // ç¼–è¾‘ä¿¡æ¯å…œåº•ï¼šä¿å­˜/å–æ¶ˆ
      window.saveImageInfo = window.saveImageInfo || async function(){
        try{
          if (!window.currentImageDetail) { window.showError('æœªé€‰æ‹©å›¾ç‰‡'); return; }
          var id = window.currentImageDetail.image_id || window.currentImageDetail.id;
          var title = (document.getElementById('edit-title')?.value || '').trim();
          var description = (document.getElementById('edit-description')?.value || '').trim();
          var tags = (document.getElementById('edit-tags')?.value || '').trim();
          var category = document.getElementById('edit-category')?.value || '';
          var body = { };
          if (title !== '') body.title = title; else body.title = null;
          if (description !== '') body.description = description; else body.description = null;
          if (tags !== '') body.tags = tags; else body.tags = null;
          if (category !== '') body.category = category; else body.category = null;
          var resp = await fetch('/api/image/'+id+'/update', { method:'PUT', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
          var data = {}; try{ data = await resp.json(); }catch(_){ }
          if (resp.ok && data && data.success){ window.showSuccess('å›¾ç‰‡ä¿¡æ¯å·²æ›´æ–°'); window.toggleEditMode && window.toggleEditMode(); if (typeof window.refreshGallery==='function') window.refreshGallery(); }
          else { window.showError('æ›´æ–°å¤±è´¥' + (data && data.message ? (': '+data.message) : '')); }
        }catch(e){ console.error('saveImageInfo error', e); window.showError('æ›´æ–°å¤±è´¥'); }
      };

      window.cancelEdit = window.cancelEdit || function(){ try{ window.toggleEditMode && window.toggleEditMode(); }catch(e){ console.error('cancelEdit error', e); } };

          var data = await resp.json();
          if (data && data.success){
            window.currentImages = data.images || [];
            window.filteredImages = window.currentImages;
            window.renderImageGrid();
          } else {
            console.error('loadImages failed', data);
          }
        }catch(e){ console.error('fallback loadImages error', e); }
      };

      // é¡µé¢åŠ è½½åè‡ªåŠ¨æ‹‰å–
      document.addEventListener('DOMContentLoaded', function(){
        try { window.loadImages(1); } catch(e){ console.error(e); }
      });
    }
  } catch(e){ console.error('gallery fallback init error', e); }
})();
</script>




<!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
<div id="batch-toolbar" class="batch-toolbar" style="display: none; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px;">
        <div>
            <span id="selected-count">0</span> å¼ å›¾ç‰‡å·²é€‰æ‹©
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="selectAll()" class="btn btn-info">å…¨é€‰</button>
            <button onclick="clearSelection()" class="btn btn-warning">æ¸…é™¤é€‰æ‹©</button>
            <button onclick="batchDelete()" class="btn btn-danger">åˆ é™¤é€‰ä¸­</button>
            <button onclick="batchDownload()" class="btn btn-success">ä¸‹è½½é€‰ä¸­</button>
            <button onclick="clearAllImages()" class="btn btn-danger" style="margin-left: 20px; border: 2px solid #dc3545;">ğŸ—‘ï¸ æ¸…ç©ºå›¾åºŠ</button>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡ç½‘æ ¼ -->
<div id="image-grid" class="image-grid">
    <div class="loading-placeholder" style="text-align: center; padding: 60px; color: var(--text-secondary);">
        <div style="font-size: 3em; margin-bottom: 20px;">â³</div>
        <p>æ­£åœ¨åŠ è½½å›¾ç‰‡åº“...</p>
    </div>
</div>

<!-- åˆ†é¡µæ§ä»¶ -->
<div id="pagination" class="pagination" style="display: none; margin-top: 30px; text-align: center;">
    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
</div>

<!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
<div id="upload-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“¤ ä¸Šä¼ å›¾ç‰‡</h3>
            <button type="button" onclick="closeUploadModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-area" id="upload-area"
                 ondrop="handleDrop(event)"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
                <div class="upload-content">
                    <div style="font-size: 3em; margin-bottom: 15px; color: var(--primary-color);">ğŸ“</div>
                    <p style="margin-bottom: 15px;">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <input type="file" id="file-input" multiple accept="image/*" onchange="handleFileSelect(event)" style="display: none;">
                    <button type="button" onclick="document.getElementById('file-input').click()" class="btn btn-primary">é€‰æ‹©æ–‡ä»¶</button>
                </div>
            </div>

            <!-- å›¾ç‰‡ä¿¡æ¯è¾“å…¥åŒºåŸŸ -->
            <div id="image-info-section" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid var(--panel-border); border-radius: 8px; background: var(--panel-bg);">
                <h4 style="margin-bottom: 15px; color: var(--text-primary);">ğŸ“ å›¾ç‰‡ä¿¡æ¯</h4>

                <div style="margin-bottom: 15px;">
                    <label for="image-title" style="display: block; margin-bottom: 5px; font-weight: bold;">æ ‡é¢˜ï¼š</label>
              <input type="text" id="image-title" placeholder="è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰"
                  style="width: 100%; padding: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-primary); border-radius: 4px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="image-description" style="display: block; margin-bottom: 5px; font-weight: bold;">æè¿°ï¼š</label>
                    <textarea id="image-description" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°ï¼Œæœ‰åŠ©äºAIæœç´¢åŒ¹é…ï¼ˆæ¨èå¡«å†™ï¼‰"
                              rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-primary); border-radius: 4px; resize: vertical;"></textarea>
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="image-tags" style="display: block; margin-bottom: 5px; font-weight: bold;">æ ‡ç­¾ï¼š</label>
              <input type="text" id="image-tags" placeholder="è¯·è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆå¦‚ï¼šå•†åŠ¡,å›¾è¡¨,æ•°æ®åˆ†æï¼‰"
                  style="width: 100%; padding: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-primary); border-radius: 4px;">
              <small style="color: var(--text-muted); font-size: 0.9em;">æ ‡ç­¾æœ‰åŠ©äºAIæ™ºèƒ½åŒ¹é…ï¼Œå»ºè®®æ·»åŠ ç›¸å…³å…³é”®è¯</small>
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="image-category" style="display: block; margin-bottom: 5px; font-weight: bold;">åˆ†ç±»ï¼š</label>
                    <select id="image-category" style="width: 100%; padding: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); color: var(--text-primary); border-radius: 4px;">
                        <option value="business">å•†åŠ¡</option>
                        <option value="technology">æŠ€æœ¯</option>
                        <option value="education">æ•™è‚²</option>
                        <option value="design">è®¾è®¡</option>
                        <option value="nature">è‡ªç„¶</option>
                        <option value="people">äººç‰©</option>
                        <option value="abstract">æŠ½è±¡</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>

                <div style="text-align: right;">
                    <button type="button" onclick="startUpload()" class="btn btn-success" id="start-upload-btn">
                        ğŸš€ å¼€å§‹ä¸Šä¼ 
                    </button>
                </div>
            </div>

            <div id="upload-progress" style="display: none; margin-top: 20px;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="upload-status">å‡†å¤‡ä¸Šä¼ ...</p>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="image-detail-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h3 id="image-detail-title">å›¾ç‰‡è¯¦æƒ…</h3>
            <button onclick="closeImageDetailModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div style="display: grid; grid-template-columns: 1.4fr 420px; gap: 20px;">
                <div class="image-preview">
                    <img id="detail-image" style="width: 100%; height: auto; border-radius: 8px;">
                </div>
                <div class="image-info">
                    <!-- å¯ç¼–è¾‘çš„å›¾ç‰‡ä¿¡æ¯ -->
                    <div class="info-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>å›¾ç‰‡ä¿¡æ¯</h4>
                            <button id="edit-toggle-btn" onclick="toggleEditMode()" class="btn btn-sm btn-outline">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </button>
                        </div>

                        <!-- æ˜¾ç¤ºæ¨¡å¼ -->
                        <div id="info-display-mode">
                            <div class="info-item">
                                <label>æ ‡é¢˜:</label>
                                <span id="display-title">-</span>
                            </div>
                            <div class="info-item">
                                <label>æè¿°:</label>
                                <span id="display-description">-</span>
                            </div>
                            <div class="info-item">
                                <label>æ ‡ç­¾:</label>
                                <span id="display-tags">-</span>
                            </div>
                            <div class="info-item">
                                <label>åˆ†ç±»:</label>
                                <span id="display-category">-</span>
                            </div>
                        </div>

                        <!-- ç¼–è¾‘æ¨¡å¼ -->
                        <div id="info-edit-mode" style="display: none;">
                            <div class="edit-item">
                                <label for="edit-title">æ ‡é¢˜:</label>
                                <input type="text" id="edit-title" class="form-input" placeholder="è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜">
                            </div>
                            <div class="edit-item">
                                <label for="edit-description">æè¿°:</label>
                                <textarea id="edit-description" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°"></textarea>
                            </div>
                            <div class="edit-item">
                                <label for="edit-tags">æ ‡ç­¾:</label>
                                <input type="text" id="edit-tags" class="form-input" placeholder="ç”¨é€—å·åˆ†éš”å¤šä¸ªæ ‡ç­¾">
                                <small class="form-help">ä¾‹å¦‚: é£æ™¯, è‡ªç„¶, å±±æ°´</small>
                            </div>
                            <div class="edit-item">
                                <label for="edit-category">åˆ†ç±»:</label>
                                <select id="edit-category" class="form-select">
                                    <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                                    <option value="ai_generated">AIç”Ÿæˆ</option>
                                    <option value="web_search">ç½‘ç»œæœç´¢</option>
                                    <option value="local_storage">æœ¬åœ°ä¸Šä¼ </option>
                                </select>
                            </div>
                            <div class="edit-actions">
                                <button onclick="saveImageInfo()" class="btn btn-success btn-sm">
                                    <i class="fas fa-save"></i> ä¿å­˜
                                </button>
                                <button onclick="cancelEdit()" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-times"></i> å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h4>æ–‡ä»¶ä¿¡æ¯</h4>
                        <div class="info-item">
                            <label>æ–‡ä»¶å:</label>
                            <span id="detail-filename">-</span>
                        </div>
                        <div class="info-item">
                            <label>å¤§å°:</label>
                            <span id="detail-size">-</span>
                        </div>
                        <div class="info-item">
                            <label>å°ºå¯¸:</label>
                            <span id="detail-dimensions">-</span>
                        </div>
                        <div class="info-item">
                            <label>æ ¼å¼:</label>
                            <span id="detail-format">-</span>
                        </div>
                        <div class="info-item">
                            <label>æ¥æº:</label>
                            <span id="detail-source">-</span>
                        </div>
                        <div class="info-item">
                            <label>åˆ›å»ºæ—¶é—´:</label>
                            <span id="detail-created">-</span>
                        </div>
                        <div class="info-item">
                            <label>è®¿é—®æ¬¡æ•°:</label>
                            <span id="detail-access-count">-</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h4>æ“ä½œ</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="downloadImage()" class="btn btn-primary">ä¸‹è½½å›¾ç‰‡</button>
                            <button onclick="copyImageUrl()" class="btn btn-info">å¤åˆ¶é“¾æ¥</button>
                            <button onclick="deleteImage()" class="btn btn-danger">åˆ é™¤å›¾ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€å˜é‡
let currentImages = [];
let filteredImages = [];
let currentPage = 1;
let itemsPerPage = 20;
let batchMode = false;
let selectedImages = new Set();
let currentImageDetail = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadImages();
});

// åŠ è½½å›¾ç‰‡åˆ—è¡¨
async function loadImages(page = 1) {
    try {
        const category = document.getElementById('category-filter').value;
        const search = document.getElementById('search-input').value;
        const sort = document.getElementById('sort-option').value;

        const params = new URLSearchParams({
            page: page,
            per_page: itemsPerPage,
            category: category === 'all' ? '' : category,
            search: search,
            sort: sort
        });

        const response = await fetch(`/api/image/gallery/list?${params}`);
        const data = await response.json();

        if (data.success) {
            currentImages = data.images;
            filteredImages = currentImages;
            currentPage = page;

            renderImageGrid();
            renderPagination(data.pagination);
        } else {
            showError('åŠ è½½å›¾ç‰‡å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('Failed to load images:', error);
        showError('åŠ è½½å›¾ç‰‡å¤±è´¥');
    }
}

// æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
function renderImageGrid() {
    const grid = document.getElementById('image-grid');

    if (filteredImages.length === 0) {
        grid.innerHTML = `
            <div class="loading-placeholder" style="text-align: center; padding: 60px; color: var(--text-secondary); grid-column: 1 / -1;">
                <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“·</div>
                <p>æš‚æ— å›¾ç‰‡</p>
            </div>
        `;
        return;
    }

    grid.innerHTML = filteredImages.map(image => `
        <div class="image-item ${selectedImages.has(image.image_id) ? 'selected' : ''}" data-image-id="${image.image_id}">
            ${batchMode ? `<input type="checkbox" class="batch-checkbox" ${selectedImages.has(image.image_id) ? 'checked' : ''} onchange="toggleImageSelection('${image.image_id}')">` : ''}
            <img src="${window.location.origin}/api/image/thumbnail/${image.image_id}"
                 alt="${image.title || image.filename}"
                 class="image-thumbnail"
                 onclick="showImageDetail('${image.image_id}')"
                 onerror="this.src='/static/images/placeholder.svg'">
            <div class="image-info">
                <div class="image-title">${image.title || image.filename}</div>
                <div class="image-meta">
                    <span class="image-source">${getSourceLabel(image.source_type)}</span>
                    <span>${formatFileSize(image.file_size)}</span>
                </div>
                <div class="image-actions">
                    <button onclick="downloadSingleImage('${image.image_id}')" class="btn btn-sm btn-primary">ä¸‹è½½</button>
                    <button onclick="deleteSingleImage('${image.image_id}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                </div>
            </div>
        </div>
    `).join('');
}

// æ¸²æŸ“åˆ†é¡µæ§ä»¶
function renderPagination(pagination) {
    const paginationDiv = document.getElementById('pagination');

    if (pagination.total_pages <= 1) {
        paginationDiv.style.display = 'none';
        return;
    }

    paginationDiv.style.display = 'flex';

    let paginationHTML = '';

    // ä¸Šä¸€é¡µæŒ‰é’®
    paginationHTML += `<button onclick="loadImages(${pagination.current_page - 1})" ${!pagination.has_prev ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;

    // é¡µç æŒ‰é’®
    const startPage = Math.max(1, pagination.current_page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);

    if (startPage > 1) {
        paginationHTML += `<button onclick="loadImages(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span>...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<button onclick="loadImages(${i})" ${i === pagination.current_page ? 'class="active"' : ''}>${i}</button>`;
    }

    if (endPage < pagination.total_pages) {
        if (endPage < pagination.total_pages - 1) {
            paginationHTML += `<span>...</span>`;
        }
        paginationHTML += `<button onclick="loadImages(${pagination.total_pages})">${pagination.total_pages}</button>`;
    }

    // ä¸‹ä¸€é¡µæŒ‰é’®
    paginationHTML += `<button onclick="loadImages(${pagination.current_page + 1})" ${!pagination.has_next ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;

    paginationDiv.innerHTML = paginationHTML;
}

// ç­›é€‰å›¾ç‰‡
function filterImages() {
    loadImages(1);
}

// æœç´¢å›¾ç‰‡
function searchImages(event) {
    if (event.key === 'Enter' || event.type === 'input') {
        loadImages(1);
    }
}

// æ’åºå›¾ç‰‡
function sortImages() {
    loadImages(1);
}

// åˆ·æ–°å›¾åº“
function refreshGallery() {
    loadImages(currentPage);
}

// è·å–æ¥æºæ ‡ç­¾
function getSourceLabel(sourceType) {
    const labels = {
        'ai_generated': 'AIç”Ÿæˆ',
        'web_search': 'ç½‘ç»œæœç´¢',
        'local_storage': 'æœ¬åœ°ä¸Šä¼ '
    };
    return labels[sourceType] || sourceType;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    // è¿™é‡Œå¯ä»¥é›†æˆç°æœ‰çš„é€šçŸ¥ç³»ç»Ÿ
    alert(message);
}

// æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
function showSuccess(message) {
    // è¿™é‡Œå¯ä»¥é›†æˆç°æœ‰çš„é€šçŸ¥ç³»ç»Ÿ
    alert(message);
}

// æ‰¹é‡é€‰æ‹©ç›¸å…³åŠŸèƒ½
function toggleBatchMode() {
    batchMode = !batchMode;
    const btn = document.getElementById('batch-mode-btn');
    const toolbar = document.getElementById('batch-toolbar');

    if (batchMode) {
        btn.textContent = 'âŒ é€€å‡ºæ‰¹é‡';
        btn.className = 'btn btn-warning';
        toolbar.style.display = 'block';
    } else {
        btn.textContent = 'â˜‘ï¸ æ‰¹é‡é€‰æ‹©';
        btn.className = 'btn btn-info';
        toolbar.style.display = 'none';
        selectedImages.clear();
    }

    renderImageGrid();
    updateSelectedCount();
}

function toggleImageSelection(imageId) {
    if (selectedImages.has(imageId)) {
        selectedImages.delete(imageId);
    } else {
        selectedImages.add(imageId);
    }

    renderImageGrid();
    updateSelectedCount();
}

function selectAll() {
    filteredImages.forEach(image => selectedImages.add(image.image_id));
    renderImageGrid();
    updateSelectedCount();
}

function clearSelection() {
    selectedImages.clear();
    renderImageGrid();
    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selected-count').textContent = selectedImages.size;
}

// æ‰¹é‡åˆ é™¤
async function batchDelete() {
    if (selectedImages.size === 0) {
        showError('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å›¾ç‰‡');
        return;
    }

    if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedImages.size} å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
        return;
    }

    try {
        const response = await fetch('/api/image/gallery/batch-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_ids: Array.from(selectedImages)
            })
        });

        const data = await response.json();

        if (data.success) {
            showSuccess(`æˆåŠŸåˆ é™¤ ${data.deleted_count} å¼ å›¾ç‰‡`);
            selectedImages.clear();
            refreshGallery();
        } else {
            showError('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('Batch delete failed:', error);
        showError('æ‰¹é‡åˆ é™¤å¤±è´¥');
    }
}

// æ‰¹é‡ä¸‹è½½
async function batchDownload() {
    if (selectedImages.size === 0) {
        showError('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å›¾ç‰‡');
        return;
    }

    try {
        const response = await fetch('/api/image/gallery/batch-download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_ids: Array.from(selectedImages)
            })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `images_${new Date().getTime()}.zip`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showSuccess(`æˆåŠŸä¸‹è½½ ${selectedImages.size} å¼ å›¾ç‰‡`);
        } else {
            showError('æ‰¹é‡ä¸‹è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('Batch download failed:', error);
        showError('æ‰¹é‡ä¸‹è½½å¤±è´¥');
    }
}

// æ¸…ç©ºå›¾åºŠ
async function clearAllImages() {
    // ç¬¬ä¸€æ¬¡ç¡®è®¤
    if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤å›¾åºŠä¸­çš„æ‰€æœ‰å›¾ç‰‡ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
    }

    // ç¬¬äºŒæ¬¡ç¡®è®¤
    if (!confirm('ğŸš¨ æœ€åç¡®è®¤ï¼šåˆ é™¤åæ— æ³•æ¢å¤ï¼\n\nè¯·å†æ¬¡ç¡®è®¤æ˜¯å¦è¦æ¸…ç©ºæ•´ä¸ªå›¾åºŠï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch('/api/image/gallery/clear-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            showSuccess(`æˆåŠŸæ¸…ç©ºå›¾åºŠï¼Œåˆ é™¤äº† ${data.deleted_count} å¼ å›¾ç‰‡`);

            // æ¸…é™¤é€‰æ‹©çŠ¶æ€
            selectedImages.clear();

            // é€€å‡ºæ‰¹é‡æ¨¡å¼
            if (batchMode) {
                toggleBatchMode();
            }

            // åˆ·æ–°å›¾åº“
            refreshGallery();
        } else {
            showError('æ¸…ç©ºå›¾åºŠå¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('Clear all images failed:', error);
        showError('æ¸…ç©ºå›¾åºŠå¤±è´¥');
    }
}

// å•å¼ å›¾ç‰‡æ“ä½œ
async function downloadSingleImage(imageId) {
    try {
        const response = await fetch(`/api/image/download/${imageId}`);

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // ä»å“åº”å¤´è·å–æ–‡ä»¶å
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'image';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            showError('ä¸‹è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('Download failed:', error);
        showError('ä¸‹è½½å¤±è´¥');
    }
}

async function deleteSingleImage(imageId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }

    try {
        const response = await fetch(`/api/image/delete/${imageId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showSuccess('å›¾ç‰‡åˆ é™¤æˆåŠŸ');
            refreshGallery();
        } else {
            showError('åˆ é™¤å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('Delete failed:', error);
        showError('åˆ é™¤å¤±è´¥');
    }
}

// ä¸Šä¼ ç›¸å…³åŠŸèƒ½
function showUploadModal() {
    // ä¸CSSä¸­ .modal çš„ display:flex ä¸€è‡´ï¼Œé¿å…æŸäº›æµè§ˆå™¨ä¸æ¸²æŸ“
    document.getElementById('upload-modal').style.display = 'flex';
}

function closeUploadModal() {
    document.getElementById('upload-modal').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'none';
    document.getElementById('image-info-section').style.display = 'none';
    document.getElementById('progress-fill').style.width = '0%';
    document.getElementById('file-input').value = '';

    // é‡ç½®è¾“å…¥å­—æ®µ
    document.getElementById('image-title').value = '';
    document.getElementById('image-description').value = '';
    document.getElementById('image-tags').value = '';
    document.getElementById('image-category').value = 'business';

    // æ¸…ç©ºé€‰ä¸­çš„æ–‡ä»¶
    selectedFiles = [];
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function handleDragLeave(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');

    const files = event.dataTransfer.files;
    handleFiles(files);
}

function handleFileSelect(event) {
    const files = event.target.files;
    handleFiles(files);
}

let selectedFiles = [];

function handleFiles(files) {
    if (files.length === 0) return;

    // éªŒè¯æ–‡ä»¶ç±»å‹
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
    const validFiles = Array.from(files).filter(file => validTypes.includes(file.type));

    if (validFiles.length === 0) {
        showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (JPG, PNG, WebP, GIF)');
        return;
    }

    if (validFiles.length !== files.length) {
        showError(`å·²è¿‡æ»¤æ‰ ${files.length - validFiles.length} ä¸ªæ— æ•ˆæ–‡ä»¶`);
    }

    selectedFiles = validFiles;

    // æ˜¾ç¤ºå›¾ç‰‡ä¿¡æ¯è¾“å…¥åŒºåŸŸ
    document.getElementById('image-info-section').style.display = 'block';

    // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨å¡«å…¥æ–‡ä»¶åä½œä¸ºæ ‡é¢˜
    if (validFiles.length === 1) {
        document.getElementById('image-title').value = validFiles[0].name.split('.')[0];
    } else {
        document.getElementById('image-title').placeholder = `æ‰¹é‡ä¸Šä¼  ${validFiles.length} ä¸ªæ–‡ä»¶`;
    }
}

async function startUpload() {
    if (selectedFiles.length === 0) {
        showError('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
    }

    // è·å–ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯
    const title = document.getElementById('image-title').value.trim();
    const description = document.getElementById('image-description').value.trim();
    const tags = document.getElementById('image-tags').value.trim();
    const category = document.getElementById('image-category').value;

    // éšè—ä¿¡æ¯è¾“å…¥åŒºåŸŸï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
    document.getElementById('image-info-section').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'block';

    let uploadedCount = 0;
    const totalFiles = selectedFiles.length;

    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];

        try {
            document.getElementById('upload-status').textContent = `æ­£åœ¨ä¸Šä¼  ${file.name} (${i + 1}/${totalFiles})`;

            const formData = new FormData();
            formData.append('file', file);

            // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
            const fileTitle = title || file.name.split('.')[0];
            formData.append('title', fileTitle);
            formData.append('description', description);
            formData.append('tags', tags);
            formData.append('category', category);

            const response = await fetch('/api/image/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                uploadedCount++;
            } else {
                console.error(`Upload failed for ${file.name}:`, data.message);
            }

            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((i + 1) / totalFiles) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;

        } catch (error) {
            console.error(`Upload error for ${file.name}:`, error);
        }
    }

    // ä¸Šä¼ å®Œæˆ
    document.getElementById('upload-status').textContent = `ä¸Šä¼ å®Œæˆï¼æˆåŠŸä¸Šä¼  ${uploadedCount}/${totalFiles} ä¸ªæ–‡ä»¶`;

    if (uploadedCount > 0) {
        setTimeout(() => {
            closeUploadModal();
            refreshGallery();
            showSuccess(`æˆåŠŸä¸Šä¼  ${uploadedCount} å¼ å›¾ç‰‡`);
        }, 2000);
    }
}

// å›¾ç‰‡è¯¦æƒ…ç›¸å…³åŠŸèƒ½
async function showImageDetail(imageId) {
    try {
        const response = await fetch(`/api/image/detail/${imageId}`);
        const data = await response.json();

        if (data.success) {
            currentImageDetail = data.image;
            console.log('å½“å‰å›¾ç‰‡è¯¦æƒ…:', currentImageDetail);

            // å¡«å……è¯¦æƒ…ä¿¡æ¯
            document.getElementById('image-detail-title').textContent = data.image.title || data.image.filename;
            document.getElementById('detail-image').src = `${window.location.origin}/api/image/view/${imageId}`;

            // å¡«å……å¯ç¼–è¾‘çš„å›¾ç‰‡ä¿¡æ¯
            document.getElementById('display-title').textContent = data.image.title || 'æœªè®¾ç½®';
            document.getElementById('display-description').textContent = data.image.description || 'æœªè®¾ç½®';
            document.getElementById('display-tags').textContent = data.image.tags || 'æœªè®¾ç½®';
            document.getElementById('display-category').textContent = getCategoryLabel(data.image.category) || 'æœªè®¾ç½®';

            // å¡«å……æ–‡ä»¶ä¿¡æ¯
            document.getElementById('detail-filename').textContent = data.image.filename;
            document.getElementById('detail-size').textContent = formatFileSize(data.image.file_size);
            document.getElementById('detail-dimensions').textContent = `${data.image.width} Ã— ${data.image.height}`;
            document.getElementById('detail-format').textContent = data.image.format.toUpperCase();
            document.getElementById('detail-source').textContent = getSourceLabel(data.image.source_type);
            document.getElementById('detail-created').textContent = new Date(data.image.created_at * 1000).toLocaleString();
            document.getElementById('detail-access-count').textContent = data.image.access_count || 0;

            // é‡ç½®ç¼–è¾‘æ¨¡å¼
            exitEditMode();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('image-detail-modal').style.display = 'flex';
        }
    } catch (error) {
        console.error('showImageDetail failed:', error);
        try { window.open(`/api/image/view/${imageId}`, '_blank'); } catch(e) {}
    }
}


async function downloadImage() {
    try {
        if (document.getElementById('image-detail-modal').style.display !== 'none' && currentImageDetail) {
            await downloadSingleImage(currentImageDetail.image_id);
        }
    } catch (e) { console.error('downloadImage error', e); }
}

async function copyImageUrl() {
    if (!currentImageDetail) return;
    const url = `${window.location.origin}/api/image/view/${currentImageDetail.image_id}`;
    try {
        await navigator.clipboard.writeText(url);
        showSuccess('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
        // é™çº§æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccess('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }
}

async function deleteImage() {
    if (!currentImageDetail) return;
    await deleteSingleImage(currentImageDetail.image_id);
    closeImageDetailModal();
}

// å›¾ç‰‡ä¿¡æ¯ç¼–è¾‘åŠŸèƒ½
function toggleEditMode() {
    const displayMode = document.getElementById('info-display-mode');
    const editMode = document.getElementById('info-edit-mode');
    const toggleBtn = document.getElementById('edit-toggle-btn');

    if (editMode.style.display === 'none') {
        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        enterEditMode();
    } else {
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        exitEditMode();
    }
}

function enterEditMode() {
    if (!currentImageDetail) return;

    const displayMode = document.getElementById('info-display-mode');
    const editMode = document.getElementById('info-edit-mode');
    const toggleBtn = document.getElementById('edit-toggle-btn');

    // å¡«å……ç¼–è¾‘è¡¨å•
    document.getElementById('edit-title').value = currentImageDetail.title || '';
    document.getElementById('edit-description').value = currentImageDetail.description || '';
    document.getElementById('edit-tags').value = currentImageDetail.tags || '';
    document.getElementById('edit-category').value = currentImageDetail.category || '';

    // åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼
    displayMode.style.display = 'none';
    editMode.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fas fa-eye"></i> æŸ¥çœ‹';
}

function exitEditMode() {
    const displayMode = document.getElementById('info-display-mode');
    const editMode = document.getElementById('info-edit-mode');
    const toggleBtn = document.getElementById('edit-toggle-btn');

    displayMode.style.display = 'block';
    editMode.style.display = 'none';
    toggleBtn.innerHTML = '<i class="fas fa-edit"></i> ç¼–è¾‘';
}

function cancelEdit() {
    exitEditMode();
}

async function saveImageInfo() {
    if (!currentImageDetail) return;

    const title = document.getElementById('edit-title').value.trim();
    const description = document.getElementById('edit-description').value.trim();
    const tags = document.getElementById('edit-tags').value.trim();
    const category = document.getElementById('edit-category').value;

    try {
        const response = await fetch(`/api/image/${currentImageDetail.image_id}/update`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                description: description,
                tags: tags,
                category: category
            })
        });

        console.log('APIå“åº”çŠ¶æ€:', response.status);

        if (!response.ok) {
            let errorMessage = `HTTP ${response.status}`;
            try {
                const errorResult = await response.json();
                errorMessage += ': ' + (errorResult.detail || errorResult.message || 'æœªçŸ¥é”™è¯¯');
            } catch (e) {
                errorMessage += ': ' + response.statusText;
            }
            throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log('APIå“åº”æ•°æ®:', result);

        if (result.success) {
            // æ›´æ–°å½“å‰å›¾ç‰‡è¯¦æƒ…æ•°æ®
            currentImageDetail.title = title;
            currentImageDetail.description = description;
            currentImageDetail.tags = tags;
            currentImageDetail.category = category;

            // æ›´æ–°æ˜¾ç¤ºå†…å®¹
            document.getElementById('display-title').textContent = title || 'æœªè®¾ç½®';
            document.getElementById('display-description').textContent = description || 'æœªè®¾ç½®';
            document.getElementById('display-tags').textContent = tags || 'æœªè®¾ç½®';
            document.getElementById('display-category').textContent = getCategoryLabel(category) || 'æœªè®¾ç½®';
            document.getElementById('image-detail-title').textContent = title || currentImageDetail.filename;

            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            exitEditMode();

            // åˆ·æ–°å›¾ç‰‡åˆ—è¡¨ä»¥æ˜¾ç¤ºæ›´æ–°åçš„ä¿¡æ¯
            loadImages();

            showSuccess('å›¾ç‰‡ä¿¡æ¯å·²æ›´æ–°');
        } else {
            showError('æ›´æ–°å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('Failed to update image info:', error);
        if (error.message) {
            showError('æ›´æ–°å¤±è´¥: ' + error.message);
        } else {
            showError('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
}

// è·å–åˆ†ç±»æ ‡ç­¾
function getCategoryLabel(category) {
    const categoryLabels = {
        'ai_generated': 'AIç”Ÿæˆ',
        'web_search': 'ç½‘ç»œæœç´¢',
        'local_storage': 'æœ¬åœ°ä¸Šä¼ '
    };
    return categoryLabels[category] || category;
}

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(event) {
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    if (event.key === 'Escape') {
        if (document.getElementById('upload-modal').style.display === 'flex') {
            closeUploadModal();
        }
        if (document.getElementById('image-detail-modal').style.display === 'flex') {
            closeImageDetailModal();
        }
    }

    // Ctrl+A å…¨é€‰ï¼ˆåœ¨æ‰¹é‡æ¨¡å¼ä¸‹ï¼‰
    if (event.ctrlKey && event.key === 'a' && batchMode) {
        event.preventDefault();
        selectAll();
    }

    // Deleteé”®åˆ é™¤é€‰ä¸­é¡¹
    if (event.key === 'Delete' && batchMode && selectedImages.size > 0) {
        batchDelete();
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* å›¾ç‰‡ç½‘æ ¼æ ·å¼ */
  .toolbar input#search-input{ width: 420px !important; }
  .modal-content{ width: 95%; max-width: 1200px; }
  .image-grid{ grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }

.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.image-item {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
}

.image-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(31, 38, 135, 0.4);
}

.image-item.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
}

.image-thumbnail {
    width: 100%;
    height: 200px;
    object-fit: cover;
    cursor: pointer;
}

.image-info {
    padding: 15px;
}

.image-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--text-primary);
    font-size: 0.9em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.image-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8em;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.image-source {
    background: var(--primary-color);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7em;
}

.image-actions {
    display: flex;
    gap: 5px;
    justify-content: center;
}

.image-actions button {
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8em;
    transition: all 0.3s ease;
}

/* æ‰¹é‡é€‰æ‹©å¤é€‰æ¡† */
.batch-checkbox {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 20px;
    height: 20px;
    z-index: 10;
}

/* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
.upload-area {
    border: 2px dashed var(--glass-border);
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover,
.upload-area.drag-over {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
}

/* è¿›åº¦æ¡æ ·å¼ */
.progress-bar {
    width: 100%;
    height: 20px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background: var(--primary-gradient);
    width: 0%;
    transition: width 0.3s ease;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 15px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--glass-border);
}

.modal-body {
    padding: 20px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: var(--text-secondary);
}

.close-btn:hover {
    color: var(--text-primary);
}

/* ä¿¡æ¯é¡¹æ ·å¼ */
.info-section {
    margin-bottom: 20px;
}

.info-section h4 {
    margin-bottom: 10px;
    color: var(--primary-color);
}

.info-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px solid var(--glass-border);
}

.info-item label {
    font-weight: 600;
    color: var(--text-secondary);
}

/* ç¼–è¾‘è¡¨å•æ ·å¼ */
.edit-item {
    margin-bottom: 15px;
}

.edit-item label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--text-primary);
}

.form-input,
.form-textarea,
.form-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--glass-border);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background: var(--glass-bg);
    color: var(--text-primary);
}

.form-input:focus,
.form-textarea:focus,
.form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.15);
}

.form-textarea {
    resize: vertical;
    min-height: 60px;
}

.form-help {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: var(--text-muted);
}

.edit-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

.btn-success {
    background: #28a745;
    border-color: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
    border-color: #1e7e34;
}

.btn-secondary {
    background: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
    border-color: #545b62;
}

/* åˆ†é¡µæ ·å¼ */
.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
}

.pagination button {
    padding: 8px 12px;
    border: 1px solid var(--glass-border);
    background: var(--glass-bg);
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pagination button:hover {
    background: var(--primary-color);
    color: white;
}

.pagination button.active {
    background: var(--primary-color);
    color: white;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .image-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }

    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }

    .modal-content {
        width: 95%;
        margin: 10px;
    }
}
</style>
{% endblock %}


<script>
// å…œåº•ï¼šç¡®ä¿â€œä¸Šä¼ å›¾ç‰‡â€æŒ‰é’®å¯ç”¨ï¼Œå³ä½¿ä¸Šæ–¹è„šæœ¬æŸæ®µæŠ¥é”™å¯¼è‡´å‡½æ•°æœªæ³¨å†Œ
(function(){
  function ensureUploadModal(){
    var modal = document.getElementById('upload-modal');
    if (!window.showUploadModal) {
      window.showUploadModal = function(){
        if (modal) {
          modal.style.display = 'flex';
          try { console.log('[image-gallery] open upload modal'); } catch(e){}
        }
      }
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindOpenBtn);
  } else {
    bindOpenBtn();
  }
  function bindOpenBtn(){
    ensureUploadModal();
    var btn = document.getElementById('open-upload-modal-btn');
    if (btn) {
      btn.addEventListener('click', function(ev){
        try { ev.preventDefault(); } catch(e){}
        if (typeof window.showUploadModal === 'function') window.showUploadModal();
      });
    }
  }
})();
</script>

<!-- å¼€å‘ç¯å¢ƒè‡ªæµ‹è„šæœ¬ï¼šä»…åœ¨è®¿é—® /?devselftest=1 æ—¶è¿è¡Œï¼Œä¸å½±å“ç”Ÿäº§ -->
<script>
(function(){
  try{
    var params = new URLSearchParams(location.search||'');
    if (params.get('devselftest') !== '1') return;
    var logs = [];
    function log(msg){ logs.push(msg); try{ console.log('[SelfTest]', msg); }catch(e){} }

    // 1) å·¥å…·æ äº‹ä»¶ç»‘å®šä¸è§¦å‘
    function testToolbar(){
      try{
        var cat=document.getElementById('category-filter');
        var s=document.getElementById('search-input');
        var sort=document.getElementById('sort-option');
        if (!cat || !s || !sort) { log('toolbar elements missing'); return; }
        var called=0; var _orig=window.loadImages; window.loadImages=function(p){ called++; if (_orig) return _orig.call(this,p); };
        cat.dispatchEvent(new Event('change')); s.value='abc'; s.dispatchEvent(new Event('input')); sort.dispatchEvent(new Event('change'));
        setTimeout(function(){ log('toolbar triggers loadImages count='+called); window.loadImages=_orig; }, 300);
      }catch(e){ log('testToolbar error '+e); }
    }

    // 2) è¯¦æƒ…å¼¹çª—æ‰“å¼€æµç¨‹ï¼ˆä½¿ç”¨ä¸€å¼ å½“å‰ç½‘æ ¼ä¸­çš„å›¾ç‰‡ï¼‰
    async function testDetail(){
      try{
        var card=document.querySelector('.image-item');
        if (!card){ log('no image card to test'); return; }
        var id=card.getAttribute('data-image-id');
        await (window.showImageDetail && window.showImageDetail(id));
        setTimeout(function(){
          var opened = (document.getElementById('image-detail-modal')||{}).style?.display==='flex';
          log('detail modal opened='+opened+', currentImageDetail set='+(!!window.currentImageDetail));
        }, 300);
      }catch(e){ log('testDetail error '+e); }
    }

    // 3) æŒ‰é’®å‡½æ•°å­˜åœ¨æ€§
    function testButtons(){
      try{
        var ok = [window.downloadImage, window.copyImageUrl, window.deleteImage].every(function(f){ return typeof f==='function'; });
        log('detail buttons functions exist='+ok);
      }catch(e){ log('testButtons error '+e); }
    }

    // é¡ºåºæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function(){
      testToolbar();
      setTimeout(testDetail, 500);
      setTimeout(testButtons, 700);
      setTimeout(function(){ alert('[SelfTest] å®Œæˆï¼Œè¯¦è§æ§åˆ¶å°è¾“å‡º'); }, 1000);
    });
  }catch(e){ console.error('selftest error', e); }
})();
</script>

