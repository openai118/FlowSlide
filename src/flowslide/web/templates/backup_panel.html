<!-- Backup & Sync Panel - include this fragment where the red box should be -->
<div id="backup-panel" class="backup-panel">
    <div class="tabs">
        <button class="tab-btn active" data-type="db">Database Backups</button>
        <button class="tab-btn" data-type="artifact">Generated Artifacts</button>
        <button class="tab-btn" data-type="media">User Uploads</button>
        <button class="tab-btn" data-type="cache">Cache / Intermediates</button>
    </div>

    <div class="controls">
        <input id="backup-search" placeholder="Search name or id" />
        <button id="btn-create-backup">Create Backup</button>
        <button id="btn-sync-selected">Sync Selected to R2</button>
        <button id="btn-restore-selected">Restore Selected</button>
        <button id="btn-download-selected">Download</button>
        <button id="btn-delete-selected">Delete</button>
    </div>

    <table id="backup-table" class="table table-sm">
        <thead>
            <tr>
                <th><input type="checkbox" id="chk-all"/></th>
                <th>Name</th>
                <th>Type</th>
                <th>Project</th>
                <th>Size</th>
                <th>Created</th>
                <th>Storage</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
    (function(){
        const panel = document.getElementById('backup-panel');
        let currentType = 'db';

        function qs(sel, el=document) { return el.querySelector(sel); }
        function qsa(sel, el=document) { return Array.from(el.querySelectorAll(sel)); }

        qsa('.tab-btn').forEach(b=>b.addEventListener('click', (ev)=>{
            qsa('.tab-btn').forEach(x=>x.classList.remove('active'));
            ev.target.classList.add('active');
            currentType = ev.target.dataset.type;
            fetchList();
        }));

        qs('#btn-create-backup').addEventListener('click', async ()=>{
            const typeMap = {db:'db_only', artifact:'full', media:'media_only', cache:'scripts_only'};
            const mappedType = typeMap[currentType] || 'db_only';
            try {
                const resp = await fetch('/api/backup/local/create', {
                    method: 'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({backup_type: mappedType})
                });
                const j = await resp.json();
                if(!resp.ok || !j.success){ throw new Error(j.error||'create failed'); }
                alert('Backup created: '+ (j.path||mappedType));
                fetchList();
            } catch(e){ alert('Create failed: '+e.message); }
        });

        qs('#chk-all').addEventListener('change', (ev)=>{
            qsa('#backup-table tbody input.row-chk').forEach(c=>c.checked = ev.target.checked);
        });

        async function fetchList(){
            const tbody = qs('#backup-table tbody');
            tbody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';
            try {
                // 复用新的本地备份列表 & R2 列表融合展示（只展示本地 zip）
                const resp = await fetch('/api/backup/local/list');
                const list = await resp.json();
                tbody.innerHTML = '';
                for(const r of list){
                    const fname = r.name || r.filename || r.file || '';
                    const size = r.size || r.file_size || '';
                    const created = r.created || r.created_at || '';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input class="row-chk" data-name="${fname}" type="checkbox"/></td>
                        <td>${fname}</td>
                        <td>${(r.type||'local')}</td>
                        <td></td>
                        <td>${size||''}</td>
                        <td>${created?new Date(created).toLocaleString():''}</td>
                        <td>${r.category||''}</td>
                        <td><button data-name="${fname}" class="btn-download">Download</button>
                            <button data-name="${fname}" class="btn-restore">Restore</button>
                            <button data-name="${fname}" class="btn-delete">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                bindRowActions();
            } catch(e){
                tbody.innerHTML = `<tr><td colspan=8>Load failed: ${e.message}</td></tr>`;
            }
        }

        function bindRowActions(){
            qsa('.btn-download').forEach(b=>b.addEventListener('click', (ev)=>{
                const name = ev.target.dataset.name;
                window.location = `/api/backup/local/download?backup_name=${encodeURIComponent(name)}`;
            }));
            qsa('.btn-restore').forEach(b=>b.addEventListener('click', async (ev)=>{
                const name = ev.target.dataset.name;
                if(!confirm('Restore '+name+' ?')) return;
                const resp = await fetch(`/api/backup/local/restore?backup_name=${encodeURIComponent(name)}`, {method:'POST'});
                const j = await resp.json();
                alert(j.success?'Restore OK':'Restore failed: '+(j.error||j.detail||''));
            }));
            qsa('.btn-delete').forEach(b=>b.addEventListener('click', async (ev)=>{
                const name = ev.target.dataset.name;
                if(!confirm('Delete '+name+' ?')) return;
                const resp = await fetch(`/api/backup/local?backup_name=${encodeURIComponent(name)}`, {method:'DELETE'});
                if(resp.ok){ fetchList(); } else { alert('Delete failed'); }
            }));
        }

        // initial load
        fetchList();
    })();
    </script>

</div>
