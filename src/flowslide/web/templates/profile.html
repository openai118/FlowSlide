{% extends "base.html" %}

{% block title %}ç”¨æˆ·èµ„æ–™ - FlowSlide{% endblock %}

{% block extra_css %}
<style>
    .profile-muted { color: var(--text-secondary); }
    /* Use the same surface tokens as .card for visual unity */
    .profile-panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; padding: 20px; }
    .accent-blue { color: var(--accent-blue); }
    .accent-red { color: var(--accent-red); }
    .accent-green { color: var(--accent-green); }
    .accent-yellow { color: var(--accent-yellow); }
    .badge-chip { color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; display: inline-block; }
    .chip-blue { background: var(--accent-blue); }
    .chip-red { background: var(--accent-red); }
</style>
{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 40px;">
        <h2 style="margin-bottom: 20px;">ğŸ‘¤ ç”¨æˆ·èµ„æ–™</h2>
        <p class="profile-muted" style="font-size: 1.1em;">
        ç®¡ç†æ‚¨çš„è´¦æˆ·ä¿¡æ¯å’Œå®‰å…¨è®¾ç½®
    </p>
</div>

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

{% if success %}
<div class="alert alert-success">
    {{ success }}
</div>
{% endif %}

<div class="grid">
    <div class="card">
    <h3 class="accent-blue" style="margin-bottom: 20px;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
        
    <div class="profile-panel">
            <form id="basicInfoForm" onsubmit="return updateBasicInfo(event)">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" value="{{ user.username }}" minlength="3" maxlength="32" required>
                </div>
                <div class="form-group">
                    <label for="email">é‚®ç®±</label>
                    <input type="email" id="email" name="email" value="{{ user.email or '' }}" placeholder="å¯é€‰">
                </div>
                <div style="text-align:center;">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜åŸºæœ¬ä¿¡æ¯</button>
                </div>
            </form>
            
            <div style="margin-bottom: 15px;">
                <strong>è´¦æˆ·çŠ¶æ€:</strong> 
                {% if user.is_active %}
            <span style="color: var(--accent-green);">âœ… æ´»è·ƒ</span>
                {% else %}
            <span style="color: var(--accent-red);">âŒ å·²ç¦ç”¨</span>
                {% endif %}
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>æƒé™çº§åˆ«:</strong> 
                {% if user.is_admin %}
            <span class="badge-chip chip-red">
                        ğŸ‘‘ ç®¡ç†å‘˜
                    </span>
                {% else %}
            <span class="badge-chip chip-blue">
                        ğŸ‘¤ æ™®é€šç”¨æˆ·
                    </span>
                {% endif %}
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>æ³¨å†Œæ—¶é—´:</strong> 
                <span class="profile-muted js-ts" data-ts="{{ user.created_at|default(0)|int }}"></span>
            </div>
            
            {% if user.last_login %}
            <div>
                <strong>æœ€åç™»å½•:</strong> 
                <span class="profile-muted js-ts" data-ts="{{ user.last_login|default(0)|int }}"></span>
            </div>
            {% endif %}
    </div>
    </div>
    
    <div class="card">
    <h3 class="accent-red" style="margin-bottom: 20px;">ğŸ”’ ä¿®æ”¹å¯†ç </h3>
        
    <form id="passwordForm" onsubmit="return changePassword(event)">
            <div class="form-group">
                <label for="current_password">å½“å‰å¯†ç :</label>
                <input type="password" id="current_password" name="current_password" required 
                       placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
            </div>
            
            <div class="form-group">
                <label for="new_password">æ–°å¯†ç :</label>
                <input type="password" id="new_password" name="new_password" required 
                       placeholder="è¯·è¾“å…¥æ–°å¯†ç " minlength="6">
        <small class="profile-muted">å¯†ç é•¿åº¦è‡³å°‘6ä½</small>
            </div>
            
            <div class="form-group">
                <label for="confirm_password">ç¡®è®¤æ–°å¯†ç :</label>
                <input type="password" id="confirm_password" name="confirm_password" required 
                       placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
            </div>
            
            <div style="text-align: center;">
                <button type="submit" class="btn btn-warning">
                    ğŸ”’ ä¿®æ”¹å¯†ç 
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card" style="margin-top: 30px;">
    <h3 class="accent-green" style="margin-bottom: 20px;">âš™ï¸ å¿«é€Ÿæ“ä½œ</h3>
    
    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <a href="/dashboard" class="btn btn-primary">
            ğŸ“ˆ é¡¹ç›®ä»ªè¡¨æ¿
        </a>
        
        <a href="/ai-config" class="btn btn-info">
            ğŸ¤– AIé…ç½®
        </a>

        {% if user.is_admin %}
        <a href="/admin/users" class="btn btn-secondary">
            ğŸ‘¥ ç”¨æˆ·ç®¡ç†
        </a>
        {% endif %}
        
        <a href="/auth/logout" class="btn btn-secondary" 
           onclick="return confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')">
            ğŸšª é€€å‡ºç™»å½•
        </a>
    </div>
 </div>

<div class="profile-panel" style="margin-top: 40px; border-radius: 15px;">
    <h3 style="margin-bottom: 20px; text-align: center;">ğŸ’¡ å®‰å…¨æç¤º</h3>
    
    <div class="grid">
        <div>
            <h4 class="accent-blue" style="margin-bottom: 10px;">ğŸ” å¯†ç å®‰å…¨</h4>
            <p class="profile-muted" style="line-height: 1.6;">
                è¯·å®šæœŸæ›´æ¢å¯†ç ï¼Œä½¿ç”¨åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦çš„å¼ºå¯†ç ã€‚
            </p>
        </div>
        
        <div>
            <h4 class="accent-green" style="margin-bottom: 10px;">ğŸ”’ ä¼šè¯ç®¡ç†</h4>
            <p class="profile-muted" style="line-height: 1.6;">
                åœ¨å…¬å…±è®¾å¤‡ä¸Šä½¿ç”¨åï¼Œè¯·åŠæ—¶é€€å‡ºç™»å½•ä»¥ä¿æŠ¤è´¦æˆ·å®‰å…¨ã€‚
            </p>
        </div>
        
        <div>
            <h4 class="accent-yellow" style="margin-bottom: 10px;">ğŸ“§ é‚®ç®±éªŒè¯</h4>
            <p class="profile-muted" style="line-height: 1.6;">
                ç»‘å®šé‚®ç®±å¯ä»¥å¸®åŠ©æ‚¨åœ¨å¿˜è®°å¯†ç æ—¶å¿«é€Ÿæ¢å¤è´¦æˆ·ã€‚
            </p>
        </div>
        
        <div>
            <h4 class="accent-red" style="margin-bottom: 10px;">âš ï¸ å¼‚å¸¸æ´»åŠ¨</h4>
            <p class="profile-muted" style="line-height: 1.6;">
                å¦‚å‘ç°è´¦æˆ·å¼‚å¸¸æ´»åŠ¨ï¼Œè¯·ç«‹å³ä¿®æ”¹å¯†ç å¹¶è”ç³»ç®¡ç†å‘˜ã€‚
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// è®°å½•åˆå§‹å€¼ç”¨äºæ— æ”¹åŠ¨åˆ¤æ–­
const __origProfileValues = {
    username: (document.getElementById('username')||{}).value || '',
    email: (document.getElementById('email')||{}).value || ''
};
// å¯†ç ç¡®è®¤éªŒè¯
document.getElementById('confirm_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;
    
    if (newPassword && confirmPassword && newPassword !== confirmPassword) {
        this.setCustomValidity('å¯†ç ä¸åŒ¹é…');
    } else {
        this.setCustomValidity('');
    }
});

document.getElementById('new_password').addEventListener('input', function() {
    const confirmPassword = document.getElementById('confirm_password');
    if (confirmPassword.value) {
        confirmPassword.dispatchEvent(new Event('input'));
    }
});

// æ¸²æŸ“æ—¶é—´æˆ³ï¼ˆç§’ï¼‰åˆ°æœ¬åœ°æ—¶é—´
(function(){
    var nodes = document.querySelectorAll('.js-ts[data-ts]');
    nodes.forEach(function(n){
        var v = parseInt(n.getAttribute('data-ts') || '0', 10);
        if (!isNaN(v) && v > 0) {
            n.textContent = new Date(v * 1000).toLocaleString('zh-CN');
        }
    });
})();

// æ›´æ–°åŸºæœ¬ä¿¡æ¯
// ç®€å•æç¤ºç»„ä»¶
function showTempMessage(msg, ok=true){
    let box = document.getElementById('profileMsgBox');
    if(!box){
        box = document.createElement('div');
        box.id = 'profileMsgBox';
        box.style.position='fixed';
        box.style.top='20px';
        box.style.left='50%';
        box.style.transform='translateX(-50%)';
        box.style.zIndex='9999';
        document.body.appendChild(box);
    }
    box.innerHTML = `<div style="padding:10px 18px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.25);background:${ok?'#1b873f':'#b42318'};color:#fff;font-size:14px;">${msg}</div>`;
    setTimeout(()=>{box.innerHTML='';}, 3000);
}

async function updateBasicInfo(e){
    e.preventDefault();
    const form = document.getElementById('basicInfoForm');
    const fd = new FormData(form);
    // æ— æ”¹åŠ¨é¢„æ£€æŸ¥ï¼šå»é™¤é¦–å°¾ç©ºæ ¼æ¯”è¾ƒ
    const curUsername = (fd.get('username')||'').trim();
    const curEmail = (fd.get('email')||'').trim();
    if(curUsername === __origProfileValues.username && curEmail === (__origProfileValues.email||'')){
        // é™é»˜è¿”å›ï¼Œä¸è¯·æ±‚åç«¯
        return false;
    }
    try {
        const res = await fetch('/api/auth/profile/update', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.detail || 'ä¿å­˜å¤±è´¥');
        // å³æ—¶æ›´æ–° DOMï¼ˆæ— éœ€åˆ·æ–°ï¼‰
        if(data.user){
            // åªæ›´æ–°æ˜¾ç¤ºå‹èŠ‚ç‚¹ï¼ˆè¡¨å•æœ¬èº«å·²ç»æ˜¯æ–°å€¼ï¼‰
        }
    let syncHints=[];
    const mode = data.mode || '';
    if(data.external_triggered && mode.includes('external')) syncHints.push('å¤–éƒ¨æ•°æ®åº“ç”¨æˆ·åŒæ­¥å·²è§¦å‘');
    if(data.r2_triggered && mode.includes('r2')) syncHints.push('R2è½»é‡åŒæ­¥å·²è§¦å‘');
        const changedParts = [];
        if(data.changed?.username) changedParts.push('ç”¨æˆ·å');
        if(data.changed?.email) changedParts.push('é‚®ç®±');
        let baseMsg;
        if(changedParts.length === 0){
            // æ— æ”¹åŠ¨ï¼šé™é»˜ï¼Œæ— æç¤º & ä¸æ˜¾ç¤ºåŒæ­¥ä¿¡æ¯
            return false;
        } else {
            baseMsg = `ä¿å­˜æˆåŠŸï¼ˆ${changedParts.join('ã€')}å·²æ›´æ–°` + (syncHints.length? 'ï¼Œ' + syncHints.join('ï¼Œ') : '') + 'ï¼‰';
        }
        showTempMessage(baseMsg, true);
    } catch(err){
        showTempMessage('ä¿å­˜å¤±è´¥ï¼š' + err.message, false);
    }
    return false;
}

async function changePassword(e){
    e.preventDefault();
    const fd = new FormData(document.getElementById('passwordForm'));
    try {
        const res = await fetch('/api/auth/change-password', { method:'POST', body: fd });
        const data = await res.json();
        if(!res.ok || !data.success) throw new Error(data.detail || 'ä¿®æ”¹å¤±è´¥');
        let syncHints=[];
        if(data.external_triggered) syncHints.push('å¤–éƒ¨åŒæ­¥å·²è§¦å‘');
        if(data.r2_triggered) syncHints.push('R2è½»é‡åŒæ­¥å·²è§¦å‘');
        showTempMessage('å¯†ç ä¿®æ”¹æˆåŠŸ' + (syncHints.length?'ï¼ˆ'+syncHints.join('ï¼Œ')+'ï¼‰':''), true);
        ['current_password','new_password','confirm_password'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
    } catch(err){
        showTempMessage('å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + err.message, false);
    }
    return false;
}
</script>
{% endblock %}
