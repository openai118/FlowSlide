{% extends "base.html" %}

{% block title %}系统配置管理 - FlowSlide{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 40px;">
    <h2 style="color: #2c3e50; margin-bottom: 20px;">⚙️ 系统配置管理</h2>
    <p style="font-size: 1.1em; color: #7f8c8d;">
        配置和管理 FlowSlide 的所有系统参数，包括 AI 提供者、生成参数、应用配置等
    </p>
</div>

<!-- 配置导航标签 -->
<div style="margin-bottom: 30px;">
    <div class="config-tabs" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
        <button class="tab-btn active" onclick="switchTab('ai-providers')" data-tab="ai-providers">
            🤖 AI 提供者
        </button>
        <button class="tab-btn" onclick="switchTab('generation-params')" data-tab="generation-params">
            🎛️ 生成参数
        </button>
        <button class="tab-btn" onclick="switchTab('app-config')" data-tab="app-config">
            🔧 应用配置
        </button>
        <button class="tab-btn" onclick="switchTab('image-service')" data-tab="image-service">
            🎨 图片服务
        </button>
        <button class="tab-btn" onclick="switchTab('data-backup')" data-tab="data-backup">
            💾 数据备份
        </button>
    </div>
</div>

<!-- AI 提供者配置标签页 -->
<div id="ai-providers" class="tab-content active">
    <div class="grid">
        <div class="card">
            <h3 style="color: #3498db; margin-bottom: 15px;">📊 当前状态</h3>

            <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <p style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <strong>当前提供者:</strong>
                    <select id="current-provider-select" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); min-width: 120px;">
                        <option value="">选择提供者...</option>
                    </select>
                    <button type="button" onclick="applyCurrentProviderSelect()" style="padding: 4px 12px; background: var(--accent-gradient); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        设置
                    </button>
                </p>
                <p style="margin-bottom: 10px;">
                    <strong>可用提供者:</strong> <span id="available-providers-count">{{ available_providers | length }}</span> 个
                    <small style="color: #6c757d; margin-left: 10px;">（只显示测试通过的提供者）</small>
                </p>
                <p style="margin-bottom: 10px;">
                    <strong>当前模型:</strong>
                    <select id="current_model_select" style="margin-left: 10px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                        <option value="">选择模型...</option>
                    </select>
                    <button onclick="saveAndTestCurrentModel()" id="save_model_btn" style="margin-left: 10px; padding: 4px 12px; background: var(--accent-gradient); color: white; border: none; border-radius: 4px; cursor: pointer; position: relative;">
                        <span id="save-model-text">保存并测试</span>
                        <div id="save-model-progress" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1); border-radius: 4px; align-items: center; justify-content: center;">
                            <div style="width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        </div>
                    </button>
                </p>
                <p>
                    <strong>状态:</strong>
                    <span id="current-provider-status">
                        <span style="color: #7f8c8d;">检查中...</span>
                    </span>
                </p>
            </div>

            <div style="text-align: center;">
                <button id="test-current-btn" onclick="testCurrentProvider()" class="btn btn-primary" style="margin-right: 10px; position: relative;">
                    <span id="test-current-text">🧪 测试当前提供者</span>
                    <div id="test-current-progress" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1); border-radius: 4px; align-items: center; justify-content: center;">
                        <div style="width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </button>
                <button id="refresh-providers-btn" onclick="refreshProviders()" class="btn btn-primary" style="position: relative;">
                    <span id="refresh-providers-text">🔄 重新测试所有提供者</span>
                    <div id="refresh-providers-progress" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1); border-radius: 4px; align-items: center; justify-content: center;">
                        <div style="width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </button>
            </div>
        </div>


    </div>

    <div style="margin-top: 30px;">
        <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">🔧 AI 提供者详情配置</h3>

        <div class="grid">
            {% for provider in ["openai", "anthropic", "google", "azure_openai", "ollama"] %}
            <div class="card provider-config-card" data-provider="{{ provider }}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #2c3e50; margin: 0;">
                        {% if provider == "openai" %}
                            🔍 OpenAI
                        {% elif provider == "anthropic" %}
                            🔍 Anthropic Claude
                        {% elif provider == "google" %}
                            🔍 Google Gemini
                        {% elif provider == "azure_openai" %}
                            🔍 Azure OpenAI
                        {% elif provider == "ollama" %}
                            🔍 Ollama (本地)
                        {% endif %}
                    </h4>

                    <div style="display: flex; gap: 10px; align-items: center;">
                        {% if provider_status[provider] %}
                            <span style="background: var(--success-gradient); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">
                                ✅ 可用
                            </span>
                        {% else %}
                            <span style="background: var(--secondary-gradient); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">
                                ❌ 不可用
                            </span>
                        {% endif %}

                        <div class="custom-radio">
                            <input type="radio" name="default_provider" value="{{ provider }}" id="provider_{{ provider }}"
                                   onchange="setDefaultProvider('{{ provider }}')">
                            <label for="provider_{{ provider }}" class="radio-label">默认</label>
                        </div>
                    </div>
                </div>

                <!-- 提供者配置表单 -->
                <form class="provider-config-form" data-provider="{{ provider }}">
                    <div class="provider-config-fields">
                        {% if provider == "openai" %}
                            <div class="form-group">
                                <label>API Key:</label>
                                <input type="password" name="openai_api_key" placeholder="sk-..."
                                       value="{{ current_config.get('openai_api_key', '') }}"
                                       style="font-family: monospace; font-size: 0.9em;" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>Base URL:</label>
                                <input type="text" name="openai_base_url"
                                       value="{{ current_config.get('openai_base_url', '') }}"
                                       placeholder="{{ current_config.get('openai_base_url', 'https://api.openai.com/v1') }}" autocomplete="off">
                                 <small style="color: #7f8c8d;">可选：自定义网关或代理地址，默认 https://api.openai.com/v1</small>
                            </div>
                            <div class="form-group">
                                <label>默认模型:</label>
                                <div class="model-input-container">
                                    <select name="openai_model" id="openai_model_select" class="model-select" style="display: none;">
                                        <option value="">选择模型...</option>
                                    </select>
                                    <input type="text" name="openai_model" id="openai_model_input" class="model-input"
                                           value="{{ current_config.get('openai_model', '') }}"
                                           placeholder="{{ current_config.get('openai_model', 'gpt-4o') }}" autocomplete="off">
                                    <button type="button" onclick="event.preventDefault(); fetchAndShowModels('openai'); return false;" id="openai_model_fetch_btn"
                                            class="model-fetch-btn" title="获取可用模型列表">
                                        📋
                                    </button>
                                </div>
                                <small style="color: #7f8c8d;">直接输入模型名称，如：gpt-4o，gpt-3.5-turbo，或点击📋获取模型列表</small>
                            </div>
                    {% elif provider == "anthropic" %}
                        <div class="form-group">
                            <label>API Key:</label>
                            <input type="password" name="anthropic_api_key" placeholder="sk-ant-..."
                                   value="{{ current_config.get('anthropic_api_key', '') }}"
                                   style="font-family: monospace; font-size: 0.9em;" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Base URL:</label>
                            <input type="text" name="anthropic_base_url"
                                   value="{{ current_config.get('anthropic_base_url', '') }}"
                                   placeholder="{{ current_config.get('anthropic_base_url', 'https://api.anthropic.com') }}" autocomplete="off">
                            <small style="color: #7f8c8d;">可选：自定义网关或代理地址，默认 https://api.anthropic.com</small>
                        </div>
                        <div class="form-group">
                            <label>默认模型:</label>
                            <div class="model-input-container">
                                <select name="anthropic_model" id="anthropic_model_select" class="model-select" style="display: none;">
                                    <option value="">选择模型...</option>
                                </select>
                                <input type="text" name="anthropic_model" id="anthropic_model_input" class="model-input"
                                       value="{{ current_config.get('anthropic_model', '') }}"
                                       placeholder="{{ current_config.get('anthropic_model', 'claude-3-5-sonnet-20241022') }}" autocomplete="off">
                                <button type="button" onclick="event.preventDefault(); fetchAndShowModels('anthropic'); return false;" id="anthropic_model_fetch_btn"
                                        class="model-fetch-btn" title="获取可用模型列表">
                                    📋
                                </button>
                            </div>
                            <small style="color: #7f8c8d;">直接输入模型名称，如：claude-3-5-sonnet, claude-3-opus，或点击📋获取模型列表</small>
                        </div>
                    {% elif provider == "google" %}
                        <div class="form-group">
                            <label>API Key:</label>
                            <input type="password" name="google_api_key" placeholder="your-google-api-key"
                                   value="{{ current_config.get('google_api_key', '') }}"
                                   style="font-family: monospace; font-size: 0.9em;" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Base URL:</label>
                            <input type="text" name="google_base_url"
                                   value="{{ current_config.get('google_base_url', '') }}"
                                   placeholder="{{ current_config.get('google_base_url', 'https://generativelanguage.googleapis.com') }}" autocomplete="off">
                            <small style="color: #7f8c8d;">可选：自定义网关或代理地址，默认 https://generativelanguage.googleapis.com</small>
                        </div>
                        <div class="form-group">
                            <label>默认模型:</label>
                            <div class="model-input-container">
                                <select name="google_model" id="google_model_select" class="model-select" style="display: none;">
                                    <option value="">选择模型...</option>
                                </select>
                                <input type="text" name="google_model" id="google_model_input" class="model-input"
                                       value="{{ current_config.get('google_model', '') }}"
                                       placeholder="{{ current_config.get('google_model', 'gemini-1.5-flash') }}" autocomplete="off">
                                <button type="button" onclick="event.preventDefault(); fetchAndShowModels('google'); return false;" id="google_model_fetch_btn"
                                        class="model-fetch-btn" title="获取可用模型列表">
                                    📋
                                </button>
                            </div>
                            <small style="color: #7f8c8d;">直接输入模型名称，如：gemini-1.5-flash, gemini-2.5-pro，或点击📋获取模型列表</small>
                        </div>
                    {% elif provider == "azure_openai" %}
                        <div class="form-group">
                            <label>API Key:</label>
                            <input type="password" name="azure_openai_api_key" placeholder="your-azure-key"
                                   value="{{ current_config.get('azure_openai_api_key', '') }}"
                                   style="font-family: monospace; font-size: 0.9em;" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Endpoint:</label>
                            <input type="text" name="azure_openai_endpoint"
                                   value="{{ current_config.get('azure_openai_endpoint', '') }}"
                                   placeholder="https://your-resource.openai.azure.com/" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Deployment Name:</label>
                            <div class="model-input-container">
                                <select name="azure_openai_deployment_name" id="azure_openai_model_select" class="model-select" style="display: none;">
                                    <option value="">选择部署...</option>
                                </select>
                                <input type="text" name="azure_openai_deployment_name" id="azure_openai_model_input" class="model-input"
                                       value="{{ current_config.get('azure_openai_deployment_name', '') }}"
                                       placeholder="your-deployment-name" autocomplete="off">
                                <button type="button" onclick="event.preventDefault(); fetchAndShowModels('azure_openai'); return false;" id="azure_openai_model_fetch_btn"
                                        class="model-fetch-btn" title="获取可用部署列表">
                                    📋
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>API Version:</label>
                            <input type="text" name="azure_openai_api_version"
                                   value="{{ current_config.get('azure_openai_api_version', '') }}"
                                   placeholder="2024-02-15-preview" autocomplete="off">
                        </div>
                    {% elif provider == "ollama" %}
                        <div class="form-group">
                            <label>Base URL:</label>
                            <input type="text" name="ollama_base_url"
                                   value="{{ current_config.get('ollama_base_url', '') }}"
                                   placeholder="{{ current_config.get('ollama_base_url', 'http://localhost:11434') }}" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>默认模型:</label>
                            <div class="model-input-container">
                                <select name="ollama_model" id="ollama_model_select" class="model-select" style="display: none;">
                                    <option value="">选择模型...</option>
                                </select>
                                <input type="text" name="ollama_model" id="ollama_model_input" class="model-input"
                                       value="{{ current_config.get('ollama_model', '') }}"
                                       placeholder="{{ current_config.get('ollama_model', 'llama2, mistral, codellama...') }}" autocomplete="off">
                                <button type="button" onclick="event.preventDefault(); fetchAndShowModels('ollama'); return false;" id="ollama_model_fetch_btn"
                                        class="model-fetch-btn" title="获取可用模型列表">
                                    📋
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="provider-config-actions">
                        <div style="text-align: center;">
                            <button type="button" id="test-{{ provider }}-btn" onclick="testProviderWithProgress('{{ provider }}')" class="btn btn-primary" style="margin-right: 10px; position: relative;">
                                <span id="test-{{ provider }}-text">🧪 测试</span>
                                <div id="test-{{ provider }}-progress" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1); border-radius: 4px; align-items: center; justify-content: center;">
                                    <div style="width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                </div>
                            </button>
                            <button type="button" id="save-{{ provider }}-btn" onclick="saveProviderConfigWithProgress('{{ provider }}')" class="btn btn-success" style="position: relative;">
                                <span id="save-{{ provider }}-text">💾 保存配置</span>
                                <div id="save-{{ provider }}-progress" class="progress-overlay">
                                    <div class="progress-spinner"></div>
                                </div>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 生成参数配置标签页 -->
<div id="generation-params" class="tab-content" style="display: none;">
    <div class="card">
        <h3 style="color: #f39c12; margin-bottom: 30px; text-align: center;">🎛️ AI 生成参数配置</h3>

        <!-- 主要配置区域 -->
        <div style="display: flex; flex-direction: column; gap: 30px;">

            <!-- 新增：质量预设与结构控制 -->
            <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>🧭</span> 质量预设与结构控制
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: #495057;">质量预设</label>
                        <select name="generation_quality_preset">
                            <option value="conservative">稳健（低温度、低发散）</option>
                            <option value="balanced" selected>均衡（推荐）</option>
                            <option value="creative">创意（高温度、更多变化）</option>
                        </select>
                        <small style="color:#6c757d;">选择后将自动调整温度/Top-P/Max Tokens</small>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #495057;">画面比例</label>
                        <select name="aspect_ratio">
                            <option value="16:9" selected>16:9（推荐）</option>
                            <option value="4:3">4:3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #495057;">页数模式</label>
                        <select name="page_count_mode" onchange="onPageCountModeChange(this.value)">
                            <option value="ai_decide" selected>AI 决定</option>
                            <option value="fixed">固定页数</option>
                            <option value="custom_range">范围限制</option>
                        </select>
                    </div>
                    <div class="form-group" id="fixedPagesGroup" style="display:none;">
                        <label style="font-weight: 600; color: #495057;">固定页数</label>
                        <input type="number" name="fixed_pages" min="1" placeholder="10" autocomplete="off">
                    </div>
                    <div class="form-group" id="rangePagesGroup" style="display:none;">
                        <label style="font-weight: 600; color: #495057;">页数范围</label>
                        <div style="display:flex; gap:8px;">
                            <input type="number" name="min_pages" min="1" placeholder="10" style="flex:1;" autocomplete="off">
                            <input type="number" name="max_pages" min="1" placeholder="20" style="flex:1;" autocomplete="off">
                        </div>
                    </div>
                </div>
                <div style="margin-top:16px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                    <label style="display:flex; align-items:center; gap:10px;"><input type="checkbox" name="require_toc" checked> 必含目录页</label>
                    <label style="display:flex; align-items:center; gap:10px;"><input type="checkbox" name="require_summary" checked> 必含总结页</label>
                    <label style="display:flex; align-items:center; gap:10px;"><input type="checkbox" name="require_action_plan"> 必含行动计划</label>
                    <label style="display:flex; align-items:center; gap:10px;"><input type="checkbox" name="require_qa"> 必含Q&A</label>
                </div>
            </div>

            <!-- AI 生成参数 -->
            <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #f39c12; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>🎯</span> AI 生成参数
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                            最大令牌数 (MAX_TOKENS)
                        </label>
                        <div class="input-with-range">
                            <input type="number" name="max_tokens" min="100" max="32000"
                                   value="{{ current_config.get('max_tokens', '') }}"
                                   placeholder="{{ current_config.get('max_tokens', '2000') }}"
                                   style="margin-bottom: 8px;">
                            <input type="range" min="100" max="32000" step="100"
                                   value="{{ current_config.get('max_tokens', '2000') }}"
                                   oninput="this.previousElementSibling.value = this.value"
                                   style="width: 100%; accent-color: #f39c12;">
                        </div>
                        <small style="color: #6c757d; font-size: 0.85em; line-height: 1.4;">
                            控制生成内容的最大长度。较大的值允许生成更长的内容，但会消耗更多资源。
                        </small>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                            温度 (TEMPERATURE)
                        </label>
                        <div class="input-with-range">
                            <input type="number" name="temperature" min="0" max="2" step="0.1"
                                   value="{{ current_config.get('temperature', '') }}"
                                   placeholder="{{ current_config.get('temperature', '0.7') }}"
                                   style="margin-bottom: 8px;">
                            <input type="range" min="0" max="2" step="0.1"
                                   value="{{ current_config.get('temperature', '0.7') }}"
                                   oninput="this.previousElementSibling.value = this.value"
                                   style="width: 100%; accent-color: #f39c12;">
                        </div>
                        <small style="color: #6c757d; font-size: 0.85em; line-height: 1.4;">
                            控制生成内容的创造性。0 = 确定性输出，1 = 平衡，2 = 高创造性。
                        </small>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                            Top-P (TOP_P)
                        </label>
                        <div class="input-with-range">
                            <input type="number" name="top_p" min="0" max="1" step="0.1"
                                   value="{{ current_config.get('top_p', '') }}"
                                   placeholder="{{ current_config.get('top_p', '1.0') }}"
                                   style="margin-bottom: 8px;">
                            <input type="range" min="0" max="1" step="0.1"
                                   value="{{ current_config.get('top_p', '1.0') }}"
                                   oninput="this.previousElementSibling.value = this.value"
                                   style="width: 100%; accent-color: #f39c12;">
                        </div>
                        <small style="color: #6c757d; font-size: 0.85em; line-height: 1.4;">
                            核采样参数，控制词汇选择范围。较低的值使输出更集中，较高的值增加多样性。
                        </small>
                    </div>
                </div>
            </div>

            <!-- 研究功能配置 -->
            <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #e74c3c; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>🔍</span> 研究功能配置
                </h4>

                <!-- 研究提供商选择 -->
                <div style="margin-bottom: 25px;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                            研究提供商 (RESEARCH_PROVIDER)
                        </label>
                        <select name="research_provider" style="margin-bottom: 8px;">
                            <option value="tavily">Tavily (推荐)</option>
                            <option value="searxng">SearXNG</option>
                            <option value="both">两者都使用</option>
                        </select>
                        <small style="color: #6c757d; font-size: 0.85em; line-height: 1.4;">
                            选择用于研究的搜索提供商。Tavily 提供更准确的结果，SearXNG 是开源选择。
                        </small>
                    </div>
                </div>

                <!-- API 密钥配置 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <form id="research-api-form">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                                Tavily API Key
                            </label>
                            <input type="password" name="tavily_api_key" placeholder="tvly-..."
                                   value="{{ current_config.get('tavily_api_key', '') }}"
                                   style="font-family: monospace; font-size: 0.9em; margin-bottom: 8px;" autocomplete="off">
                            <small style="color: #6c757d; font-size: 0.85em; line-height: 1.4;">
                                用于深度研究功能的API密钥，可在 <a href="https://tavily.com" target="_blank" style="color: #e74c3c;">Tavily官网</a> 获取
                            </small>
                        </div>

                        <div class="form-group">
                            <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block;">
                                SearXNG 主机地址
                            </label>
                            <input type="url" name="searxng_host" placeholder="http://localhost:8888"
                                   value="{{ current_config.get('searxng_host', '') }}"
                                   style="font-family: monospace; font-size: 0.9em; margin-bottom: 8px;" autocomplete="off">
                            <small style="color: #6c757d; font-size: 0.85em; line-height: 1.4;">
                                SearXNG 实例的完整URL地址，用于开源搜索引擎研究功能
                            </small>
                        </div>
                    </form>
                </div>

                <!-- 高级选项 -->
                <div style="background: var(--glass-bg); padding: var(--spacing-lg); border-radius: var(--border-radius-md); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow);">
                    <h5 style="color: var(--text-primary); margin-bottom: var(--spacing-md); font-weight: 700; display: flex; align-items: center; gap: 8px;">
                        <span>⚙️</span> 高级选项
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="toggle-label">
                                <div class="toggle-switch">
                                    <input type="checkbox" name="research_enable_content_extraction">
                                    <span class="toggle-slider"></span>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">启用深度内容提取</div>
                                    <small style="color: #6c757d; font-weight: 400;">从搜索结果页面提取完整内容进行深度分析，提高研究质量</small>
                                </div>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">
                                最大内容长度
                            </label>
                            <div class="input-with-range">
                                <input type="number" name="research_max_content_length" min="1000" max="20000"
                                       value="{{ current_config.get('research_max_content_length', '') }}"
                                       placeholder="{{ current_config.get('research_max_content_length', '5000') }}"
                                       style="margin-bottom: 8px;">
                                <input type="range" min="1000" max="20000" step="500"
                                       value="{{ current_config.get('research_max_content_length', '5000') }}"
                                       oninput="this.previousElementSibling.value = this.value"
                                       style="width: 100%; accent-color: var(--accent-purple, #667eea);">
                            </div>
                            <small style="color: var(--text-secondary); font-size: 0.85em; line-height: 1.4;">
                                每个页面提取的最大字符数，较大的值提供更多信息但消耗更多资源
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 其他配置 -->
            <div style="background: var(--glass-bg); padding: var(--spacing-lg); border-radius: var(--border-radius-md); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow);">
                <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: 8px;">
                    <span>📄</span> 其他配置
                </h4>
                <form id="other-config-form">
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">
                            Apryse License Key (PPT导出)
                        </label>
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <input type="password" name="apryse_license_key" id="apryse_license_key" placeholder="your-apryse-license-key"
                                   value="{{ current_config.get('apryse_license_key', '') }}"
                                   style="font-family: monospace; font-size: 0.9em; flex: 1;" autocomplete="off">
                            <button type="button" onclick="checkApryseLicense()" id="checkLicenseBtn"
                                    style="padding: 8px 16px; background: var(--accent-blue, #4facfe); color: white; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer; white-space: nowrap;">
                                检测许可证
                            </button>
                        </div>
                        <div id="licenseStatus" style="margin-top: 8px; padding: 8px; border-radius: 4px; font-size: 0.85em; display: none;"></div>
                        <small style="color: var(--text-secondary); font-size: 0.85em; line-height: 1.4; margin-top: 8px; display: block;">
                            用于PPTX导出功能的Apryse SDK许可证密钥，可在 <a href="https://www.pdftron.com/" target="_blank" style="color: var(--accent-purple, #667eea);">Apryse官网</a> 获取
                        </small>
                    </div>
                </form>
            </div>
        </div>

        <!-- 操作按钮 -->
    <div style="text-align: center; margin-top: 30px; padding: 20px; background: var(--glass-bg); border-radius: 12px; border: 1px solid var(--glass-border);">
            <button onclick="saveGenerationParams()" class="btn btn-success" style="padding: 12px 30px; font-weight: 600; font-size: 1.05em;">
                💾 保存生成参数
            </button>
        </div>
    </div>
</div>



<!-- 应用配置标签页 -->
<div id="app-config" class="tab-content" style="display: none;">
    <div class="card">
        <h3 style="color: #9b59b6; margin-bottom: 20px;">🔧 应用配置</h3>

        <div class="grid">
            <div>
                <h4 style="color: #3498db; margin-bottom: 15px;">服务器配置</h4>

                <div class="form-group">
                    <label>主机地址 (HOST):</label>
                    <input type="text" name="host" placeholder="0.0.0.0" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>端口 (PORT):</label>
                    <input type="number" name="port" min="1" max="65535" placeholder="8000" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>基础URL (BASE_URL):</label>
                    <input type="url" name="base_url" placeholder="http://localhost:8000" autocomplete="off">
                    <small style="color: #7f8c8d;">用于生成图片等资源的绝对URL，支持反向代理域名</small>
                </div>

                <div class="form-group">
                    <label class="switch-label" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <div class="toggle-switch">
                            <input type="checkbox" name="reload">
                            <span class="toggle-slider"></span>
                        </div>
                        <span>自动重载 (RELOAD)</span>
                    </label>
                </div>
            </div>

            <div>
                <h4 style="color: #27ae60; margin-bottom: 15px;">安全配置</h4>

                <form id="security-config-form">
                    <div class="form-group">
                        <label>密钥 (SECRET_KEY):</label>
                        <input type="password" name="secret_key" placeholder="your-very-secure-secret-key"
                               style="font-family: monospace; font-size: 0.9em;" autocomplete="off">
                        <small style="color: #7f8c8d;">用于会话加密的密钥</small>
                    </div>

                    <div class="form-group">
                        <label>访问令牌过期时间 (ACCESS_TOKEN_EXPIRE_MINUTES):</label>
                        <input type="number" name="access_token_expire_minutes" min="0" max="525600"
                               placeholder="30">
                        <small style="color: #7f8c8d;">单位：分钟，设置为 0 表示永不过期</small>
                    </div>

                    <!-- Save button for security config -->
                    <div style="text-align: center; margin-top: 15px;">
                        <button type="button" onclick="saveSecurityConfig()" class="btn btn-success" style="padding: 8px 20px; font-size: 0.9em;">
                            💾 保存安全配置
                        </button>
                    </div>
                </form>
            </div>

            <div>
                <h4 style="color: #f39c12; margin-bottom: 15px;">文件上传配置</h4>

                <div class="form-group">
                    <label>最大文件大小 (MAX_FILE_SIZE):</label>
                    <input type="number" name="max_file_size" min="1048576" max="104857600"
                           placeholder="10485760">
                    <small style="color: #7f8c8d;">单位：字节 (10MB = 10485760)</small>
                </div>

                <div class="form-group">
                    <label>上传目录 (UPLOAD_DIR):</label>
                    <input type="text" name="upload_dir" placeholder="uploads" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>缓存TTL (CACHE_TTL):</label>
                    <input type="number" name="cache_ttl" min="60" max="86400"
                           placeholder="3600">
                    <small style="color: #7f8c8d;">单位：秒 (1小时 = 3600)</small>
                </div>
            </div>

            <div style="width:100%; grid-column: 1 / -1;">
                <h3 style="color:#c0392b; margin-bottom:12px; font-size:1.25em; font-weight:700;">数据库与 Cloudflare R2 配置</h3>

                <form id="app-config-form" autocomplete="on" style="display:flex; gap:16px; width:100%; align-items:flex-start;">
                    <!-- Hidden username field recommended for password autofill heuristics -->
                    <input type="text" name="__appconfig_username" autocomplete="username" style="position:absolute; left:-9999px; top:auto; width:1px; height:1px; opacity:0;" />
                    <!-- 左侧：快速配置 + R2 参数（已交换） -->
                    <div style="display:flex; flex-direction:column; gap:12px; flex:1;">
                        <!-- 快速配置 区块 -->
                        <div style="background: var(--panel-bg); padding:14px; border-radius:10px; border:1px solid var(--panel-border);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h5 id="quick-config-title" style="margin:0; color:#2c3e50; font-size:1.05em; font-weight:600;">快速配置：数据库 & R2</h5>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn btn-outline" type="button" onclick="showBulkPasteModal()">批量粘贴解析</button>
                                </div>
                            </div>
                            <p style="color:#6c757d; margin:0 0 10px 0;">粘贴环境变量或键值对（每行或用分号分隔），解析后会填充下方字段，解析完成请点击“保存应用配置”生效。</p>
                        </div>

                        <!-- R2 参数（从右侧移动到此处） -->
                        <div style="background: var(--panel-bg); padding:14px; border-radius:10px; border:1px solid var(--panel-border);">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                                <h6 style="margin:0; color:#2c3e50; font-size:1.05em; font-weight:600;">☁️ R2 的配置参数</h6>
                                <span id="r2-config-badge" style="display:inline-block;padding:2px 8px;border-radius:12px;color:#fff;font-size:12px;background:#6c757d;margin-left:8px;">未配置</span>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <div class="form-group">
                                    <label>R2_ACCESS_KEY_ID</label>
                                    <input type="text" name="r2_access_key_id" placeholder="R2_ACCESS_KEY_ID" value="{{ current_config.get('r2_access_key_id','') }}" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label>R2_SECRET_ACCESS_KEY</label>
                                    <input type="password" name="r2_secret_access_key" placeholder="R2_SECRET_ACCESS_KEY" value="{{ current_config.get('r2_secret_access_key','') }}" autocomplete="current-password">
                                </div>
                                <div class="form-group">
                                    <label>R2_ENDPOINT</label>
                                    <input type="text" name="r2_endpoint" placeholder="R2_ENDPOINT" value="{{ current_config.get('r2_endpoint','') }}" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label>R2_BUCKET_NAME</label>
                                    <input type="text" name="r2_bucket_name" placeholder="R2_BUCKET_NAME" value="{{ current_config.get('r2_bucket_name','') }}" autocomplete="off">
                                </div>
                                <!-- STORAGE_BUCKET and STORAGE_PROVIDER moved to database block -->
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：数据库配置参数（从左侧移动到此处） -->
                    <div style="display:flex; flex-direction:column; gap:12px; flex:1;">
                        <div style="background: var(--panel-bg); padding:14px; border-radius:10px; border:1px solid var(--panel-border); height:100%; box-sizing:border-box;">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                                <h6 style="margin:0; color:#2c3e50; font-size:1.05em; font-weight:600;">🗄️ 数据库配置参数</h6>
                                <span id="db-config-badge" style="display:inline-block;padding:2px 8px;border-radius:12px;color:#fff;font-size:12px;background:#6c757d;margin-left:8px;">未配置</span>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <div class="form-group">
                                    <label>DATABASE_URL</label>
                                    <input type="password" name="database_url" placeholder="sqlite:///./flowslide.db" data-sensitive="true" value="{{ current_config.get('database_url','') }}" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label>API_URL</label>
                                    <input type="text" name="api_url" placeholder="API_URL" value="{{ current_config.get('api_url','') }}" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label>API_ANON_KEY</label>
                                    <input type="password" name="api_anon_key" placeholder="API_ANON_KEY" value="{{ current_config.get('api_anon_key','') }}" autocomplete="current-password">
                                </div>
                                <div class="form-group">
                                    <label>API_SERVICE_KEY</label>
                                    <input type="password" name="api_service_key" placeholder="API_SERVICE_KEY" value="{{ current_config.get('api_service_key','') }}" autocomplete="current-password">
                                </div>
                                <div class="form-group">
                                    <label>STORAGE_BUCKET</label>
                                    <input type="text" name="storage_bucket" placeholder="STORAGE_BUCKET" value="{{ current_config.get('storage_bucket','') }}" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label>STORAGE_PROVIDER</label>
                                    <input type="text" name="storage_provider" placeholder="STORAGE_PROVIDER" value="{{ current_config.get('storage_provider','') }}" autocomplete="off">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="saveAppConfig()" class="btn btn-success" style="margin-right: 10px;">
                💾 保存应用配置
            </button>
        </div>
    </div>
</div>

<!-- 图片服务配置标签页 -->
<div id="image-service" class="tab-content" style="display: none;">
    <div class="card">
        <h3 style="color: #e67e22; margin-bottom: 20px;">🎨 图片服务配置</h3>

        <!-- 服务状态显示 -->
    <div style="background: var(--panel-bg); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--panel-border);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <h4 style="color: #495057; margin: 0; font-size: 1.1em;">📊 服务状态</h4>
                <span id="image-service-status" style="background: #95a5a6; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 500;">
                    检查中...
                </span>
            </div>
            <div style="color: #6c757d; font-size: 0.9em; line-height: 1.5;">
                <strong>可用提供者:</strong> <span id="available-image-providers">检查中...</span>
                <br>
                <span style="color: #868e96;">图片服务为PPT生成提供视觉内容支持，包括AI图片生成、网络图片搜索和本地图片管理</span>
            </div>
        </div>

        <!-- 主要配置区域 -->
        <div style="display: flex; flex-direction: column; gap: 25px;">

            <!-- 基础设置 -->
            <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #28a745; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>🎨</span> 图片服务设置
                </h4>

                <div class="main-toggle-option">
                    <label class="toggle-label">
                        <div class="toggle-switch">
                            <input type="checkbox" name="enable_image_service" onchange="toggleImageServiceOptions()">
                            <span class="toggle-slider"></span>
                        </div>
                        <div>
                            <div style="font-size: 1.1em; font-weight: 600; color: #495057; margin-bottom: 4px;">启用图片生成服务</div>
                            <small style="color: #6c757d; font-weight: 400;">在PPT生成时自动添加相关图片，提升视觉效果</small>
                        </div>
                    </label>
                </div>

                <div id="image-service-options" style="display: none;">
                    <div style="background: var(--panel-bg); padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h5 style="color: #495057; margin-bottom: 15px; font-weight: 600;">图片获取方式 (可多选)</h5>
                        <div style="display: grid; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="toggleImageSourceConfig()">
                                <input type="checkbox" name="enable_local_images" value="true" style="transform: scale(1.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #495057;">📁 本地图床</div>
                                    <small style="color: #6c757d;">从本地图片库中智能选择合适的图片</small>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="toggleImageSourceConfig()">
                                <input type="checkbox" name="enable_network_search" value="true" style="transform: scale(1.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #495057;">🌐 网络搜索</div>
                                    <small style="color: #6c757d;">通过Unsplash、Pixabay等API搜索高质量网络图片</small>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="toggleImageSourceConfig()">
                                <input type="checkbox" name="enable_ai_generation" value="true" style="transform: scale(1.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #495057;">🎨 AI生成</div>
                                    <small style="color: #6c757d;">使用AI模型生成定制化创意图片</small>
                                </div>
                            </label>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: var(--tint-blue); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                            <small style="color: var(--accent-blue); font-weight: 500;">💡 提示：可以同时启用多种方式，AI会根据页面内容智能选择最合适的图片来源</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API密钥配置 -->
            <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #007bff; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>🔑</span> API密钥配置
                </h4>

                <form id="image-service-api-form">
                    <!-- AI图片生成服务 -->
                    <div style="margin-bottom: 30px;">
                        <h5 style="color: #6f42c1; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>🎨</span> AI图片生成服务
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">DALL-E API Key (OpenAI):</label>
                                <input type="password" name="openai_api_key_image" placeholder="sk-..."
                                       value="{{ current_config.get('openai_api_key_image', '') }}"
                                       style="font-family: monospace; font-size: 0.9em; margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">用于DALL-E 3图片生成，与文本生成共用OpenAI密钥</small>
                            </div>

                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">SiliconFlow API Key:</label>
                                <input type="password" name="siliconflow_api_key" placeholder="your-siliconflow-api-key"
                                       value="{{ current_config.get('siliconflow_api_key', '') }}"
                                       style="font-family: monospace; font-size: 0.9em; margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">用于SiliconFlow Kolors图片生成</small>
                            </div>
                        </div>
                    </div>

                    <!-- Pollinations免费服务 -->
                    <div style="margin-bottom: 30px;">
                        <h5 style="color: #28a745; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>🌸</span> Pollinations (免费服务)
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">API Token (可选):</label>
                                <input type="password" name="pollinations_api_token" placeholder="your-pollinations-token"
                                       value="{{ current_config.get('pollinations_api_token', '') }}"
                                       style="font-family: monospace; font-size: 0.9em; margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">可选的API Token，用于移除logo和获得更高的使用限制</small>
                            </div>

                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">Referrer (可选):</label>
                                <input type="text" name="pollinations_referrer" placeholder="MyApp"
                                       value="{{ current_config.get('pollinations_referrer', '') }}"
                                       style="margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">推荐人标识符，用于认证和统计（可选）</small>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px 16px; background: var(--tint-green); border: 1px solid var(--accent-green); border-radius: 8px; border-left: 4px solid var(--accent-green);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: var(--accent-green); font-weight: 500;">✅ 基础功能免费</span>
                            </div>
                            <small style="color: var(--text-secondary); margin-top: 5px; display: block;">Pollinations提供免费的AI图片生成服务，Token可选用于高级功能</small>
                        </div>
                    </div>

                    <!-- 网络图片搜索服务 -->
                    <div>
                        <h5 style="color: #17a2b8; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>🌐</span> 网络图片搜索服务
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">Unsplash Access Key:</label>
                                <input type="password" name="unsplash_access_key" placeholder="your-unsplash-access-key"
                                       value="{{ current_config.get('unsplash_access_key', '') }}"
                                       style="font-family: monospace; font-size: 0.9em; margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">用于搜索Unsplash高质量摄影图片，支持多语言搜索</small>
                            </div>

                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">Pixabay API Key:</label>
                                <input type="password" name="pixabay_api_key" placeholder="your-pixabay-api-key"
                                       value="{{ current_config.get('pixabay_api_key', '') }}"
                                       style="font-family: monospace; font-size: 0.9em; margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">用于搜索免费图片和插图</small>
                            </div>

                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">SearXNG Host:</label>
                                <input type="url" name="searxng_host_image" placeholder="http://localhost:8888"
                                       value="{{ current_config.get('searxng_host_image', '') }}"
                                       style="font-family: monospace; font-size: 0.9em; margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">SearXNG实例的主机地址，用于开源搜索引擎图片搜索</small>
                            </div>
                        </div>
                    </div>

                    <!-- Save button for image service API form -->
                    <div style="text-align: center; margin-top: 25px; padding: 20px; background: var(--glass-bg); border-radius: 12px; border: 1px solid var(--glass-border);">
                        <button type="button" onclick="saveImageServiceConfigWithProgress()" class="btn btn-success" style="padding: 12px 30px; font-weight: 600; font-size: 1.05em; position: relative;">
                            <span id="save-image-service-text">💾 保存API配置</span>
                            <div id="save-image-service-progress" class="progress-overlay">
                                <div class="progress-spinner"></div>
                            </div>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 详细配置 -->
            <div style="background: var(--input-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #6f42c1; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>⚙️</span> 详细配置
                </h4>

                <!-- 配置选项容器 -->
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- 本地图床配置 -->
                    <div id="local-images-config" style="display: none; padding: 20px; background: var(--panel-bg); border-radius: 8px; border-left: 4px solid #27ae60;">
                        <h5 style="color: #27ae60; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>📁</span> 本地图床配置
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label class="toggle-label">
                                    <div class="toggle-switch">
                                        <input type="checkbox" name="local_images_smart_selection" checked>
                                        <span class="toggle-slider"></span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">启用智能选择</div>
                                        <small style="color: #6c757d; font-weight: 400;">AI会根据内容智能匹配本地图片库中的图片</small>
                                    </div>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">每页最大本地图片数量:</label>
                                <input type="number" name="max_local_images_per_slide" value="2" min="1" max="5" style="margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">限制每页从本地图床选择的图片数量</small>
                            </div>
                        </div>
                    </div>

                    <!-- 网络搜索配置 -->
                    <div id="network-search-config" style="display: none; padding: 20px; background: var(--panel-bg); border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <h5 style="color: #17a2b8; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>🌐</span> 网络搜索配置
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">默认网络搜索提供商:</label>
                                <select name="default_network_search_provider" style="margin-top: 5px;">
                                    <option value="unsplash">Unsplash (高质量摄影图片)</option>
                                    <option value="pixabay" selected>Pixabay (免费图片和插图)</option>
                                    <option value="searxng">SearXNG (开源搜索引擎)</option>
                                </select>
                                <small style="color: #6c757d; margin-top: 5px; display: block;">选择优先使用的网络搜索源</small>
                            </div>
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">每页最大网络图片数量:</label>
                                <input type="number" name="max_network_images_per_slide" value="2" min="1" max="5" style="margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">限制每页从网络搜索的图片数量</small>
                            </div>
                        </div>
                    </div>

                    <!-- AI生成配置 -->
                    <div id="ai-generation-config" style="display: none; padding: 20px; background: var(--panel-bg); border-radius: 8px; border-left: 4px solid #6f42c1;">
                        <h5 style="color: #6f42c1; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>🎨</span> AI生成配置
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">默认AI图片生成提供商:</label>
                                <select name="default_ai_image_provider" onchange="toggleProviderSpecificConfig()" style="margin-top: 5px;">
                                    <option value="dalle">DALL-E 3 (OpenAI)</option>
                                    <option value="siliconflow">SiliconFlow (Kolors)</option>
                                    <option value="pollinations">Pollinations (免费)</option>
                                </select>
                                <small style="color: #6c757d; margin-top: 5px; display: block;">选择默认的AI图片生成服务</small>
                            </div>
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">每页最大AI生成图片数量:</label>
                                <input type="number" name="max_ai_images_per_slide" value="1" min="1" max="3" style="margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">限制每页AI生成的图片数量</small>
                            </div>
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">图片生成质量:</label>
                                <select name="ai_image_quality" style="margin-top: 5px;">
                                    <option value="standard">标准质量</option>
                                    <option value="hd">高清质量</option>
                                </select>
                                <small style="color: #6c757d; margin-top: 5px; display: block;">更高质量的图片需要更多时间和成本</small>
                            </div>
                        </div>

                        <!-- Pollinations特定配置 -->
                        <div id="pollinations-specific-config" style="display: none; padding: 20px; background: var(--tint-green); border-radius: 8px; border-left: 4px solid var(--accent-green);">
                            <h6 style="color: var(--accent-green); margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                <span>🌸</span> Pollinations 配置
                            </h6>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label style="font-weight: 500; color: #495057;">生成模型:</label>
                                    <select name="pollinations_model" style="margin-top: 5px;">
                                        <option value="flux">Flux (高质量，默认)</option>
                                        <option value="turbo">Turbo (快速生成)</option>
                                        <option value="gptimage">GPT Image (支持透明背景)</option>
                                    </select>
                                    <small style="color: #155724; margin-top: 5px; display: block;">选择Pollinations的图片生成模型</small>
                                </div>
                            </div>
                            <div class="pollinations-options-grid">
                                <div class="pollinations-option">
                                    <label class="pollinations-checkbox-label">
                                        <input type="checkbox" name="pollinations_enhance" class="pollinations-checkbox">
                                        <span class="pollinations-option-text">
                                            <strong>启用提示词增强</strong>
                                            <small>AI会自动优化和扩展您的提示词以获得更好的效果</small>
                                        </span>
                                    </label>
                                </div>
                                <div class="pollinations-option">
                                    <label class="pollinations-checkbox-label">
                                        <input type="checkbox" name="pollinations_safe" class="pollinations-checkbox">
                                        <span class="pollinations-option-text">
                                            <strong>启用安全过滤</strong>
                                            <small>启用严格的NSFW内容过滤</small>
                                        </span>
                                    </label>
                                </div>
                                <div class="pollinations-option">
                                    <label class="pollinations-checkbox-label">
                                        <input type="checkbox" name="pollinations_nologo" class="pollinations-checkbox">
                                        <span class="pollinations-option-text">
                                            <strong>移除Pollinations Logo</strong>
                                            <small>需要API Token或Referrer认证才能生效</small>
                                        </span>
                                    </label>
                                </div>
                                <div class="pollinations-option">
                                    <label class="pollinations-checkbox-label">
                                        <input type="checkbox" name="pollinations_private" class="pollinations-checkbox">
                                        <span class="pollinations-option-text">
                                            <strong>私有模式</strong>
                                            <small>生成的图片不会出现在公共feed中</small>
                                        </span>
                                    </label>
                                </div>
                                <div class="pollinations-option">
                                    <label class="pollinations-checkbox-label">
                                        <input type="checkbox" name="pollinations_transparent" class="pollinations-checkbox">
                                        <span class="pollinations-option-text">
                                            <strong>透明背景</strong>
                                            <small>生成透明背景图片（仅GPT Image模型支持）</small>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 全局图片配置 -->
                    <div style="padding: 20px; background: var(--tint-yellow); border-radius: 8px; border-left: 4px solid var(--accent-yellow);">
                        <h5 style="color: var(--accent-yellow); margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>⚙️</span> 全局图片配置
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">每页最大图片总数:</label>
                                <input type="number" name="max_total_images_per_slide" value="3" min="1" max="8" style="margin-top: 5px;" autocomplete="off">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">限制每页图片的总数量，避免页面过于拥挤</small>
                            </div>
                            <div class="form-group">
                                <label class="toggle-label">
                                    <div class="toggle-switch">
                                        <input type="checkbox" name="enable_smart_image_selection" checked>
                                        <span class="toggle-slider"></span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">启用智能图片选择</div>
                                        <small style="color: #6c757d; font-weight: 400;">AI会根据页面内容和设计需求智能决定图片数量和来源</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div style="text-align: center; margin-top: 25px; padding: 20px; background: var(--glass-bg); border-radius: 12px; border: 1px solid var(--glass-border);">
                <button id="save-image-service-btn" onclick="saveImageServiceConfigWithProgress()" class="btn btn-success" style="padding: 12px 30px; font-weight: 600; font-size: 1.05em; position: relative;">
                    <span id="save-image-service-text">💾 保存配置</span>
                    <div id="save-image-service-progress" class="progress-overlay">
                        <div class="progress-spinner"></div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>



<!-- Bulk Paste Modal -->
<div id="bulk-paste-modal" class="modal" style="display: none;" onclick="if(event.target === this) hideBulkPasteModal()">
    <div class="modal-content bulk-paste-modal-content" style="width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; background: #ffffff; border: 2px solid #e1e5e9; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <!-- Modal Header -->
        <div class="modal-header" style="background: #f8f9fa; border-bottom: 1px solid #dee2e6; border-radius: 12px 12px 0 0; padding: 20px; border-bottom: none;">
            <h3 style="color: #24292f; margin: 0; text-align: center; font-size: 1.3em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span style="font-size: 1.5em;">📋</span>
                批量粘贴解析配置
            </h3>
            <button onclick="hideBulkPasteModal()" class="modal-close-btn" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: #24292f; font-size: 1.5em; cursor: pointer; padding: 5px; border-radius: 50%; transition: all 0.2s ease; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                ✕
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body" style="background: #ffffff; border: 1px solid #dee2e6; border-top: none; border-bottom: none; padding: 25px;">
            <!-- Instructions -->
            <div class="instruction-card" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <span style="color: #0366d6; font-size: 1.2em;">💡</span>
                    <div>
                        <h4 style="color: #24292f; margin: 0 0 8px 0; font-size: 1em; font-weight: 600;">使用说明</h4>
                        <p style="color: #586069; margin: 0; font-size: 0.9em; line-height: 1.5;">
                            粘贴环境变量或键值对，每行一个或用分号分隔。系统会自动解析并填充到下方配置字段中。
                        </p>
                    </div>
                </div>
            </div>

            <!-- Textarea Section -->
            <div class="textarea-section">
                <label for="bulk-paste-text" style="display: block; margin-bottom: 12px; font-weight: 600; color: #24292f; font-size: 1em;">
                    配置内容
                </label>
                <div class="textarea-container" style="position: relative;">
                    <textarea id="bulk-paste-text"
                              placeholder="粘贴环境变量或键值对，每行一个或用分号分隔&#10;&#10;例如：&#10;R2_ACCESS_KEY_ID=your_key&#10;R2_SECRET_ACCESS_KEY=your_secret&#10;R2_ENDPOINT=https://your-account.r2.cloudflarestorage.com&#10;R2_BUCKET_NAME=your-bucket&#10;DATABASE_URL=sqlite:///./flowslide.db&#10;API_URL=https://your-api.com&#10;API_ANON_KEY=your-anon-key&#10;API_SERVICE_KEY=your-service-key"
                              style="width: 100%; height: 250px; padding: 15px; border: 2px solid #d1d5db; border-radius: 10px; background: #ffffff; color: #24292f; font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace; font-size: 13px; line-height: 1.5; resize: vertical; transition: all 0.3s ease; outline: none; overflow: auto;"
                              onfocus="this.style.borderColor = '#0366d6'; this.style.boxShadow = '0 0 0 3px rgba(3, 102, 214, 0.1)';"
                              onblur="this.style.borderColor = '#d1d5db'; this.style.boxShadow = 'none';">
                    </textarea>
                    <div class="textarea-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                        <small style="color: #586069; font-size: 0.85em;">
                            支持格式：KEY=VALUE 或 KEY:VALUE，每行一个或用分号分隔。注释行以#开头。
                        </small>
                        <button onclick="document.getElementById('bulk-paste-text').value = ''" class="clear-btn" style="background: #f6f8fa; color: #24292f; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.2s ease;">
                            清空
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="preview-section" id="bulk-paste-preview" style="display: none; margin-top: 20px;">
                <h4 style="color: #24292f; margin-bottom: 12px; font-size: 1em; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <span style="color: #28a745;">🔍</span>
                    解析预览
                </h4>
                <div class="preview-content" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; max-height: 150px; overflow-y: auto;">
                    <div id="preview-items" style="display: grid; gap: 8px;">
                        <!-- Preview items will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0 0 12px 12px; border-top: none; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div class="footer-info" style="color: #586069; font-size: 0.85em;">
                <span id="parse-status">准备解析配置...</span>
            </div>
            <div class="footer-actions" style="display: flex; gap: 10px;">
                <button onclick="hideBulkPasteModal()" class="btn btn-secondary" style="padding: 10px 20px; font-weight: 500;">
                    取消
                </button>
                <button onclick="applyBulkPaste()" class="btn btn-primary" style="padding: 10px 25px; font-weight: 500; position: relative;">
                    <span id="apply-btn-text">✅ 解析并应用</span>
                    <div id="apply-btn-progress" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1); border-radius: 6px; align-items: center; justify-content: center;">
                        <div style="width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>



<!-- 数据备份配置标签页 -->
<div id="data-backup" class="tab-content" style="display: none;">
    <div class="card">
        <h3 style="color: #8e44ad; margin-bottom: 20px;">💾 数据备份与系统监控</h3>

        <!-- 系统运行模式状态 -->
        <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <h4 style="color: #8e44ad; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span>🚀</span> 系统运行模式
            </h4>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #495057; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>📊</span> 当前模式
                    </h5>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="current-deployment-mode" style="background: #95a5a6; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9em; font-weight: 600;">
                            检测中...
                        </span>
                        <button onclick="autoDetectMode()" style="padding: 8px 16px; background: var(--accent-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            � 自动检测模式
                        </button>
                    </div>

                    <!-- 当前模式详细信息 -->
                    <div id="current-mode-details" style="margin-top: 15px; padding: 12px; background: rgba(52, 152, 219, 0.1); border-radius: 6px; display: none;">
                        <!-- 当前模式的详细信息将在这里显示 -->
                    </div>

                    <p style="margin-top: 10px; color: #6c757d; font-size: 0.85em;">
                        系统根据环境变量自动检测并选择最适合的部署模式
                    </p>
                </div>

                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #495057; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>🎯</span> 模式选择
                    </h5>

                    <!-- 配置状态显示 -->
                    <style>
                        /* 强制隐藏模式选择下方的描述区域，保持下拉与切换按钮紧凑 */
                        #selected-mode-info { display: none !important; }
                    </style>
                    <div id="config-status-display" style="background: rgba(52, 152, 219, 0.1); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <!-- 配置状态将在这里动态显示 -->
                    </div>

                    <!-- 模式选择下拉框 -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px; font-size: 0.9em;">
                            选择部署模式:
                        </label>
                        <select id="deployment-mode-select" onchange="onModeSelectionChange(this.value)" style="width: 100%; padding: 10px; border: 1px solid var(--glass-border); border-radius: 6px; background: var(--glass-bg); color: #495057; font-size: 0.9em;">
                            <option value="">请选择模式...</option>
                            <!-- 模式选项将在这里动态生成 -->
                        </select>
                    </div>

                    <!-- 模式信息显示 -->
                    <div id="selected-mode-info" style="background: rgba(39, 174, 96, 0.1); padding: 12px; border-radius: 6px; margin-bottom: 15px; display: none;">
                        <!-- 选中模式的详细信息将在这里显示 -->
                    </div>

                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 10px;">
                        <button id="switch-mode-btn" onclick="switchToSelectedMode()" disabled style="flex: 1; padding: 10px; background: var(--accent-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            切换到此模式
                        </button>
                        <button onclick="loadAvailableModes()" style="padding: 10px 15px; background: var(--secondary-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            🔄 刷新
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据同步与备份 -->
        <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <h4 style="color: #27ae60; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span>🔄</span> 数据同步与备份
            </h4>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                <!-- 数据库同步 -->
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #27ae60; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:8px;"><span>�</span> 数据库同步</div>
                        <span id="db-config-badge" style="display:inline-block;padding:6px 10px;border-radius:12px;color:#fff;font-size:12px;background:#6c757d;">未配置</span>
                    </h5>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-weight: 500; color: #495057;">最后同步时间:</span>
                            </div>
                            <span id="last-db-backup" style="color: #6c757d; font-size: 0.9em;">未知</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #495057;">同步文件大小:</span>
                            <span id="db-backup-size" style="color: #6c757d; font-size: 0.9em;">未知</span>
                        </div>
                        <!-- External DB: adopt the same two-row layout as the R2 card for alignment -->
                        <!-- Row 1: category select + generate -->
                        <div style="margin-top:8px;">
                            <label style="font-weight:500; color:#495057;">选择备份类别:</label>
                            <div style="display:flex; gap:8px; margin-top:6px;">
                                <select id="external-db-type" style="flex:1; min-width:180px; max-width:60%; padding:6px; border-radius:6px; border:1px solid #ddd;"></select>
                                <button onclick="createExternalBackup()" class="btn btn-secondary" style="padding:6px 10px;">生成</button>
                            </div>
                        </div>

                        <!-- Row 2: file list + actions -->
                        <div style="margin-top:8px;">
                            <label style="font-weight:500; color:#495057;">外数据库备份:</label>
                            <div style="display:flex; gap:8px; margin-top:6px;">
                                <select id="db-file-list" style="flex:1; min-width:180px; max-width:60%; padding:6px; border-radius:6px; border:1px solid #ddd; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                    <option value="">-- 无可用文件 --</option>
                                </select>
                                <button onclick="restoreSelectedDB()" class="btn btn-warning" style="padding:6px 10px;">恢复</button>
                                <button onclick="deleteSelectedDB()" class="btn btn-danger" style="padding:6px 10px;">删除</button>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                            <button onclick="syncToExternal()" class="btn btn-success" style="padding: 8px 6px; font-size: 0.85em;">
                                📤 同步到外部
                            </button>
                            <button onclick="syncFromExternal()" class="btn btn-warning" style="padding: 8px 6px; font-size: 0.85em;">
                                � 从外部恢复
                            </button>
                            <button onclick="downloadLatestBackup()" class="btn btn-info" style="padding: 8px 6px; font-size: 0.85em;">
                                � 下载备份
                            </button>
                        </div>
                    </div>
                </div>

                <!-- R2 云存储同步 -->
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #17a2b8; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:8px;"><span>☁️</span> R2 云存储同步</div>
                        <span id="r2-config-badge" style="display:inline-block;padding:6px 10px;border-radius:12px;color:#fff;font-size:12px;background:#6c757d;">未配置</span>
                    </h5>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Status/test controls moved to 系统状态监控 -->
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #495057;">最后同步时间:</span>
                                <span id="last-r2-backup" style="color: #6c757d; font-size: 0.9em;">未知</span>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #495057;">同步文件大小:</span>
                                <span id="r2-backup-size" style="color: #6c757d; font-size: 0.9em;">未知</span>
                            </div>

                        <!-- 分类选择与一键生成并同步 -->
                        <div style="margin-top:8px;">
                            <label style="font-weight:500; color:#495057;">选择备份类别:</label>
                            <div style="display:flex; gap:8px; margin-top:6px;">
                                <select id="r2-category-select" style="flex:1; min-width:180px; max-width:60%; padding:6px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="">-- 请选择类别 --</option>
                                </select>
                                <button onclick="syncCategoryToR2()" class="btn btn-primary" style="padding:6px 10px;">生成并同步该类别</button>
                            </div>
                        </div>

                        <!-- R2 file list selector -->
                        <div style="margin-top:8px;">
                            <label style="font-weight:500; color:#495057;">R2 文件备份:</label>
                            <div style="display:flex; gap:8px; margin-top:6px;">
                                <select id="r2-file-list" style="flex:1; min-width:180px; max-width:60%; padding:6px; border-radius:6px; border:1px solid #ddd; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                    <option value="">-- 无可用文件 --</option>
                                </select>
                                <button onclick="restoreSelectedFromR2()" class="btn btn-warning" style="padding:6px 10px;">恢复</button>
                                <button onclick="deleteSelectedFromR2()" class="btn btn-danger" style="padding:6px 10px;">删除</button>
                            </div>
                        </div>

                        <!-- DB backup file list selector (for database card) -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                            <button onclick="syncToR2()" class="btn btn-primary" style="padding: 8px 6px; font-size: 0.85em;">
                                🔄 同步到R2
                            </button>
                            <button onclick="restoreFromR2()" class="btn btn-warning" style="padding: 8px 6px; font-size: 0.85em;">
                                📤 从R2恢复
                            </button>
                            <button onclick="downloadFromR2()" class="btn btn-info" style="padding: 8px 6px; font-size: 0.85em;">
                                � 下载数据
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统状态监控 -->
        <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <h4 style="color: #f39c12; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span>📈</span> 系统状态监控
            </h4>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- 数据库连接状态 -->
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #f39c12; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>🗄️</span> 数据库连接
                    </h5>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="db-connection-status" style="background: #95a5a6; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 500;">
                            检查中...
                        </span>
                        <span id="db-response-time" style="color: #6c757d; font-size: 0.85em;">
                            --
                        </span>
                        <button onclick="testDatabaseConnection()" style="padding: 6px 12px; background: var(--accent-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            🔍 测试
                        </button>
                    </div>
                    <p style="margin-top: 10px; color: #6c757d; font-size: 0.85em;">
                        检查数据库连接状态和响应时间
                    </p>
                </div>

                <!-- R2 云存储连接（集中显示） -->
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #17a2b8; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>☁️</span> R2 云存储
                    </h5>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="r2-sync-status" style="background: #95a5a6; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 500;">
                            未测试
                        </span>
                        <span id="r2-response-time" style="color: #6c757d; font-size: 0.85em;">
                            --
                        </span>
                        <button onclick="testR2Connection()" style="padding: 6px 12px; background: var(--accent-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            🔍 测试
                        </button>
                    </div>
                        <!-- R2 最后同步时间放置在数据备份的 R2 云存储同步区块下方 -->
                    <p style="margin-top: 10px; color: #6c757d; font-size: 0.85em;">
                        检查 R2 云存储连接状态和响应时间
                    </p>
                </div>

                <!-- 系统资源使用 -->
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #f39c12; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>💻</span> 系统资源
                    </h5>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 500; color: #495057;">内存使用:</span>
                            <span id="memory-usage" style="color: #6c757d;">加载中...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 500; color: #495057;">磁盘空间:</span>
                            <span id="disk-usage" style="color: #6c757d;">加载中...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 500; color: #495057;">运行时间:</span>
                            <span id="uptime" style="color: #6c757d;">加载中...</span>
                        </div>
                    </div>
                </div>

                <!-- 同步历史记录 -->
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #f39c12; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>📋</span> 同步历史
                    </h5>
                    <div id="backup-history" style="max-height: 120px; overflow-y: auto; color: #6c757d; font-size: 0.85em;">
                        加载同步历史...
                    </div>
                    <button onclick="refreshBackupHistory()" style="margin-top: 10px; padding: 6px 12px; background: var(--secondary-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; width: 100%;">
                        🔄 刷新历史
                    </button>
                </div>
            </div>
        </div>

        <!-- 配置管理 -->
        <div style="background: var(--panel-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--panel-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <h4 style="color: #e74c3c; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span>⚙️</span> 配置管理
            </h4>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- 自动备份设置 -->
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #e74c3c; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>⏰</span> 自动备份设置
                    </h5>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label class="toggle-label">
                            <div class="toggle-switch">
                                <input type="checkbox" name="auto_backup_enabled" onchange="toggleAutoBackup()">
                                <span class="toggle-slider"></span>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">启用自动备份</div>
                                <small style="color: #6c757d; font-weight: 400;">定期自动备份数据库和配置文件</small>
                            </div>
                        </label>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label style="font-weight: 500; color: #495057;">备份间隔:</label>
                            <select name="backup_interval" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); color: var(--text-color);">
                                <option value="daily">每日</option>
                                <option value="weekly">每周</option>
                                <option value="monthly">每月</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 备份存储设置 -->
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <h5 style="color: #e74c3c; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>📁</span> 备份存储设置
                    </h5>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #495057;">本地存储路径:</span>
                            <span style="color: #6c757d; font-size: 0.9em;">./backups/</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #495057;">保留备份数量:</span>
                            <input type="number" name="max_backups" value="10" min="1" max="50" style="width: 60px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); color: var(--text-color);" autocomplete="off">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #495057;">保留天数:</span>
                            <input type="number" id="retentionDays" name="retention_days" value="30" min="1" max="365" style="width: 60px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--input-bg); color: var(--text-color);" autocomplete="off">
                        </div>
                        <button onclick="cleanupOldBackups()" class="btn btn-danger" style="padding: 8px 12px; font-size: 0.9em;">
                            🗑️ 清理旧备份
                        </button>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div style="text-align: center; margin-top: 25px; padding: 20px; background: var(--glass-bg); border-radius: 12px; border: 1px solid var(--glass-border);">
                <button onclick="saveBackupConfig()" class="btn btn-success" style="padding: 12px 30px; font-weight: 600; font-size: 1.05em;">
                    💾 保存备份配置
                </button>
            </div>
        </div>
    </div>
</div>



<!-- Test Results Modal -->
<div id="testModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <h3 style="color: var(--text-primary); margin-bottom: 20px; text-align: center;">
            🧪 AI 提供者测试结果
        </h3>

        <div id="testResults" style="margin-bottom: 20px;">
            <!-- Test results will be inserted here -->
        </div>

        <div style="text-align: center;">
            <button onclick="closeTestModal()" class="btn" style="background: var(--secondary-gradient);">关闭</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* 配置标签页样式 */
.config-tabs {
    border-bottom: 2px solid var(--glass-border);
    margin-bottom: 30px;
}

.tab-btn {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    color: var(--text-primary);
    padding: 12px 24px;
    border-radius: 12px 12px 0 0;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    margin-bottom: -2px;
    position: relative;
}

.tab-btn:hover {
    background: rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
}

.tab-btn.active {
    background: var(--primary-gradient);
    color: white;
    border-bottom: 2px solid transparent;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.tab-content {
    animation: fadeIn 0.3s ease-in-out;
}

.tab-content.active {
    display: block !important;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 提供者配置卡片样式 */
.provider-config-card {
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    min-height: 420px; /* 设置最小高度确保一致性 */
    height: 100%; /* 填充网格容器高度 */
}

.provider-config-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(31, 38, 135, 0.4);
}

/* 确保AI提供者网格布局一致 */
#ai-providers .grid {
    display: grid;
    gap: var(--spacing-xl);
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    align-items: stretch; /* 确保所有卡片高度一致 */
}

/* 提供者配置表单容器 */
.provider-config-form {
    flex: 1; /* 占据剩余空间 */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* 表单字段区域 */
.provider-config-fields {
    flex: 1;
}

/* 按钮区域固定在底部 */
.provider-config-actions {
    margin-top: auto;
    padding-top: 15px;
}

.provider-config-form .form-group {
    margin-bottom: 15px;
}

.provider-config-form .form-group label {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

.provider-config-form .form-group input,
.provider-config-form .form-group select {
    padding: 10px 15px;
    font-size: 0.9rem;
    width: 100%;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    transition: all 0.3s ease;
}

.provider-config-form .form-group input:focus,
.provider-config-form .form-group select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.provider-config-form .form-group small {
    display: block;
    margin-top: 5px;
    font-size: 0.8rem;
    line-height: 1.4;
    color: #6c757d;
}

/* 确保所有输入框高度一致 */
.provider-config-form .form-group input[type="text"],
.provider-config-form .form-group input[type="password"],
.provider-config-form .form-group select {
    min-height: 44px;
    box-sizing: border-box;
}



/* 状态指示器 */
.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
}

.status-available {
    background: #27ae60;
    color: white;
}

.status-unavailable {
    background: #e74c3c;
    color: white;
}

/* 现代化单选框样式 */
.custom-radio {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: 10px;
}

.custom-radio input[type="radio"] {
    appearance: none;
    -webkit-appearance: none;
    width: 22px;
    height: 22px;
    border: 2px solid #e1e5e9;
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--input-bg);
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.custom-radio input[type="radio"]:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    transform: scale(1.05);
}

.custom-radio input[type="radio"]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.custom-radio input[type="radio"]:checked {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.custom-radio input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--accent-color);
    opacity: 1;
    animation: radiomark 0.3s ease-in-out;
}

@keyframes radiomark {
    0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0);
    }
    50% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.3);
    }
    100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

.custom-radio .radio-label {
    font-size: 0.9em;
    color: #495057;
    font-weight: 600;
    cursor: pointer;
    transition: color 0.3s ease;
    user-select: none;
}

.custom-radio input[type="radio"]:checked + .radio-label {
    color: #667eea;
}

/* 单选框禁用状态 */
.custom-radio input[type="radio"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--input-bg);
    border-color: var(--border-color);
}

.custom-radio input[type="radio"]:disabled:hover {
    transform: none;
    box-shadow: none;
}

.custom-radio input[type="radio"]:disabled + .radio-label {
    opacity: 0.5;
    cursor: not-allowed;
}

/* 现代化复选框样式 */
.form-group input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid #e1e5e9;
    border-radius: 6px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--input-bg);
    margin-right: 10px;
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.form-group input[type="checkbox"]:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    transform: translateY(-1px);
}

.form-group input[type="checkbox"]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input[type="checkbox"]:checked {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.form-group input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 6px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    opacity: 1;
    animation: checkmark 0.3s ease-in-out;
}

@keyframes checkmark {
    0% {
        opacity: 0;
        transform: rotate(45deg) scale(0);
    }
    50% {
        opacity: 1;
        transform: rotate(45deg) scale(1.2);
    }
    100% {
        opacity: 1;
        transform: rotate(45deg) scale(1);
    }
}

/* 复选框禁用状态 */
.form-group input[type="checkbox"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--input-bg);
    border-color: var(--border-color);
}

.form-group input[type="checkbox"]:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* 美化的选择框样式 */
.form-group select {
    appearance: none;
    -webkit-appearance: none;
    background: var(--input-bg);
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    transition: all 0.3s ease;
    color: var(--text-color);
}

.form-group select:hover {
    border-color: #667eea;
}

.form-group select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

/* 美化的输入框样式 */
.form-group input[type="text"],
.form-group input[type="password"],
.form-group input[type="number"],
.form-group input[type="url"] {
    border: 2px solid var(--border-color);
    border-radius: 8px;
    transition: all 0.3s ease;
    background: var(--input-bg);
    color: var(--text-color);
}

.form-group input[type="text"]:hover,
.form-group input[type="password"]:hover,
.form-group input[type="number"]:hover,
.form-group input[type="url"]:hover {
    border-color: #667eea;
}

.form-group input[type="text"]:focus,
.form-group input[type="password"]:focus,
.form-group input[type="number"]:focus,
.form-group input[type="url"]:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

/* 美化的按钮样式 */
.btn {
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    color: white;
}

.btn-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.btn-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
}

/* OpenAI模型输入框样式 */
.model-input-container {
    position: relative;
    display: flex;
    align-items: center;
}

.model-input,
.model-select {
    flex: 1;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 15px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    background: var(--input-bg);
    color: var(--text-color);
    height: 44px; /* 确保输入框和选择框有相同高度 */
    box-sizing: border-box;
}

.model-input:hover,
.model-select:hover {
    border-color: #667eea;
}

.model-input:focus,
.model-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.model-fetch-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    background: var(--input-bg);
    cursor: pointer;
    font-size: 14px;
    display: flex;
 align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: #6c757d;
    margin-left: 8px;
    flex-shrink: 0;
}

.model-fetch-btn:hover {
    background: #667eea;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.model-fetch-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.model-fetch-btn.loading {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 图片服务页面特定样式 */
#image-service .form-group {
    margin-bottom: 15px;
}

#image-service .form-group label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 5px;
    display: block;
}

#image-service .form-group input,
#image-service .form-group select {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    font-size: 0.9em;
    transition: all 0.3s ease;
}

#image-service .form-group input:focus,
#image-service .form-group select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

#image-service .form-group small {
    color: #6c757d;
    font-size: 0.85em;
    line-height: 1.4;
}

/* 图片服务配置卡片悬停效果 */
#image-service > .card > div > div {
    transition: all 0.3s ease;
}

#image-service > .card > div > div:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* 图片获取方式选择框特殊样式 */
#image-service label[onclick="toggleImageSourceConfig()"] {
    border: 2px solid var(--border-color) !important;
    border-radius: 12px !important;
    padding: 16px 20px !important;
    background: var(--input-bg) !important;
    cursor: pointer !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative;
    overflow: hidden;
}

#image-service label[onclick="toggleImageSourceConfig()"]:hover {
    border-color: #667eea !important;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15) !important;
    transform: translateY(-2px) !important;
}

#image-service label[onclick="toggleImageSourceConfig()"]::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    transition: left 0.5s;
}

#image-service label[onclick="toggleImageSourceConfig()"]:hover::before {
    left: 100%;
}

/* 选中状态的图片获取方式 */
#image-service label[onclick="toggleImageSourceConfig()"] input[type="checkbox"]:checked + div {
    color: #667eea;
}

#image-service label[onclick="toggleImageSourceConfig()"] input[type="checkbox"]:checked {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* 复选框标签优化 */
#image-service .form-group label[style*="display: flex"] {
    align-items: flex-start !important;
    gap: 12px !important;
    line-height: 1.5 !important;
}

#image-service .form-group label[style*="display: flex"] input[type="checkbox"] {
    margin-top: 2px;
}

/* Pollinations配置区域专用样式 */
.pollinations-options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-top: 15px;
}

.pollinations-option {
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(40, 167, 69, 0.2);
    border-radius: 8px;
    padding: 12px 16px;
    transition: all 0.3s ease;
}

.pollinations-option:hover {
    background: rgba(255, 255, 255, 0.8);
    border-color: rgba(40, 167, 69, 0.4);
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
}

.pollinations-checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    width: 100%;
    margin: 0;
}

.pollinations-checkbox {
    margin-top: 2px;
    flex-shrink: 0;
}

.pollinations-option-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
}

.pollinations-option-text strong {
    font-weight: 600;
    color: #495057;
    font-size: 0.95em;
    line-height: 1.3;
    display: block;
}

.pollinations-option-text small {
    color: #155724;
    font-size: 0.85em;
    line-height: 1.4;
    font-weight: 400;
    display: block;
    margin: 0;
}

/* 生成参数页面特定样式 */
#generation-params .form-group {
    margin-bottom: 20px;
}

#generation-params .form-group label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

#generation-params .form-group input,
#generation-params .form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.95em;
    transition: all 0.3s ease;
}

#generation-params .form-group input:focus,
#generation-params .form-group select:focus {
    border-color: #f39c12;
    box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
    outline: none;
}

#generation-params .form-group small {
    color: #6c757d;
    font-size: 0.85em;
    line-height: 1.4;
    margin-top: 5px;
    display: block;
}

/* 输入框与滑块组合样式 */
.input-with-range {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.input-with-range input[type="number"] {
    margin-bottom: 0 !important;
}

.input-with-range input[type="range"] {
    height: 6px;
    border-radius: 3px;
    background: var(--border-color);
    outline: none;
    transition: all 0.3s ease;
}

.input-with-range input[type="range"]:hover {
    background: var(--text-secondary);
}

.input-with-range input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #f39c12;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}

.input-with-range input[type="range"]::-webkit-slider-thumb:hover {
    background: #e67e22;
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.input-with-range input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #f39c12;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}

.input-with-range input[type="range"]::-moz-range-thumb:hover {
    background: #e67e22;
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* 开关样式复选框 (用于主要的启用/禁用选项) */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    margin-right: 12px;
    flex-shrink: 0;
}

.toggle-switch input[type="checkbox"] {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border-color);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 24px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: var(--input-bg);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-switch input:checked + .toggle-slider {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(26px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.toggle-switch:hover .toggle-slider {
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
}

.toggle-switch input:focus + .toggle-slider {
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* 开关样式的标签 */
.toggle-label {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
    color: #495057;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s ease;
}

.toggle-label:hover {
    color: #667eea;
}

/* 为主要的启用选项应用开关样式 */
.main-toggle-option {
    padding: 20px;
    background: var(--panel-bg);
    border-radius: 12px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.main-toggle-option:hover {
    border-color: #667eea;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .config-tabs {
        flex-direction: column;
        align-items: stretch;
    }

    .tab-btn {
        border-radius: 8px;
        margin-bottom: 5px;
    }

    .tab-btn.active {
        transform: none;
    }

    .grid {
        grid-template-columns: 1fr;
    }

    .model-fetch-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
    }

    /* 图片服务页面响应式 */
    #image-service .form-group {
        margin-bottom: 20px;
    }

    #image-service div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }

    /* 开关样式响应式 */
    .toggle-label {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .toggle-switch {
        align-self: flex-start;
    }

    .main-toggle-option {
        padding: 16px;
    }

    /* 复选框和单选框响应式 */
    .form-group input[type="checkbox"],
    .custom-radio input[type="radio"] {
        width: 18px;
        height: 18px;
    }

    .custom-radio input[type="radio"]:checked::after {
        width: 8px;
        height: 8px;
    }

    /* Pollinations配置响应式 */
    .pollinations-options-grid {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }

    .pollinations-option {
        padding: 10px 12px;
    }

    .pollinations-checkbox-label {
        gap: 10px !important;
    }

    .pollinations-option-text strong {
        font-size: 0.9em;
    }

    .pollinations-option-text small {
        font-size: 0.8em;
    }

    /* 生成参数页面响应式 */
    #generation-params div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }

    #generation-params .form-group {
        margin-bottom: 25px;
    }

    .input-with-range {
        gap: 6px;
    }

    .input-with-range input[type="range"]::-webkit-slider-thumb {
        width: 16px;
        height: 16px;
    }

    .input-with-range input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
    }
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background: var(--card-bg);
    margin: 5% auto;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    position: relative;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Bulk Paste Modal Specific Styles */
.bulk-paste-modal-content {
    margin: 2% auto;
    padding: 0;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--glass-border);
    overflow: hidden;
    max-width: 700px;
}

.modal-header {
    position: relative;
    background: var(--panel-bg);
    border-bottom: 1px solid var(--panel-border);
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.1);
}

.modal-body {
    background: var(--card-bg);
}

.instruction-card {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    transition: all 0.3s ease;
}

.instruction-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.textarea-container textarea {
    transition: all 0.3s ease;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
    overflow: auto; /* 确保内容过多时显示滚动条 */
}

.textarea-container textarea:focus {
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.clear-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.preview-content {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
}

.preview-content::-webkit-scrollbar {
    width: 6px;
}

.preview-content::-webkit-scrollbar-track {
    background: var(--panel-bg);
}

.preview-content::-webkit-scrollbar-thumb {
    background: var(--panel-border);
    border-radius: 3px;
}

.preview-content::-webkit-scrollbar-thumb:hover {
    background: var(--accent-blue);
}

.modal-footer {
    background: var(--panel-bg);
    border-top: 1px solid var(--panel-border);
}

.footer-actions .btn {
    transition: all 0.3s ease;
}

.footer-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

/* Responsive design for bulk paste modal */
@media (max-width: 768px) {
    .bulk-paste-modal-content {
        margin: 1% auto;
        width: 95%;
        max-width: none;
    }

    .modal-header,
    .modal-body,
    .modal-footer {
        padding: 15px;
    }

    .textarea-container textarea {
        height: 200px;
        font-size: 12px;
    }

    .footer-actions {
        flex-direction: column;
        gap: 8px;
    }

    .footer-actions .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Safe container for server-rendered config as JSON to avoid JS parse-time issues -->
<script id="current-config-json" type="application/json">{{ current_config | tojson | replace("</","<\\/") }}</script>
<script>
// 受控日志：只有在 ?debug=1 或 window.__ai_debug 为 true 时输出 info/debug
window.__ai_log = (function(){
    const enabled = (new URLSearchParams(window.location.search).get('debug') === '1') || window.__ai_debug === true;
    return {
        debug: (...args) => { if(enabled) console.debug(...args); },
        info:  (...args) => { if(enabled) console.info(...args); },
        warn:  (...args) => console.warn(...args),
        error: (...args) => console.error(...args)
    };
})();
// 全局变量和常量
// Load server-rendered config from the safe JSON script tag. Use try/catch so a parse error
// doesn't abort the rest of the script and break UI initialization (which caused the
// "系统配置" 卡片 无法打开 when a JSON.parse error occurred).
let currentConfig = {};
try {
    const __cfg = document.getElementById('current-config-json');
    if (__cfg && __cfg.textContent) {
        currentConfig = JSON.parse(__cfg.textContent);
    }
} catch (e) {
    console.error('Failed to parse currentConfig JSON from DOM:', e);
    currentConfig = {};
}
const AVAILABLE_PROVIDERS = ['openai', 'anthropic', 'google', 'azure_openai', 'ollama'];
const PROVIDER_DISPLAY_NAMES = {
    'openai': 'OpenAI',
    'anthropic': 'Anthropic Claude',
    'google': 'Google Gemini',
    'azure_openai': 'Azure OpenAI',
    'ollama': 'Ollama'
};
const API_ENDPOINTS = {
    config_all: '/api/config/all',
    config_ai_providers: '/api/config/ai_providers',
    current_provider: '/api/config/current-provider'
};
let providerTestCache = new Map();

// 进度条管理器
class ProgressManager {
    static show(buttonId, progressId, textId) {
        const elements = this.getElements(buttonId, progressId, textId);
        if (elements.button && elements.progress && elements.text) {
            elements.button.disabled = true;
            elements.text.style.opacity = '0.5';
            elements.progress.style.display = 'flex';
        }
    }

    static hide(buttonId, progressId, textId) {
        const elements = this.getElements(buttonId, progressId, textId);
        if (elements.button && elements.progress && elements.text) {
            elements.button.disabled = false;
            elements.text.style.opacity = '1';
            elements.progress.style.display = 'none';
        }
    }

    static getElements(buttonId, progressId, textId) {
        return {
            button: document.getElementById(buttonId),
            progress: document.getElementById(progressId),
            text: document.getElementById(textId)
        };
    }
}

// 向后兼容的函数
function showButtonProgress(buttonId, progressId, textId) {
    ProgressManager.show(buttonId, progressId, textId);
}

function hideButtonProgress(buttonId, progressId, textId) {
    ProgressManager.hide(buttonId, progressId, textId);
}

    const defaultProviderTemplate = "{{ current_config.get('default_ai_provider', 'openai') }}";

// 密文显示/隐藏
function toggleSecretVisibility(fieldName, btn){
    const input = document.querySelector(`#app-config input[name="${fieldName}"]`);
    if(!input) return;
    input.type = (input.type === 'password') ? 'text' : 'password';
    btn.textContent = (input.type === 'password') ? '👁️' : '🙈';
}

// 提供者测试状态缓存（已在上面定义）

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 关键：尽快返回以提升页面响应性。非关键工作在空闲时运行。
    // 触发配置加载，但不要在此处 await（避免在DOMContentLoaded阶段顺序阻塞）
    loadAllConfigs().then(() => {
        // 在短延迟后初始化会话相关UI（仍较为重要）
        setTimeout(async () => {
            try {
                await initCurrentProviderSelect();
                await syncCurrentProviderStatus();
                initTopStatusDisplay();
            } catch (e) {
                window.__ai_log.warn('延迟初始化提供者时出错', e);
            }
        }, 100);
    }).catch(e => {
        window.__ai_log.warn('加载配置失败（非致命）', e);
    });

    // 将非关键的后台检查放到空闲回调中执行以避免影响首次交互
    const deferredStartup = () => {
        try {
            checkImageServiceStatus();
            loadCachedTestResults();
            resetAllProviderStatus();
        } catch (e) {
            window.__ai_log.warn('延迟启动任务出错', e);
        }
    };

    if ('requestIdleCallback' in window) {
        try { requestIdleCallback(deferredStartup, { timeout: 2000 }); } catch(e){ setTimeout(deferredStartup, 500); }
    } else {
        setTimeout(deferredStartup, 500);
    }
});

// 获取可用的提供者列表（只返回测试成功的提供者）
function getAvailableProviders() {
    const availableProviders = [];

    for (const provider of AVAILABLE_PROVIDERS) {
        try {
            // 只有缓存的测试结果显示成功的提供者才被认为是可用的
            const cachedResult = getCachedTestResult(provider);
            if (cachedResult && cachedResult.success) {
                availableProviders.push(provider);
            }
        } catch (error) {
            // 配置不完整，跳过
            window.__ai_log.info(`提供者 ${provider} 配置检查失败，跳过:`, error.message);
        }
    }

    return availableProviders;
}

// 初始化当前提供者下拉框（只显示可用的提供者）
async function initCurrentProviderSelect() {
    const selectElement = document.getElementById('current-provider-select');
    if (!selectElement) return;

    try {
        // 保存当前选择的提供者
        const currentSelection = selectElement.value;

        // 获取可用的提供者列表
        const availableProviders = getAvailableProviders();

        // 清空现有选项
        selectElement.innerHTML = '<option value="">选择提供者...</option>';

        // 添加可用的提供者
        availableProviders.forEach(provider => {
            const option = document.createElement('option');
            option.value = provider;
            option.textContent = getProviderDisplayName(provider);
            selectElement.appendChild(option);
        });

        // 恢复之前的选择（如果仍然可用）
        if (currentSelection && availableProviders.includes(currentSelection)) {
            selectElement.value = currentSelection;
            window.__ai_log.info('恢复提供者选择:', currentSelection);
        } else if (availableProviders.length > 0) {
            // 如果之前没有选择或选择的提供者不可用，尝试从API获取当前提供者
            try {
                const response = await fetch('/api/config/current-provider');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.current_provider && availableProviders.includes(result.current_provider)) {
                        selectElement.value = result.current_provider;
                        window.__ai_log.info('从API设置当前提供者:', result.current_provider);
                    }
                }
            } catch (error) {
                console.warn('获取当前提供者失败:', error);
            }
        }

        window.__ai_log.info('可用提供者:', availableProviders);

        // 更新页面显示的可用提供者数量
        updateAvailableProvidersCount(availableProviders.length);

        // 更新默认提供者单选按钮的可用性
        updateDefaultProviderRadios(availableProviders);
    } catch (error) {
        console.error('初始化提供者下拉框失败:', error);
    }
}

// 更新默认提供者单选按钮的可用性
function updateDefaultProviderRadios(availableProviders) {
    document.querySelectorAll('input[name="default_provider"]').forEach(radio => {
        const provider = radio.value;
        const isAvailable = availableProviders.includes(provider);

        // 禁用/启用单选按钮
        radio.disabled = !isAvailable;

        // 更新标签样式
        const label = radio.nextElementSibling;
        if (label) {
            if (isAvailable) {
                label.style.opacity = '1';
                label.style.cursor = 'pointer';
                label.title = '设为默认提供者';
            } else {
                label.style.opacity = '0.5';
                label.style.cursor = 'not-allowed';
                label.title = '提供者不可用，请先配置API Key';
            }
        }

        // 如果当前选中的提供者不可用，清除选中状态
        if (radio.checked && !isAvailable) {
            radio.checked = false;
        }
    });
}

// 工具函数类
class ProviderUtils {
    static getDisplayName(provider) {
        return PROVIDER_DISPLAY_NAMES[provider] || provider;
    }

    static isValidProvider(provider) {
        return AVAILABLE_PROVIDERS.includes(provider);
    }

    static getAllProviders() {
        return [...AVAILABLE_PROVIDERS];
    }
}

// API调用工具类
class ApiUtils {
    static async fetchConfig(endpoint) {
        try {
            const response = await fetch(endpoint);
            if (response.ok) {
                const result = await response.json();
                return result.success ? result : null;
            }
        } catch (error) {
            console.error(`API调用失败 ${endpoint}:`, error);
        }
        return null;
    }

    static async saveConfig(endpoint, config) {
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ config })
            });
            if (response.ok) {
                const result = await response.json();
                return result.success ? result : null;
            }
        } catch (error) {
            console.error(`保存配置失败 ${endpoint}:`, error);
        }
        return null;
    }
}

// HTML生成工具类
class HtmlUtils {
    static createProgressButton(id, text, className = 'btn btn-primary', onclick = '') {
        return `
            <button id="${id}-btn" onclick="${onclick}" class="${className}" style="position: relative;">
                <span id="${id}-text">${text}</span>
                <div id="${id}-progress" class="progress-overlay">
                    <div class="progress-spinner"></div>
                </div>
            </button>
        `;
    }

    static createProgressOverlay(id) {
        return `
            <div id="${id}-progress" class="progress-overlay">
                <div class="progress-spinner"></div>
            </div>
        `;
    }
}

// 错误处理工具类
class ErrorHandler {
    static async handleAsyncOperation(operation, errorMessage, progressConfig = null) {
        if (progressConfig) {
            ProgressManager.show(progressConfig.buttonId, progressConfig.progressId, progressConfig.textId);
        }

        try {
            const result = await operation();
            return { success: true, data: result };
        } catch (error) {
            console.error(errorMessage, error);
            showNotification(`${errorMessage}: ${error.message}`, 'error');
            return { success: false, error };
        } finally {
            if (progressConfig) {
                ProgressManager.hide(progressConfig.buttonId, progressConfig.progressId, progressConfig.textId);
            }
        }
    }
}

// 更新页面显示的可用提供者数量
function updateAvailableProvidersCount(count) {
    const countElement = document.getElementById('available-providers-count');
    if (countElement) {
        countElement.textContent = count;
    }
}

// 向后兼容的函数
function getProviderDisplayName(provider) {
    return ProviderUtils.getDisplayName(provider);
}

// 同步当前提供者状态
async function syncCurrentProviderStatus() {
    try {
        const response = await fetch('/api/config/current-provider');
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.current_provider) {
                const currentProvider = result.current_provider;
                window.__ai_log.info('同步当前提供者状态:', currentProvider);

                // 更新页面显示的当前提供者
                updateCurrentProviderDisplay(currentProvider);

                // 更新顶部状态显示
                updateTopStatusDisplay(currentProvider);

                // 更新模型选择框
                loadCurrentProviderModels(currentProvider);
            } else {
                console.warn('API返回的提供者为空:', result);
                // 使用模板传入的默认提供者兜底（render时确定，非缓存）
                const defaultProvider = (typeof defaultProviderTemplate === 'string' && defaultProviderTemplate) ? defaultProviderTemplate : 'openai';
                updateCurrentProviderDisplay(defaultProvider);
                updateTopStatusDisplay(defaultProvider);
                loadCurrentProviderModels(defaultProvider);
            }
        } else {
            console.error('获取当前提供者失败，状态码:', response.status);
            if (response.status === 401 || response.status === 403) {
                console.warn('认证失败，可能需要登录');
                // 显示登录提示或重定向到登录页面
                const currentProviderSpan = document.getElementById('current-provider-display');
                if (currentProviderSpan) {
                    currentProviderSpan.textContent = '需要登录';
                    currentProviderSpan.style.background = '#e74c3c';
                }
            }
        }
    } catch (error) {
        console.warn('同步当前提供者状态失败:', error);
        // 使用默认提供者作为后备
        const defaultProvider = 'openai';
        updateCurrentProviderDisplay(defaultProvider);
        updateTopStatusDisplay(defaultProvider);
        loadCurrentProviderModels(defaultProvider);
    }
}

// 标签页切换功能
function switchTab(tabName) {
    // 隐藏所有标签页内容
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
    });

    // 移除所有标签按钮的激活状态
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // 显示选中的标签页内容
    const targetTab = document.getElementById(tabName);
    if (targetTab) {
        targetTab.style.display = 'block';
        targetTab.classList.add('active');
    }

    // 激活选中的标签按钮
    const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (targetBtn) {
        targetBtn.classList.add('active');
    }

    // 加载对应的配置数据
    loadTabConfig(tabName);
}

// 加载标签页配置数据
async function loadTabConfig(tabName) {
    try {
        const categoryMap = {
            'ai-providers': 'ai_providers',
            'generation-params': 'generation_params',
            'app-config': 'app_config',
            'image-service': 'image_service'
        };

        const category = categoryMap[tabName];
        if (!category) return;

        const response = await fetch(`/api/config/${category}`);
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                populateTabForm(tabName, result.config);
            }
        }
    } catch (error) {
        console.error('加载配置失败:', error);
    }
}

// 填充表单数据
function populateTabForm(tabName, config) {
    const tabElement = document.getElementById(tabName);
    if (!tabElement) return;

    // 填充输入框
    tabElement.querySelectorAll('input, select, textarea').forEach(input => {
        const name = input.name;
        if (config[name] !== undefined) {
            if (input.type === 'checkbox') {
                input.checked = config[name];
            } else if (input.type === 'password') {
                // 对数据库URL等敏感字段，不回填真实值，只显示占位掩码
                if (name === 'database_url') {
                    input.value = '';
                    input.placeholder = '••••••••';
                } else {
                    if (!input.value && config[name]) {
                        input.value = config[name];
                    }
                    if (config[name]) {
                        input.placeholder = '••••••••';
                    }
                }
            } else {
                input.value = config[name];
            }
        }
    });

    // 如果是图片服务标签页，触发选项显示更新
    if (tabName === 'image-service') {
        setTimeout(() => {
            toggleImageServiceOptions();
        }, 100);
    }
}

// 带进度条的提供者测试功能
async function testProviderWithProgress(providerName) {
    if (!ProviderUtils.isValidProvider(providerName)) {
        showNotification(`无效的提供者: ${providerName}`, 'error');
        return;
    }

    const progressConfig = {
        buttonId: `test-${providerName}-btn`,
        progressId: `test-${providerName}-progress`,
        textId: `test-${providerName}-text`
    };

    const result = await ErrorHandler.handleAsyncOperation(
        () => testProviderSilently(providerName),
        `测试 ${ProviderUtils.getDisplayName(providerName)} 失败`,
        progressConfig
    );

    if (result.success) {
        const displayName = ProviderUtils.getDisplayName(providerName);
        showNotification(`${displayName} 测试成功！`, 'success');
    }
}

// AI提供者测试功能（保留原版本，用于兼容）
async function testProvider(providerName) {
    showLoading(`正在测试 ${providerName} 提供者...`);

    try {
        // 从前端页面获取配置信息
        const card = document.querySelector(`[data-provider="${providerName}"]`);
        if (!card) {
            throw new Error('找不到提供者配置卡片');
        }

        const config = {};
        const inputs = card.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.name && input.name !== 'default_provider') {
                // 获取输入的值，不管是否为空
                const value = input.value.trim();
                if (value) {
                    config[input.name] = value;
                }
            }
        });

        // 根据不同的提供者进行测试
        let testResult;
        switch (providerName) {
            case 'openai':
                testResult = await testOpenAIProvider(config);
                break;
            case 'anthropic':
                testResult = await testAnthropicProvider(config);
                break;
            case 'google':
                testResult = await testGoogleProvider(config);
                break;
            case 'azure_openai':
                testResult = await testAzureOpenAIProvider(config);
                break;
            case 'ollama':
                testResult = await testOllamaProvider(config);
                break;
            default:
                throw new Error(`不支持的提供者: ${providerName}`);
        }

        showTestResult(testResult, testResult.success);
    } catch (error) {
        showTestResult({error: error.message}, false);
    }
}

// 测试 OpenAI 提供者（仅通过后端代理）
async function testOpenAIProvider(config) {
    try {
        // 获取配置 - 使用前端页面填写的信息
        let apiKey = config.openai_api_key;
        let baseUrl = config.openai_base_url;
        let model = config.openai_model;

        // 如果前端没有填写API Key，尝试从后端获取
        if (!apiKey) {
            const configResponse = await fetch('/api/config/ai_providers');
            if (configResponse.ok) {
                const configResult = await configResponse.json();
                if (configResult.success && configResult.config.openai_api_key) {
                    apiKey = configResult.config.openai_api_key;
                }
            }
        }

        // 如果仍然没有API Key，提示用户
        if (!apiKey) {
            throw new Error('请先配置 OpenAI API Key');
        }

        // 如果没有填写 Base URL，使用默认值
        if (!baseUrl) {
            baseUrl = 'https://api.openai.com/v1';
        }

        // 如果没有填写模型，使用默认值
        if (!model) {
            model = 'gpt-4o';
        }

        // 确保 Base URL 格式正确
        if (!baseUrl.endsWith('/v1')) {
            baseUrl = baseUrl.endsWith('/') ? baseUrl + 'v1' : baseUrl + '/v1';
        }

        // 只通过后端代理测试，避免CORS问题
        const proxyResponse = await fetch('/api/ai/providers/openai/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                base_url: baseUrl,
                api_key: apiKey,
                model: model
            })
        });

        if (!proxyResponse.ok) {
            // 尝试解析错误响应
            let errorMessage = `HTTP ${proxyResponse.status}: ${proxyResponse.statusText}`;
            try {
                const errorData = await proxyResponse.json();
                if (errorData.error) {
                    errorMessage = errorData.error;
                } else if (errorData.detail) {
                    errorMessage = errorData.detail;
                } else if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (parseError) {
                // 如果无法解析错误响应，使用默认错误信息
            }
            throw new Error(errorMessage);
        }

        const proxyResult = await proxyResponse.json();

        // 处理不同的响应格式
        // 后端可能返回 status: "success" 或 success: true
        if (proxyResult.status === 'success' || proxyResult.success === true) {
            // 获取模型列表
            let models = [];
            try {
                const modelsResponse = await fetch('/api/ai/providers/openai/models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        base_url: baseUrl,
                        api_key: apiKey
                    })
                });
                if (modelsResponse.ok) {
                    const modelsResult = await modelsResponse.json();
                    if (modelsResult.success && modelsResult.models) {
                        models = modelsResult.models;
                    }
                }
            } catch (e) {
                window.__ai_log.info('获取模型列表失败，但测试仍然成功:', e);
            }

            // 标准化响应格式
            return {
                success: true,
                provider: proxyResult.provider || 'openai',
                model: proxyResult.model || model,
                models: models,
                response_preview: proxyResult.response_preview || '',
                usage: proxyResult.usage || {
                    prompt_tokens: 0,
                    completion_tokens: 0,
                    total_tokens: 0
                }
            };
        } else if (proxyResult.status === 'error' || proxyResult.success === false) {
            throw new Error(proxyResult.error || proxyResult.detail || proxyResult.message || '测试失败');
        } else {
            // 如果没有明确的状态字段，假设成功（因为HTTP状态码是200）
            return {
                success: true,
                provider: proxyResult.provider || 'openai',
                model: proxyResult.model || model,
                response_preview: proxyResult.response_preview || '',
                usage: proxyResult.usage || {
                    prompt_tokens: 0,
                    completion_tokens: 0,
                    total_tokens: 0
                }
            };
        }

    } catch (error) {
        return {
            success: false,
            error: error.message,
            detail: `OpenAI 测试失败: ${error.message}`
        };
    }
}

// 测试 Anthropic 提供者
async function testAnthropicProvider(config) {
    try {
        let apiKey = config.anthropic_api_key;
    let baseUrl = (config.anthropic_base_url || '').trim() || 'https://api.anthropic.com';
        let model = config.anthropic_model || 'claude-3-5-sonnet-20241022';

        // 如果前端没有输入API Key，尝试从后端获取
        if (!apiKey) {
            const configResponse = await fetch('/api/config/ai_providers');
            if (configResponse.ok) {
                const configResult = await configResponse.json();
                if (configResult.success && configResult.config.anthropic_api_key) {
                    apiKey = configResult.config.anthropic_api_key;
                }
            }
        }

        if (!apiKey) {
            throw new Error('请配置 Anthropic API Key');
        }

        // 调用 Anthropic API 进行测试
    // 允许自定义 Base URL（例如企业代理网关）。Anthropic 的 messages 路径位于 /v1/messages
    const endpoint = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
    const response = await fetch(`${endpoint}/v1/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
                model: model,
                messages: [
                    {
                        role: 'user',
                        content: 'Say "Hello, I am working!" in exactly 5 words.'
                    }
                ],
                max_tokens: 20
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();

        return {
            success: true,
            provider: 'anthropic',
            model: model,
            response_preview: data.content[0].text,
            usage: {
                prompt_tokens: data.usage?.input_tokens || 0,
                completion_tokens: data.usage?.output_tokens || 0,
                total_tokens: (data.usage?.input_tokens || 0) + (data.usage?.output_tokens || 0)
            }
        };
    } catch (error) {
        return {
            success: false,
            error: error.message,
            detail: `Anthropic 测试失败: ${error.message}`
        };
    }
}

// 测试 Google 提供者
async function testGoogleProvider(config) {
    try {
        let apiKey = config.google_api_key;
    let baseUrl = (config.google_base_url || '').trim() || 'https://generativelanguage.googleapis.com';
        let model = config.google_model || 'gemini-1.5-flash';

        // 如果前端没有输入API Key，尝试从后端获取
        if (!apiKey) {
            const configResponse = await fetch('/api/config/ai_providers');
            if (configResponse.ok) {
                const configResult = await configResponse.json();
                if (configResult.success && configResult.config.google_api_key) {
                    apiKey = configResult.config.google_api_key;
                }
            }
        }

        if (!apiKey) {
            throw new Error('请配置 Google API Key');
        }

        // 调用 Google Gemini API 进行测试
    // 允许自定义 Base URL（例如代理服务）。Google Gemini REST 路径通常为 /v1beta/models/...:generateContent
    const gbase = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
    const response = await fetch(`${gbase}/v1beta/models/${model}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [
                    {
                        parts: [
                            {
                                text: 'Say "Hello, I am working!" in exactly 5 words.'
                            }
                        ]
                    }
                ],
                generationConfig: {
                    maxOutputTokens: 20,
                    temperature: 0
                }
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();

        return {
            success: true,
            provider: 'google',
            model: model,
            response_preview: data.candidates[0].content.parts[0].text,
            usage: {
                prompt_tokens: data.usageMetadata?.promptTokenCount || 0,
                completion_tokens: data.usageMetadata?.candidatesTokenCount || 0,
                total_tokens: data.usageMetadata?.totalTokenCount || 0
            }
        };
    } catch (error) {
        return {
            success: false,
            error: error.message,
            detail: `Google Gemini 测试失败: ${error.message}`
        };
    }
}

// 测试 Azure OpenAI 提供者
async function testAzureOpenAIProvider(config) {
    try {
        let apiKey = config.azure_openai_api_key;
        let endpoint = config.azure_openai_endpoint;
        let deploymentName = config.azure_openai_deployment_name;
        let apiVersion = config.azure_openai_api_version || '2024-02-15-preview';

        // 如果前端没有输入，尝试从后端获取
        if (!apiKey || !endpoint || !deploymentName) {
            const configResponse = await fetch('/api/config/ai_providers');
            if (configResponse.ok) {
                const configResult = await configResponse.json();
                if (configResult.success) {
                    apiKey = apiKey || configResult.config.azure_openai_api_key;
                    endpoint = endpoint || configResult.config.azure_openai_endpoint;
                    deploymentName = deploymentName || configResult.config.azure_openai_deployment_name;
                }
            }
        }

        if (!apiKey || !endpoint || !deploymentName) {
            throw new Error('请配置 Azure OpenAI 的所有必需参数');
        }

        // 确保 endpoint 格式正确
        if (!endpoint.endsWith('/')) {
            endpoint += '/';
        }

        // 调用 Azure OpenAI API 进行测试
        const url = `${endpoint}openai/deployments/${deploymentName}/chat/completions?api-version=${apiVersion}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'api-key': apiKey
            },
            body: JSON.stringify({
                messages: [
                    {
                        role: 'user',
                        content: 'Say "Hello, I am working!" in exactly 5 words.'
                    }
                ],
                max_tokens: 20,
                temperature: 0
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();

        return {
            success: true,
            provider: 'azure_openai',
            model: deploymentName,
            response_preview: data.choices[0].message.content,
            usage: data.usage || {
                prompt_tokens: 0,
                completion_tokens: 0,
                total_tokens: 0
            }
        };
    } catch (error) {
        return {
            success: false,
            error: error.message,
            detail: `Azure OpenAI 测试失败: ${error.message}`
        };
    }
}

// 测试 Ollama 提供者
async function testOllamaProvider(config) {
    try {
        let baseUrl = (config.ollama_base_url || 'http://localhost:11434').trim();
        let model = config.ollama_model || 'llama2';

        // Basic validation: only allow http/https schemes
        try {
            const u = new URL(baseUrl);
            if (u.protocol !== 'http:' && u.protocol !== 'https:') {
                throw new Error('Invalid URL scheme');
            }
        } catch (e) {
            return { success: false, provider: 'ollama', error: '无效的 base URL' };
        }

        // Call backend proxy which validates and performs the request server-side
        const proxyResp = await fetch('/api/ai/providers/ollama/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ base_url: baseUrl, model: model })
        });

        if (!proxyResp.ok) {
            let errMsg = `HTTP ${proxyResp.status}`;
            try {
                const errJson = await proxyResp.json();
                errMsg = errJson.error || errJson.detail || errMsg;
            } catch (e) {}

            // 处理认证错误
            if (proxyResp.status === 401) {
                throw new Error('请先登录后再测试AI提供商');
            }

            throw new Error(errMsg);
        }

        const proxyResult = await proxyResp.json();
        if (!proxyResult.success) {
            throw new Error(proxyResult.error || proxyResult.detail || '测试失败');
        }

        return {
            success: true,
            provider: 'ollama',
            model: model,
            response_preview: proxyResult.response_preview || '',
        };
    } catch (error) {
        // Ollama 可能未运行或无法连接
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            return {
                success: false,
                provider: 'ollama',
                error: 'Ollama 服务未运行或无法连接',
                detail: `请确保 Ollama 正在运行并可以通过 ${config.ollama_base_url || 'http://localhost:11434'} 访问`
            };
        }
        return {
            success: false,
            provider: 'ollama',
            error: error.message,
            detail: `Ollama 测试失败: ${error.message}`
        };
    }
}

async function testCurrentProvider() {
    // 显示进度条
    showButtonProgress('test-current-btn', 'test-current-progress', 'test-current-text');

    try {
        // 1) 优先从顶部下拉读取
        const selectEl = document.getElementById('current-provider-select');
        let currentProvider = (selectEl && selectEl.value) ? selectEl.value.trim() : '';

        // 2) 再尝试调用API（若已登录）
        if (!currentProvider) {
            try {
                const response = await fetch('/api/config/current-provider');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.current_provider) {
                        currentProvider = result.current_provider;
                    }
                }
            } catch (error) {
                console.warn('获取当前提供者失败:', error);
            }
        }

        // 3) 最后回退到模板默认
        if (!currentProvider) {
            const fallback = (typeof defaultProviderTemplate === 'string' && defaultProviderTemplate) ? defaultProviderTemplate : '';
            if (fallback) currentProvider = fallback;
        }

    if (!currentProvider) {
        showNotification('请先在上方下拉框选择一个“当前提供者”', 'error');
        return;
    }

    // 获取当前选择的模型
    const modelSelect = document.getElementById('current_model_select');
    const selectedModel = modelSelect && modelSelect.value ? modelSelect.value : null;

    // 如果选择了模型，先保存配置再测试
    if (selectedModel) {
        window.__ai_log.info(`使用提供者 ${currentProvider} 和模型 ${selectedModel} 进行测试`);

        // 构建配置对象
        const config = {};
        if (currentProvider === 'azure_openai') {
            config['azure_openai_deployment_name'] = selectedModel;
        } else {
            config[currentProvider + '_model'] = selectedModel;
        }

        // 保存模型配置
        try {
            const saveResponse = await fetch('/api/config/all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    config: config
                })
            });

            if (!saveResponse.ok) {
                throw new Error(`保存配置失败: HTTP ${saveResponse.status}`);
            }

            const saveResult = await saveResponse.json();
            if (!saveResult.success) {
                throw new Error(saveResult.message || '保存配置失败');
            }

            window.__ai_log.info('模型配置已保存');
        } catch (error) {
            console.warn('保存模型配置失败:', error);
            // 继续测试，即使保存失败
        }
    }

    // 测试提供者
    const testSuccess = await testProviderSilently(currentProvider);

    if (testSuccess) {
        const modelInfo = selectedModel ? ` (模型: ${selectedModel})` : '';
        showNotification(`${currentProvider} 测试成功！${modelInfo}`, 'success');

        // 更新状态显示
        updateProviderStatusDisplay(currentProvider, true);
    } else {
        const modelInfo = selectedModel ? ` (模型: ${selectedModel})` : '';
        showNotification(`${currentProvider} 测试失败${modelInfo}`, 'error');
    }

    } catch (error) {
        console.error('测试当前提供者失败:', error);
        showNotification('测试失败: ' + error.message, 'error');
    } finally {
        // 隐藏进度条
        hideButtonProgress('test-current-btn', 'test-current-progress', 'test-current-text');
    }
}

async function refreshProviders() {
    const progressConfig = {
        buttonId: 'refresh-providers-btn',
        progressId: 'refresh-providers-progress',
        textId: 'refresh-providers-text'
    };

    const result = await ErrorHandler.handleAsyncOperation(
        async () => {
            // 首先清除所有测试缓存
            clearTestCache();
            window.__ai_log.info('已清除所有测试缓存');

            // 测试所有已配置的提供者
            await testAllConfiguredProviders();

            // 重新初始化当前提供者下拉框
            await initCurrentProviderSelect();

            // 返回可用提供者数量
            return getAvailableProviders().length;
        },
        '重新测试提供者失败',
        progressConfig
    );

    if (result.success) {
        showNotification(`测试完成！可用提供者: ${result.data} 个`, 'success');
    }
}

// 测试所有已配置的提供者
async function testAllConfiguredProviders() {
    const configuredProviders = [];

    window.__ai_log.info('开始测试所有已配置的提供者...');

    // 首先检查哪些提供者已配置
    for (const provider of AVAILABLE_PROVIDERS) {
        const isConfigured = isProviderConfigured(provider);
    window.__ai_log.info(`检查提供者 ${provider}: ${isConfigured ? '已配置' : '未配置'}`);

        if (isConfigured) {
            configuredProviders.push(provider);
            window.__ai_log.info(`发现已配置的提供者: ${provider}`);
        } else {
            window.__ai_log.info(`跳过未配置的提供者: ${provider}`);
            // 未配置的提供者设置为不可用
            updateProviderStatusDisplay(provider, false);
            cacheTestResult(provider, false);
        }
    }

    if (configuredProviders.length === 0) {
    window.__ai_log.info('没有找到已配置的提供者');
        return;
    }

    // 并行化测试（有限并发），避免顺序阻塞页面交互
    const maxConcurrent = 3;
    let running = 0;
    let index = 0;

    const runNext = async () => {
        if (index >= configuredProviders.length) return;
        const provider = configuredProviders[index++];
        running++;
        try {
            await testProviderSilently(provider);
        } catch (error) {
            console.error(`测试 ${provider} 时出错:`, error);
        } finally {
            running--;
            // schedule next in next tick to yield to UI
            setTimeout(runNext, 0);
        }
    };

    // 启动初始并发任务
    for (let k = 0; k < Math.min(maxConcurrent, configuredProviders.length); k++) {
        runNext();
    }

    // 等待所有完成（轮询式）
    const waitForAll = () => new Promise(resolve => {
        const check = () => {
            if (running === 0 && index >= configuredProviders.length) return resolve();
            setTimeout(check, 150);
        };
        check();
    });

    await waitForAll();
    window.__ai_log.info('所有提供者测试完成');
}

// 检查提供者是否已配置（直接从页面表单读取）
function isProviderConfigured(providerName) {
    const card = document.querySelector(`[data-provider="${providerName}"]`);
    if (!card) {
    window.__ai_log.info(`${providerName}: 找不到配置卡片`);
        return false;
    }

    // 从表单获取配置
    const config = {};
    const inputs = card.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.name && input.name !== 'default_provider') {
            const value = input.value.trim();
            if (value) {
                config[input.name] = value;
            }
        }
    });

    window.__ai_log.info(`${providerName} 配置:`, config);

    // 检查必要的配置字段
    let result = false;
    switch (providerName) {
        case 'openai':
            // OpenAI只需要API Key，Base URL有默认值
            result = !!config.openai_api_key;
            window.__ai_log.info(`${providerName}: API Key=${!!config.openai_api_key}, Base URL=${!!config.openai_base_url || '有默认值'}`);
            break;
        case 'anthropic':
            // Anthropic只需要API Key，Base URL有默认值
            result = !!config.anthropic_api_key;
            window.__ai_log.info(`${providerName}: API Key=${!!config.anthropic_api_key}`);
            break;
        case 'google':
            // Google只需要API Key，Base URL有默认值
            result = !!config.google_api_key;
            window.__ai_log.info(`${providerName}: API Key=${!!config.google_api_key}, Base URL=${!!config.google_base_url || '有默认值'}`);
            break;
        case 'azure_openai':
            result = !!(config.azure_openai_api_key && config.azure_openai_endpoint);
            window.__ai_log.info(`${providerName}: API Key=${!!config.azure_openai_api_key}, Endpoint=${!!config.azure_openai_endpoint}`);
            break;
        case 'ollama':
            // Ollama只需要Base URL，有默认值
            result = true; // Ollama总是可用，因为有默认的localhost地址
            window.__ai_log.info(`${providerName}: Base URL=${!!config.ollama_base_url || '有默认值'}`);
            break;
        default:
            window.__ai_log.info(`${providerName}: 不支持的提供者`);
            return false;
    }

    window.__ai_log.info(`${providerName} 配置检查结果: ${result}`);
    return result;
}

// 静默测试提供者（不显示弹窗）
async function testProviderSilently(providerName) {
    try {
        // 从配置获取提供者信息
        const card = document.querySelector(`[data-provider="${providerName}"]`);
        if (!card) {
            throw new Error('找不到提供者配置卡片');
        }

        const config = {};
        const inputs = card.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.name && input.name !== 'default_provider') {
                const value = input.value.trim();
                if (value) {
                    config[input.name] = value;
                }
            }
        });

        // 根据不同的提供者进行测试
        let testResult;
        switch (providerName) {
            case 'openai':
                testResult = await testOpenAIProvider(config);
                break;
            case 'anthropic':
                testResult = await testAnthropicProvider(config);
                break;
            case 'google':
                testResult = await testGoogleProvider(config);
                break;
            case 'azure_openai':
                testResult = await testAzureOpenAIProvider(config);
                break;
            case 'ollama':
                testResult = await testOllamaProvider(config);
                break;
            default:
                throw new Error(`不支持的提供者: ${providerName}`);
        }

        // 更新状态显示和缓存
        if (testResult.success) {
            updateProviderStatusDisplay(providerName, true);
            cacheTestResult(providerName, true);
            window.__ai_log.info(`${providerName} 测试成功`);
        } else {
            updateProviderStatusDisplay(providerName, false);
            cacheTestResult(providerName, false);
            window.__ai_log.info(`${providerName} 测试失败:`, testResult.error || testResult.detail);
        }

        return testResult;
    } catch (error) {
        console.error(`${providerName} 测试出错:`, error);
        updateProviderStatusDisplay(providerName, false);
        cacheTestResult(providerName, false);
        return { success: false, error: error.message };
    }
}

// 配置管理功能
async function loadAllConfigs() {
    const result = await ApiUtils.fetchConfig(API_ENDPOINTS.config_all);
    if (result) {
        currentConfig = result.config;
        populateAllForms();
    } else {
        console.error('加载配置失败');
    }
}

function populateAllForms() {
    // 填充AI提供者配置
    populateProviderForms();

    // 填充生成参数
    populateGenerationParams();

    // 填充应用配置
    populateAppConfig();

    // 填充图片服务配置
    populateImageServiceConfig();
}

function populateProviderForms() {
    document.querySelectorAll('.provider-config-card').forEach(card => {
        const provider = card.dataset.provider;
        const inputs = card.querySelectorAll('input, select');

        inputs.forEach(input => {
            const configKey = input.name;
            if (currentConfig[configKey]) {
                if (input.type === 'checkbox') {
                    input.checked = currentConfig[configKey] === 'true';
                } else if (input.type === 'password') {
                    // 对于密码字段，如果有配置值且输入框为空，则显示配置值
                    if (!input.value && currentConfig[configKey]) {
                        input.value = currentConfig[configKey];
                    }
                    // 如果有配置值，更新placeholder为掩码显示
                    if (currentConfig[configKey]) {
                        input.placeholder = '••••••••';
                    }
                } else {
                    // 只有当输入框为空时才设置值，避免覆盖模板中已设置的值
                    if (!input.value && currentConfig[configKey]) {
                        input.value = currentConfig[configKey];
                    }
                }
            }
        });
    });
}

function populateGenerationParams() {
    const tab = document.getElementById('generation-params');
    if (!tab) return;

    const inputs = tab.querySelectorAll('input, select');
    inputs.forEach(input => {
        const configKey = input.name;
        if (currentConfig[configKey]) {
            if (input.type === 'checkbox') {
                input.checked = currentConfig[configKey] === 'true';
            } else if (input.type === 'password') {
                // 对于密码字段，如果有配置值且输入框为空，则显示配置值
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
                // 如果有配置值，更新placeholder为掩码显示
                if (currentConfig[configKey]) {
                    input.placeholder = '••••••••';
                }
            } else {
                // 只有当输入框为空时才设置值，避免覆盖模板中已设置的值
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
            }
        }
    });
}



function populateAppConfig() {
    const tab = document.getElementById('app-config');
    if (!tab) return;

    const inputs = tab.querySelectorAll('input, select');
    inputs.forEach(input => {
        const configKey = input.name;
        if (currentConfig[configKey]) {
            if (input.type === 'checkbox') {
                input.checked = currentConfig[configKey] === 'true';
            } else if (input.type === 'password') {
                // 对于密码字段，如果有配置值且输入框为空，则显示配置值
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
                // 如果有配置值，更新placeholder为掩码显示
                if (currentConfig[configKey]) {
                    input.placeholder = '••••••••';
                }
            } else {
                // 只有当输入框为空时才设置值，避免覆盖模板中已设置的值
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
            }
        }
    });
}

function populateImageServiceConfig() {
    const tab = document.getElementById('image-service');
    if (!tab) return;

    const inputs = tab.querySelectorAll('input, select');
    inputs.forEach(input => {
        const configKey = input.name;
        if (currentConfig[configKey] !== undefined) {
            if (input.type === 'checkbox') {
                input.checked = currentConfig[configKey] === 'true' || currentConfig[configKey] === true;
            } else if (input.type === 'password') {
                // 对于密码字段，如果有配置值且输入框为空，则显示配置值
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
                // 如果有配置值，更新placeholder为掩码显示
                if (currentConfig[configKey]) {
                    input.placeholder = '••••••••';
                }
            } else {
                // 只有当输入框为空时才设置值，避免覆盖模板中已设置的值
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
            }
        }
    });

    // 触发图片服务选项显示更新
    setTimeout(() => {
        toggleImageServiceOptions();
    }, 100);
}

// 设置默认提供者
async function setDefaultProvider(provider) {
    try {
        // 不显示loading，因为这是一个快速操作
        const response = await fetch('/api/config/default-provider', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ provider: provider })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification(`默认提供者已设置为 ${provider}`, 'success');

                // 更新页面显示的当前提供者
                updateCurrentProviderDisplay(provider);

                // 更新顶部状态显示
                updateTopStatusDisplay(provider);

                // 更新模型选择框
                loadCurrentProviderModels(provider);

                // 不需要刷新整个页面，只更新显示即可
            } else {
                showNotification('设置默认提供者失败: ' + (result.message || '未知错误'), 'error');
            }
// 应用顶部“当前提供者”下拉到系统默认提供者
async function applyCurrentProviderSelect() {
    const selectEl = document.getElementById('current-provider-select');
    if (!selectEl || !selectEl.value) {
        showNotification('请先在下拉框选择一个提供者', 'error');
        return;
    }
    await setDefaultProvider(selectEl.value);
}

        } else {
            showNotification('设置默认提供者失败', 'error');
        }
    } catch (error) {
        showNotification('设置默认提供者失败: ' + error.message, 'error');
    }
}

// 应用顶部“当前提供者”下拉到系统默认提供者
async function applyCurrentProviderSelect() {
    const selectEl = document.getElementById('current-provider-select');
    if (!selectEl || !selectEl.value) {
        showNotification('请先在下拉框选择一个提供者', 'error');
        return;
    }
    await setDefaultProvider(selectEl.value);
}

// 更新当前提供者显示
function updateCurrentProviderDisplay(provider) {
    // 更新当前提供者下拉框
    const currentProviderSelect = document.getElementById('current-provider-select');
    if (currentProviderSelect) {
        currentProviderSelect.value = provider;
    }

    // 同时更新所有单选框的选中状态
    document.querySelectorAll('input[name="default_provider"]').forEach(radio => {
        radio.checked = (radio.value === provider);
    });
}

// 更新顶部状态显示
function updateTopStatusDisplay(provider) {
    // 检查提供者是否有缓存的测试结果
    const cachedResult = getCachedTestResult(provider);

    let isAvailable = false;
    if (cachedResult) {
        // 如果有缓存结果，使用缓存结果
        isAvailable = cachedResult.success;
    } else {
        // 如果没有缓存结果，检查提供者卡片的当前状态
        const providerCard = document.querySelector(`[data-provider="${provider}"]`);
        if (providerCard) {
            const statusSpan = providerCard.querySelector('span[style*="background: var(--success-gradient)"]');
            isAvailable = statusSpan && statusSpan.innerHTML.includes('✅');
        }
    }

    // 更新状态文本
    const statusElement = document.getElementById('current-provider-status');
    if (statusElement) {
        if (isAvailable) {
            statusElement.innerHTML = '<span style="color: #27ae60;">✅ 正常运行</span>';
        } else {
            statusElement.innerHTML = '<span style="color: #f39c12;">⏳ 待测试</span>';
        }
    }
}

// 初始化顶部状态显示
async function initTopStatusDisplay() {
    // 从API获取当前默认提供者
    let currentProvider = null;

    try {
        const response = await fetch('/api/config/current-provider');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                currentProvider = result.current_provider;
            }
        }
    } catch (error) {
        console.warn('获取当前提供者失败:', error);
        return;
    }

    if (!currentProvider) {
        return;
    }

    // 检查是否有缓存的测试结果
    const cachedResult = getCachedTestResult(currentProvider);
    if (cachedResult) {
        // 如果有缓存结果，使用缓存结果更新状态
        updateTopStatusDisplay(currentProvider);
    } else {
        // 如果没有缓存结果，显示待测试状态
        const statusElement = document.querySelector('#current-provider-status');
        if (statusElement) {
            statusElement.innerHTML = '<span style="color: #f39c12;">⏳ 待测试</span>';
        }
    }
}

// 带进度条的保存提供者配置
async function saveProviderConfigWithProgress(provider) {
    if (!ProviderUtils.isValidProvider(provider)) {
        showNotification(`无效的提供者: ${provider}`, 'error');
        return;
    }

    const progressConfig = {
        buttonId: `save-${provider}-btn`,
        progressId: `save-${provider}-progress`,
        textId: `save-${provider}-text`
    };

    const result = await ErrorHandler.handleAsyncOperation(
        () => saveProviderConfigSilently(provider),
        `保存 ${ProviderUtils.getDisplayName(provider)} 配置失败`,
        progressConfig
    );

    if (result.success) {
        const displayName = ProviderUtils.getDisplayName(provider);
        showNotification(`${displayName} 配置保存成功，已实时生效`, 'success');

        // 重新加载配置
        await loadAllConfigs();
        // 重新初始化提供者下拉框以更新可用性
        setTimeout(async () => {
            await initCurrentProviderSelect();
        }, 100);
    }
}

// 保存提供者配置（原函数，保持向后兼容）
async function saveProviderConfig(provider) {
    const card = document.querySelector(`[data-provider="${provider}"]`);
    if (!card) return;

    const config = {};
    const inputs = card.querySelectorAll('input, select');

    inputs.forEach(input => {
        if (input.name && input.value) {
            // 跳过 default_provider radio 按钮，因为它通过专门的 API 处理
            if (input.name === 'default_provider') {
                return;
            }
            config[input.name] = input.value;
        }
    });

    try {
        showLoading(`正在保存 ${provider} 配置...`);

        const response = await fetch('/api/config/ai_providers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification(`${provider} 配置保存成功，已实时生效`, 'success');
                // 重新加载配置
                await loadAllConfigs();
                // 重新初始化提供者下拉框以更新可用性
                setTimeout(async () => {
                    await initCurrentProviderSelect();
                }, 100);
            } else {
                showNotification(`${provider} 配置保存失败: ${result.errors || '未知错误'}`, 'error');
            }
        } else {
            showNotification(`${provider} 配置保存失败`, 'error');
        }

        closeTestModal();
    } catch (error) {
        showNotification('保存配置失败: ' + error.message, 'error');
        closeTestModal();
    }
}

// 保存生成参数
async function saveGenerationParams() {
    const tab = document.getElementById('generation-params');
    if (!tab) return;

    const config = {};
    const inputs = tab.querySelectorAll('input, select');

    inputs.forEach(input => {
        if (input.name) {
            if (input.type === 'checkbox') {
                config[input.name] = input.checked;
            } else if (input.value) {
                config[input.name] = input.value;
            }
        }
    });

    try {
        const response = await fetch('/api/config/category/generation_params', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('生成参数保存成功，已实时生效', 'success');
                // 重新加载配置
                loadAllConfigs();
            } else {
                showNotification('生成参数保存失败: ' + (result.errors || '未知错误'), 'error');
            }
        } else {
            showNotification('生成参数保存失败', 'error');
        }
    } catch (error) {
        showNotification('保存失败: ' + error.message, 'error');
    }
}



// 保存应用配置
async function saveAppConfig() {
    const tab = document.getElementById('app-config');
    if (!tab) return;

    const config = {};
    const inputs = tab.querySelectorAll('input, select');

    inputs.forEach(input => {
        if (input.name) {
            if (input.type === 'checkbox') {
                config[input.name] = input.checked;
            } else if (input.value) {
                config[input.name] = input.value;
            }
        }
    });

    try {
        const response = await fetch('/api/config/category/app_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('应用配置保存成功，已实时生效', 'success');
                // 重新加载配置
                loadAllConfigs();
            } else {
                showNotification('应用配置保存失败: ' + (result.errors || '未知错误'), 'error');
            }
        } else {
            showNotification('应用配置保存失败', 'error');
        }
    } catch (error) {
        showNotification('保存失败: ' + error.message, 'error');
    }
}

// 保存所有配置
async function saveAllConfigs() {
    showLoading('正在保存所有配置...');

    try {
        // 收集所有配置
        const allConfig = {};

        // 收集AI提供者配置
        document.querySelectorAll('.provider-config-card').forEach(card => {
            const inputs = card.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.name && input.value) {
                    // 跳过 default_provider radio 按钮，因为它通过专门的 API 处理
                    if (input.name === 'default_provider') {
                        return;
                    }
                    allConfig[input.name] = input.value;
                }
            });
        });

        // 收集其他配置
        ['generation-params', 'app-config'].forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) {
                const inputs = tab.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.name) {
                        if (input.type === 'checkbox') {
                            allConfig[input.name] = input.checked;
                        } else if (input.value) {
                            allConfig[input.name] = input.value;
                        }
                    }
                });
            }
        });

        const response = await fetch('/api/config/all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: allConfig })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('所有配置保存成功', 'success');
            } else {
                showNotification('配置保存失败: ' + (result.errors || '未知错误'), 'error');
            }
            closeTestModal();
        } else {
            showNotification('配置保存失败', 'error');
            closeTestModal();
        }
    } catch (error) {
        showNotification('保存失败: ' + error.message, 'error');
        closeTestModal();
    }
}











// 通知功能
function showNotification(message, type = 'info') {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;

    // 设置背景颜色
    switch (type) {
        case 'success':
            notification.style.background = 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)';
            break;
        case 'error':
            notification.style.background = 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';
            break;
        case 'warning':
            notification.style.background = 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';
            break;
        default:
            notification.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
    }

    notification.textContent = message;
    document.body.appendChild(notification);

    // 显示动画
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);

    // 自动隐藏
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function showLoading(message) {
    document.getElementById('testResults').innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 2em; margin-bottom: 10px;">⏳</div>
            <p>${message}</p>
        </div>
    `;
    document.getElementById('testModal').style.display = 'block';
}

function hideLoading() {
    const testResults = document.getElementById('testResults');
    if (testResults) {
        testResults.innerHTML = '';
    }
}

function showTestResult(result, success) {
    const statusIcon = success ? '✅' : '❌';
    const statusColor = success ? '#27ae60' : '#e74c3c';

    let content = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">${statusIcon}</div>
            <h4 style="color: ${statusColor};">${success ? '测试成功' : '测试失败'}</h4>
        </div>
    `;

    if (success) {
        content += `
            <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 8px;">
                <p style="color: var(--text-primary);"><strong>提供者:</strong> ${result.provider}</p>
                <p style="color: var(--text-primary);"><strong>模型:</strong> ${result.model}</p>
                <p style="color: var(--text-primary);"><strong>响应预览:</strong></p>
                <div style="background: var(--bg-secondary); border: 1px solid var(--glass-border); padding: 15px; border-radius: 5px; margin-top: 10px; font-family: monospace; font-size: 0.9em; color: var(--text-primary);">
                    ${result.response_preview}
                </div>
                <p style="margin-top: 15px; color: var(--text-primary);"><strong>使用统计:</strong></p>
                <ul style="margin-left: 20px; color: var(--text-primary);">
                    <li>提示词令牌: ${result.usage.prompt_tokens}</li>
                    <li>完成令牌: ${result.usage.completion_tokens}</li>
                    <li>总令牌: ${result.usage.total_tokens}</li>
                </ul>
            </div>
        `;
    } else {
        content += `
            <div style="background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); padding: 20px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                <p style="color: var(--text-primary);"><strong>错误信息:</strong></p>
                <div style="background: var(--bg-secondary); border: 1px solid var(--glass-border); padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9em; color: var(--text-primary);">
                    ${result.detail || result.error || '未知错误'}
                </div>
            </div>
        `;
    }

    document.getElementById('testResults').innerHTML = content;
    document.getElementById('testModal').style.display = 'block';

    // 如果测试成功，更新提供者状态显示并保存配置
    if (success && result.provider) {
        updateProviderStatusDisplay(result.provider, true);

        // 缓存测试结果
        cacheTestResult(result.provider, true);

        // 自动获取模型列表（如果支持）
        if (result.provider === 'openai' && result.models) {
            updateModelDropdown(result.provider, result.models);
        }

        // 自动保存配置以持久化状态
        setTimeout(() => {
            saveProviderConfigSilently(result.provider);
        }, 500);
    } else if (result.provider) {
        // 测试失败时更新状态显示
        updateProviderStatusDisplay(result.provider, false);

        // 测试失败也要缓存结果
        cacheTestResult(result.provider, false);
    }
}

function showAllTestResults(results) {
    let content = '<div style="margin-bottom: 20px;">';

    results.forEach(({provider, result, success}) => {
        const statusIcon = success ? '✅' : '❌';
        const statusColor = success ? '#27ae60' : '#e74c3c';

        content += `
            <div style="border: 1px solid var(--glass-border); background: var(--glass-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: var(--text-primary);">${provider}</strong>
                    <span style="color: ${statusColor};">${statusIcon} ${success ? '成功' : '失败'}</span>
                </div>
                ${success ?
                    `<p style="color: var(--text-secondary); font-size: 0.9em;">模型: ${result.model} | 响应: ${result.response_preview.substring(0, 50)}...</p>` :
                    `<p style="color: #e74c3c; font-size: 0.9em;">错误: ${result.detail || result.error}</p>`
                }
            </div>
        `;

        // 更新提供者状态显示并保存配置
        if (success) {
            updateProviderStatusDisplay(provider, true);

            // 缓存测试结果
            cacheTestResult(provider, true);

            // 自动保存配置以持久化状态
            setTimeout(() => {
                saveProviderConfigSilently(provider);
            }, 500);
        } else {
            // 测试失败时更新状态显示
            updateProviderStatusDisplay(provider, false);

            // 测试失败也要缓存结果
            cacheTestResult(provider, false);
        }
    });

    content += '</div>';

    document.getElementById('testResults').innerHTML = content;
    document.getElementById('testModal').style.display = 'block';
}

function closeTestModal() {
    document.getElementById('testModal').style.display = 'none';
}

// 更新提供者状态显示
function updateProviderStatusDisplay(provider, isAvailable) {
    const providerCard = document.querySelector(`[data-provider="${provider}"]`);
    if (!providerCard) return;

    const statusSpan = providerCard.querySelector('span[style*="background: var(--success-gradient)"], span[style*="background: var(--secondary-gradient)"]');
    if (statusSpan) {
        if (isAvailable) {
            statusSpan.style.background = 'var(--success-gradient)';
            statusSpan.innerHTML = '✅ 可用';
        } else {
            statusSpan.style.background = 'var(--secondary-gradient)';
            statusSpan.innerHTML = '❌ 不可用';
        }
    }
}

// 静默保存提供者配置（不显示通知）
async function saveProviderConfigSilently(provider) {
    const card = document.querySelector(`[data-provider="${provider}"]`);
    if (!card) {
        throw new Error('找不到提供者配置卡片');
    }

    const config = {};
    const inputs = card.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.name && input.name !== 'default_provider') {
            config[input.name] = input.value;
        }
    });

    const result = await ApiUtils.saveConfig(API_ENDPOINTS.config_ai_providers, config);
    if (!result) {
        throw new Error('保存配置失败');
    }

    window.__ai_log.info(`${provider} 配置已静默保存`);
    return result;
}

// 缓存测试结果到localStorage
function cacheTestResult(provider, success) {
    const cacheKey = `test_result_${provider}`;
    const result = {
        success: success,
        timestamp: Date.now(),
        expires: Date.now() + (60 * 60 * 1000) // 1小时过期
    };
    localStorage.setItem(cacheKey, JSON.stringify(result));
    providerTestCache.set(provider, result);
}

// 从localStorage加载缓存的测试结果
function loadCachedTestResults() {
    window.__ai_log.info('正在加载缓存的测试结果...');
    AVAILABLE_PROVIDERS.forEach(provider => {
        const cacheKey = `test_result_${provider}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            try {
                const result = JSON.parse(cached);
                // 检查是否过期
                if (result.expires > Date.now()) {
                    providerTestCache.set(provider, result);
                    window.__ai_log.info(`恢复 ${provider} 的缓存状态:`, result.success ? '可用' : '不可用');
                    // 更新UI显示
                    updateProviderStatusDisplay(provider, result.success);
                } else {
                    window.__ai_log.info(`${provider} 的缓存已过期，清除`);
                    // 清除过期的缓存
                    localStorage.removeItem(cacheKey);
                }
            } catch (e) {
                console.error(`Failed to parse cached result for ${provider}:`, e);
                localStorage.removeItem(cacheKey);
            }
        } else {
            window.__ai_log.info(`${provider} 没有缓存的测试结果`);
        }
    });
}

// 获取缓存的测试结果
function getCachedTestResult(provider) {
    return providerTestCache.get(provider);
}

// 清除所有测试缓存
function clearTestCache() {
    const providers = ['openai', 'anthropic', 'google', 'azure_openai', 'ollama'];
    providers.forEach(provider => {
        const cacheKey = `test_result_${provider}`;
        localStorage.removeItem(cacheKey);
        providerTestCache.delete(provider);
        // 重置UI状态为未测试
        updateProviderStatusDisplay(provider, false);
    });

    // 重新初始化当前提供者选择
    initCurrentProviderSelect();

    window.__ai_log.info('所有测试缓存已清除');
}

// 重置所有提供者状态为未测试状态
function resetAllProviderStatus() {
    AVAILABLE_PROVIDERS.forEach(provider => {
        const cachedResult = getCachedTestResult(provider);
        if (!cachedResult) {
            // 如果没有缓存结果，设置为未测试状态
            updateProviderStatusDisplay(provider, false);
        }
    });
}

// 更新模型下拉列表
function updateModelDropdown(provider, models) {
    if (provider === 'openai' && models && models.length > 0) {
        const modelSelect = document.getElementById('openai_model_select');
        const modelInput = document.getElementById('openai_model_input');

        if (modelSelect && modelInput) {
            // 清空现有选项
            modelSelect.innerHTML = '';

            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '选择模型...';
            modelSelect.appendChild(defaultOption);

            // 添加模型选项
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.id;
                modelSelect.appendChild(option);
            });

            // 显示下拉列表，隐藏输入框
            modelSelect.style.display = 'block';
            modelInput.style.display = 'none';

            // 如果当前输入框有值，在下拉列表中选中对应项
            const currentModel = modelInput.value;
            if (currentModel) {
                modelSelect.value = currentModel;
            }

            // 添加change事件监听器，同步值到输入框
            modelSelect.onchange = function() {
                modelInput.value = this.value;
                if (this.value) {
                    // 如果选择了模型，可以隐藏下拉列表，显示输入框
                    this.style.display = 'none';
                    modelInput.style.display = 'block';
                }
            };

            window.__ai_log.info(`已更新 ${provider} 的模型列表，共 ${models.length} 个模型`);
        }
    }
}

// Close modal when clicking outside
document.getElementById('testModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTestModal();
    }
});

// 图片服务相关功能
async function checkImageServiceStatus() {
    try {
        const response = await fetch('/api/image/status');
        if (response.ok) {
            const result = await response.json();
            updateImageServiceStatus(result);
        } else {
            updateImageServiceStatus({
                status: 'error',
                available_providers: [],
                message: '无法连接到图片服务'
            });
        }
    } catch (error) {
        updateImageServiceStatus({
            status: 'error',
            available_providers: [],
            message: '检查图片服务状态失败: ' + error.message
        });
    }
}

function updateImageServiceStatus(status) {
    const statusElement = document.getElementById('image-service-status');
    const providersElement = document.getElementById('available-image-providers');

    if (statusElement) {
        if (status.status === 'ok' && status.available_providers.length > 0) {
            statusElement.textContent = '✅ 正常运行';
            statusElement.style.background = '#27ae60';
        } else {
            statusElement.textContent = '❌ 服务异常';
            statusElement.style.background = '#e74c3c';
        }
    }

    if (providersElement) {
        if (status.available_providers && status.available_providers.length > 0) {
            providersElement.textContent = status.available_providers.join(', ') + ` (${status.available_providers.length}个)`;
        } else {
            providersElement.textContent = '无可用提供者';
        }
    }
}

function showImageTestResult(result, success) {
    const statusIcon = success ? '✅' : '❌';
    const statusColor = success ? '#27ae60' : '#e74c3c';

    let content = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">${statusIcon}</div>
            <h4 style="color: ${statusColor};">${success ? '图片服务测试成功' : '图片服务测试失败'}</h4>
        </div>
    `;

    if (success) {
        content += `
            <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 8px;">
                <p style="color: var(--text-primary);"><strong>测试结果:</strong></p>
                <ul style="margin-left: 20px; color: var(--text-primary);">
        `;

        if (result.providers) {
            Object.entries(result.providers).forEach(([provider, status]) => {
                const icon = status.available ? '✅' : '❌';
                content += `<li>${icon} ${provider}: ${status.message}</li>`;
            });
        }

        content += `
                </ul>
                <p style="margin-top: 15px; color: var(--text-primary);"><strong>缓存信息:</strong></p>
                <ul style="margin-left: 20px; color: var(--text-primary);">
                    <li>缓存目录: ${result.cache_info?.directory || 'temp/images_cache'}</li>
                    <li>缓存大小: ${result.cache_info?.size || '0 MB'}</li>
                    <li>文件数量: ${result.cache_info?.file_count || 0}</li>
                </ul>
            </div>
        `;
    } else {
        content += `
            <div style="background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); padding: 20px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                <p style="color: var(--text-primary);"><strong>错误信息:</strong></p>
                <div style="background: var(--bg-secondary); border: 1px solid var(--glass-border); padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9em; color: var(--text-primary);">
                    ${result.detail || result.error || '未知错误'}
                </div>
            </div>
        `;
    }

    document.getElementById('testResults').innerHTML = content;
    document.getElementById('testModal').style.display = 'block';
}


async function saveImageServiceConfig() {
    const tab = document.getElementById('image-service');
    if (!tab) return;

    const config = {};
    const inputs = tab.querySelectorAll('input, select');

    inputs.forEach(input => {
        if (input.name) {
            if (input.type === 'checkbox') {
                config[input.name] = input.checked;
            } else if (input.value) {
                config[input.name] = input.value;
            }
        }
    });

    try {
        const response = await fetch('/api/config/category/image_service', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('图片服务配置保存成功，已实时生效', 'success');
                // 重新检查图片服务状态
                checkImageServiceStatus();
                // 重新加载配置
                loadAllConfigs();
            } else {
                // 正确处理错误信息
                let errorMessage = '未知错误';
                if (result.errors) {
                    if (typeof result.errors === 'string') {
                        errorMessage = result.errors;
                    } else if (typeof result.errors === 'object') {
                        // 如果errors是对象，将其转换为可读的字符串
                        errorMessage = JSON.stringify(result.errors, null, 2);
                    }
                } else if (result.message) {
                    errorMessage = result.message;
                }
                showNotification('图片服务配置保存失败: ' + errorMessage, 'error');
            }
        } else {
            // 尝试解析错误响应
            try {
                const errorResult = await response.json();
                let errorMessage = '请求失败';
                if (errorResult.detail) {
                    errorMessage = errorResult.detail;
                } else if (errorResult.message) {
                    errorMessage = errorResult.message;
                }
                showNotification('图片服务配置保存失败: ' + errorMessage, 'error');
            } catch (parseError) {
                showNotification('图片服务配置保存失败: HTTP ' + response.status, 'error');
            }
        }
    } catch (error) {
        showNotification('保存失败: ' + error.message, 'error');
    }
}

// 带进度条的保存图片服务配置
async function saveImageServiceConfigWithProgress() {
    const saveBtn = document.getElementById('save-image-service-btn');
    const progressElement = document.getElementById('save-image-service-progress');
    const textElement = document.getElementById('save-image-service-text');

    if (!saveBtn || !progressElement || !textElement) {
        console.error('找不到保存按钮或进度元素');
        return;
    }

    // 显示进度
    showButtonProgress('save-image-service-btn', 'save-image-service-progress', 'save-image-service-text');

    try {
        await saveImageServiceConfig();
    } catch (error) {
        console.error('保存图片服务配置失败:', error);
        showNotification('保存失败: ' + error.message, 'error');
    } finally {
        // 隐藏进度
        hideButtonProgress('save-image-service-btn', 'save-image-service-progress', 'save-image-service-text');
    }
}

// 图片服务选项控制函数
function toggleImageServiceOptions() {
    const enableCheckbox = document.querySelector('input[name="enable_image_service"]');
    const optionsDiv = document.getElementById('image-service-options');

    if (enableCheckbox && optionsDiv) {
        if (enableCheckbox.checked) {
            optionsDiv.style.display = 'block';
            // 触发一次配置显示更新
            toggleImageSourceConfig();
        } else {
            optionsDiv.style.display = 'none';
        }
    }
}

function toggleImageSourceConfig() {
    const localCheckbox = document.querySelector('input[name="enable_local_images"]');
    const networkCheckbox = document.querySelector('input[name="enable_network_search"]');
    const aiCheckbox = document.querySelector('input[name="enable_ai_generation"]');

    const localConfig = document.getElementById('local-images-config');
    const networkConfig = document.getElementById('network-search-config');
    const aiConfig = document.getElementById('ai-generation-config');

    if (!localConfig || !networkConfig || !aiConfig) return;

    // 根据复选框状态显示/隐藏对应配置
    if (localCheckbox && localCheckbox.checked) {
        localConfig.style.display = 'block';
    } else {
        localConfig.style.display = 'none';
    }

    if (networkCheckbox && networkCheckbox.checked) {
        networkConfig.style.display = 'block';
    } else {
        networkConfig.style.display = 'none';
    }

    if (aiCheckbox && aiCheckbox.checked) {
        aiConfig.style.display = 'block';
        // 当AI生成配置显示时，也检查提供商特定配置
        toggleProviderSpecificConfig();
    } else {
        aiConfig.style.display = 'none';
    }
}

function toggleProviderSpecificConfig() {
    const providerSelect = document.querySelector('select[name="default_ai_image_provider"]');
    const pollinationsConfig = document.getElementById('pollinations-specific-config');

    if (!providerSelect || !pollinationsConfig) return;

    const selectedProvider = providerSelect.value;

    // 显示/隐藏Pollinations特定配置
    if (selectedProvider === 'pollinations') {
        pollinationsConfig.style.display = 'block';
    } else {
        pollinationsConfig.style.display = 'none';
    }
}

// 通用函数：获取提供者模型列表
async function fetchProviderModels(provider) {
    try {
        // 获取提供者配置
        const config = getProviderConfig(provider);
        if (provider !== 'ollama' && !config.api_key) {
            throw new Error(`请先配置 ${provider} 的 API Key`);
        }

        const response = await fetch(`/api/ai/providers/${provider}/models`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });

        if (!response.ok) {
            let errMsg = `HTTP ${response.status}`;
            try {
                const errJson = await response.json();
                errMsg = errJson.error || errJson.detail || errMsg;
            } catch (e) {}

            // 处理认证错误
            if (response.status === 401) {
                throw new Error('请先登录后再获取模型列表');
            }

            throw new Error(errMsg);
        }

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || '获取模型列表失败');
        }

        return result.models || [];
    } catch (error) {
        console.error(`获取 ${provider} 模型列表失败:`, error);
        showNotification(`获取 ${provider} 模型列表失败: ${error.message}`, 'error');
        return [];
    }
}

// 获取提供者配置
function getProviderConfig(provider) {
    const config = {};

    switch (provider) {
        case 'anthropic':
            config.api_key = getInputValue('anthropic_api_key');
            config.base_url = getInputValue('anthropic_base_url') || 'https://api.anthropic.com';
            config.api_version = getInputValue('anthropic_api_version') || '2023-06-01';
            break;
        case 'google':
            config.api_key = getInputValue('google_api_key');
            config.base_url = getInputValue('google_base_url') || 'https://generativelanguage.googleapis.com';
            break;
        case 'azure_openai':
            config.api_key = getInputValue('azure_openai_api_key');
            config.endpoint = getInputValue('azure_openai_endpoint');
            config.base_url = config.endpoint; // alias
            config.api_version = getInputValue('azure_openai_api_version') || '2024-02-15-preview';
            break;
        case 'ollama':
            config.base_url = getInputValue('ollama_base_url') || 'http://localhost:11434';
            // Ollama doesn't need API key
            break;
        default:
            throw new Error(`未知的提供者: ${provider}`);
    }

    return config;
}

// 辅助函数：获取输入框值
function getInputValue(name) {
    const input = document.querySelector(`input[name="${name}"]`);
    return input ? input.value.trim() : '';
}

// 获取并显示模型列表（支持所有提供者）
async function fetchAndShowModels(provider = 'openai') {
    const selectElement = document.getElementById(`${provider}_model_select`);
    const inputElement = document.getElementById(`${provider}_model_input`);
    const fetchButton = document.getElementById(`${provider}_model_fetch_btn`);

    if (!selectElement || !inputElement || !fetchButton) {
        console.error(`找不到 ${provider} 的模型相关元素`);
        return;
    }

    try {
        // 设置加载状态
        fetchButton.classList.add('loading');
        fetchButton.disabled = true;
        fetchButton.textContent = '⏳';

        let models = [];

        if (provider === 'openai') {
            // OpenAI 模型获取逻辑
            const baseUrlInput = document.querySelector('input[name="openai_base_url"]');
            let baseUrl = baseUrlInput ? baseUrlInput.value.trim() : '';

            if (!baseUrl) {
                baseUrl = 'https://api.openai.com/v1';
            }

            if (!baseUrl.endsWith('/v1')) {
                if (baseUrl.endsWith('/')) {
                    baseUrl += 'v1';
                } else {
                    baseUrl += '/v1';
                }
            }

            const apiKeyInput = document.querySelector('input[name="openai_api_key"]');
            let apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            if (!apiKey) {
                try {
                    const configResponse = await fetch('/api/config/ai_providers');
                    if (configResponse.ok) {
                        const configResult = await configResponse.json();
                        if (configResult.success && configResult.config.openai_api_key) {
                            apiKey = configResult.config.openai_api_key;
                        }
                    }
                } catch (error) {
                    console.error('获取后端配置失败:', error);
                }
            }

            if (!apiKey) {
                showNotification('请先配置 OpenAI API Key', 'warning');
                return;
            }

            models = await fetchOpenAIModels(baseUrl, apiKey);

        } else {
            // 其他提供者通过API获取模型列表
            models = await fetchProviderModels(provider);
        }

        if (models && models.length > 0) {
            // 检查当前是否已经在选择模式
            const isSelectMode = selectElement.style.display !== 'none';

            if (!isSelectMode) {
                // 切换到选择模式
                // 清空现有选项
                selectElement.innerHTML = '<option value="">选择模型...</option>';

                // 添加模型选项
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    selectElement.appendChild(option);
                });

                // 保存当前输入框的值
                const currentValue = inputElement.value;

                // 切换显示模式
                inputElement.style.display = 'none';
                selectElement.style.display = 'block';

                // 设置选择框的值
                if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) {
                    selectElement.value = currentValue;
                } else {
                    selectElement.value = ''; // 显示"选择模型..."
                }

                // 监听选择变化
                selectElement.onchange = function() {
                    if (this.value) {
                        inputElement.value = this.value;
                        inputElement.placeholder = this.value; // 更新placeholder为选中的模型
                    } else {
                        inputElement.value = '';
                        inputElement.placeholder = '选择模型...';
                    }
                };

                showNotification(`成功获取到 ${models.length} 个模型，请从下拉框选择`, 'success');
            } else {
                // 已经在选择模式，切换回输入模式
                selectElement.style.display = 'none';
                inputElement.style.display = 'block';

                // 恢复原始placeholder
                const defaultPlaceholders = {
                    'openai': 'gpt-4o',
                    'anthropic': 'claude-3-5-sonnet-20241022',
                    'google': 'gemini-1.5-flash',
                    'azure_openai': 'your-deployment-name',
                    'ollama': 'llama2, mistral, codellama...'
                };

                if (!inputElement.value) {
                    inputElement.placeholder = defaultPlaceholders[provider] || '输入模型名称...';
                }

                showNotification('已切换到手动输入模式', 'info');
            }
        } else {
            const providerNames = {
                'openai': 'OpenAI',
                'anthropic': 'Anthropic',
                'google': 'Google',
                'azure_openai': 'Azure OpenAI',
                'ollama': 'Ollama'
            };
            const providerName = providerNames[provider] || provider;
            showNotification(`未能获取到 ${providerName} 模型列表，请检查配置`, 'warning');
        }

    } catch (error) {
        console.error('获取模型列表失败:', error);

        let errorMessage = `获取模型列表失败: ${error.message}`;
        let suggestion = '';

        // 根据错误类型提供建议
        if (error.message.includes('NO_KEYS_AVAILABLE')) {
            suggestion = '\n\n💡 解决建议：\n• 检查API Key是否正确\n• 确认API Key有足够配额\n• 验证API Key是否已激活\n• 尝试点击🔍按钮验证API Key';
        } else if (error.message.includes('503')) {
            suggestion = '\n\n💡 解决建议：\n• API服务可能暂时不可用\n• 检查网络连接\n• 稍后重试';
        } else if (error.message.includes('401')) {
            suggestion = '\n\n💡 解决建议：\n• API Key可能无效或过期\n• 检查API Key格式是否正确\n• 确认Base URL设置正确';
        } else if (error.message.includes('429')) {
            suggestion = '\n\n💡 解决建议：\n• API调用频率过高\n• 稍等片刻后重试\n• 检查API配额限制';
        }

        showNotification(errorMessage + suggestion, 'error');
    } finally {
        // 恢复按钮状态
        fetchButton.classList.remove('loading');
        fetchButton.disabled = false;
        fetchButton.textContent = '📋';
    }
}

// 从OpenAI API获取模型列表（仅通过后端代理）
async function fetchOpenAIModels(baseUrl, apiKey) {
    try {
        // 只通过后端代理请求，避免CORS问题
        const response = await fetch('/api/ai/providers/openai/models', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                base_url: baseUrl,
                api_key: apiKey
            })
        });

        if (!response.ok) {
            // 尝试解析错误响应
            let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            try {
                const errorData = await response.json();
                if (errorData.error) {
                    errorMessage = errorData.error;
                } else if (errorData.detail) {
                    errorMessage = errorData.detail;
                } else if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (parseError) {
                // 如果无法解析错误响应，使用默认错误信息
            }
            throw new Error(errorMessage);
        }

        const data = await response.json();

        // 首先检查是否是错误响应
        if (data.success === false) {
            throw new Error(data.error || '获取模型列表失败');
        }

        // 处理不同的响应格式
        let models = null;

        // 检查各种可能的响应格式
        if (data.success === true && data.models && Array.isArray(data.models)) {
            // 后端返回的格式: {"success": true, "models": [...]}
            models = data.models;
        } else if (data.models && Array.isArray(data.models)) {
            models = data.models;
        } else if (data.data && Array.isArray(data.data)) {
            // 兼容 OpenAI 原始格式
            models = data.data;
        } else if (Array.isArray(data)) {
            // 直接返回数组的情况
            models = data;
        }

        if (models) {
            // 过滤并排序模型列表，优先显示常用的聊天模型
            const sortedModels = models
                .filter(model => model.id || model.name) // 确保有ID或name
                .map(model => {
                    // 标准化模型对象
                    return {
                        id: model.id || model.name,
                        name: model.name || model.id
                    };
                })
                .sort((a, b) => {
                    // 优先级排序：gpt-4 > gpt-3.5 > gemini > 其他
                    const getPriority = (id) => {
                        if (id.includes('gpt-4')) return 4;
                        if (id.includes('gpt-3.5')) return 3;
                        if (id.includes('gemini')) return 2;
                        return 1;
                    };

                    const priorityA = getPriority(a.id);
                    const priorityB = getPriority(b.id);

                    if (priorityA !== priorityB) {
                        return priorityB - priorityA; // 降序
                    }

                    return a.id.localeCompare(b.id); // 字母序
                });

            return sortedModels;
        } else {
            throw new Error('后端代理返回的数据格式不正确，未找到模型数据');
        }

    } catch (error) {
        console.error('通过后端代理获取模型列表失败:', error);
        throw error;
    }
}

// 验证API Key
async function validateApiKey() {
    const apiKeyInput = document.querySelector('input[name="openai_api_key"]');
    const baseUrlInput = document.querySelector('input[name="openai_base_url"]');
    const validateButton = document.getElementById('openai_validate_btn');

    if (!apiKeyInput) {
        showNotification('找不到API Key输入框', 'error');
        return;
    }

    const apiKey = apiKeyInput.value.trim();
    const baseUrl = baseUrlInput ? baseUrlInput.value.trim() : '';

    if (!apiKey) {
        showNotification('请先输入API Key', 'warning');
        return;
    }

    // 更新按钮状态
    validateButton.textContent = '🔄';
    validateButton.disabled = true;

    try {
        // 使用一个简单的API调用来验证Key
        const response = await fetch('/api/ai/providers/openai/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                api_key: apiKey,
                base_url: baseUrl || 'https://api.openai.com/v1'
            })
        });

        const result = await response.json();
    window.__ai_log.info('验证API响应:', { status: response.status, result });

        if (response.ok && result.success) {
            showNotification(`✅ API Key 验证成功！可访问 ${result.model_count || 0} 个模型`, 'success');
            window.__ai_log.info('API Key验证详情:', result);
        } else {
            const errorMsg = result.error || result.message || `HTTP ${response.status}: 验证失败`;
            let detailedMessage = `❌ API Key 验证失败: ${errorMsg}`;

            // 根据错误类型提供具体的解决建议
            if (errorMsg.includes('NO_KEYS_AVAILABLE')) {
                detailedMessage += `

🔧 解决方案：
1. 登录 OpenAI 控制台：https://platform.openai.com/
2. 检查账户余额和配额
3. 确认 API Key 状态为 "Active"
4. 如果余额不足，请充值账户
5. 尝试创建新的 API Key

📋 其他选项：
• 尝试使用 Anthropic Claude 或 Google Gemini
• 配置 Ollama 本地模型（无需 API Key）`;
            } else if (errorMsg.includes('401')) {
                detailedMessage += `

🔧 解决方案：
1. 检查 API Key 格式是否正确（应以 sk- 开头）
2. 确认 API Key 未过期
3. 重新复制粘贴 API Key，避免多余空格`;
            } else if (errorMsg.includes('429')) {
                detailedMessage += `

🔧 解决方案：
1. 等待几分钟后重试
2. 检查 API 调用频率限制
3. 升级账户以获得更高的速率限制`;
            }

            showNotification(detailedMessage, 'error');
            console.error('API Key验证失败:', result);
        }
    } catch (error) {
        showNotification(`❌ 验证过程出错: ${error.message}`, 'error');
        console.error('API Key验证错误:', error);
    } finally {
        // 恢复按钮状态
        validateButton.textContent = '🔍';
        validateButton.disabled = false;
    }
}

// 初始化OpenAI模型输入框状态
function initOpenAIModelInput() {
    const inputElement = document.getElementById('openai_model_input');
    if (inputElement && !inputElement.value.trim()) {
        // 恢复原始placeholder，不强制显示"选择模型..."
        const originalPlaceholder = inputElement.getAttribute('placeholder');
        if (originalPlaceholder && originalPlaceholder !== '选择模型...') {
            inputElement.placeholder = originalPlaceholder;
        }
    }

    // 移除自动获取模型的行为，让用户可以正常手动输入
    // 用户需要点击📋按钮来获取模型列表
}

// 页面加载时初始化图片服务选项显示
document.addEventListener('DOMContentLoaded', function() {
    // 延迟执行以确保DOM完全加载
    setTimeout(() => {
        toggleImageServiceOptions();
        initOpenAIModelInput();
        initCurrentModelSelect();
    }, 100);
});

// 初始化当前模型选择框
async function initCurrentModelSelect() {
    // 获取当前提供者
    let currentProvider = null;

    // 首先尝试从API获取
    try {
        const response = await fetch('/api/config/current-provider');
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.current_provider) {
                currentProvider = result.current_provider;
                window.__ai_log.info('从API获取当前提供者:', currentProvider);
            }
        }
    } catch (error) {
        console.warn('API获取当前提供者失败:', error);
    }

    // 如果API获取失败，尝试从可用提供者中推断
    if (!currentProvider) {
    window.__ai_log.info('API未返回提供者，尝试从可用提供者推断...');

        // 获取可用的提供者列表
        const availableProviders = getAvailableProviders();
    window.__ai_log.info('可用提供者列表:', availableProviders);

        if (availableProviders.length > 0) {
            // 使用第一个可用的提供者作为默认值
            currentProvider = availableProviders[0];
            window.__ai_log.info('使用第一个可用提供者作为当前提供者:', currentProvider);
        }
    }

    if (!currentProvider) {
        console.warn('当前提供者未设置');
        return;
    }

    window.__ai_log.info('初始化模型选择框，当前提供者:', currentProvider);

    // 延迟加载以确保DOM完全准备好
    setTimeout(() => {
        loadCurrentProviderModels(currentProvider);
    }, 200);
}

// 加载当前提供者的模型列表
async function loadCurrentProviderModels(provider) {
    const modelSelect = document.getElementById('current_model_select');
    if (!modelSelect) {
        console.error('找不到模型选择框元素');
        return;
    }

    window.__ai_log.info('加载提供者模型:', provider);

    try {
        // 清空现有选项
        modelSelect.innerHTML = '<option value="">选择模型...</option>';

        if (provider === 'openai') {
            // 尝试获取OpenAI模型列表
            const baseUrlInput = document.querySelector('input[name="openai_base_url"]');
            const apiKeyInput = document.querySelector('input[name="openai_api_key"]');

            let baseUrl = baseUrlInput ? baseUrlInput.value.trim() : '';
            let apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            if (!baseUrl) baseUrl = 'https://api.openai.com/v1';
            if (!baseUrl.endsWith('/v1')) {
                baseUrl = baseUrl.endsWith('/') ? baseUrl + 'v1' : baseUrl + '/v1';
            }

            // 如果没有API Key，尝试从后端获取
            if (!apiKey) {
                try {
                    const configResponse = await fetch('/api/config/ai_providers');
                    if (configResponse.ok) {
                        const configResult = await configResponse.json();
                        if (configResult.success && configResult.config.openai_api_key) {
                            apiKey = configResult.config.openai_api_key;
                        }
                    }
                } catch (error) {
                    console.error('获取后端配置失败:', error);
                }
            }

            if (apiKey) {
                const models = await fetchOpenAIModels(baseUrl, apiKey);
                if (models && models.length > 0) {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        modelSelect.appendChild(option);
                    });

                    // 从API实时获取当前选中的模型
                    try {
                        const configResponse = await fetch('/api/config/ai_providers');
                        if (configResponse.ok) {
                            const configResult = await configResponse.json();
                            window.__ai_log.info('OpenAI API配置响应:', configResult);
                            if (configResult.success && configResult.config) {
                                const currentModel = configResult.config.openai_model;
                                window.__ai_log.info('从API获取到OpenAI当前模型:', currentModel);
                                window.__ai_log.info('可用模型选项:', Array.from(modelSelect.options).map(opt => opt.value));
                                if (currentModel) {
                                    modelSelect.value = currentModel;
                                    window.__ai_log.info('设置后的模型选择框值:', modelSelect.value);
                                } else {
                                    window.__ai_log.info('API中没有OpenAI模型配置');
                                }
                            } else {
                                window.__ai_log.info('API响应格式异常:', configResult);
                            }
                        } else {
                            console.error('获取配置API失败，状态码:', configResponse.status);
                        }
                    } catch (error) {
                        console.error('获取OpenAI当前模型失败:', error);
                    }
                }
            }
        } else {
            // 其他提供者通过API获取模型
            const models = await fetchProviderModels(provider);
            if (models && models.length > 0) {
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    modelSelect.appendChild(option);
                });
            }

            // 从API实时获取当前选中的模型
            try {
                const configResponse = await fetch('/api/config/ai_providers');
                if (configResponse.ok) {
                    const configResult = await configResponse.json();
                    if (configResult.success && configResult.config) {
                        let currentModel = '';

                        if (provider === 'anthropic') {
                            currentModel = configResult.config['anthropic_model'] || '';
                        } else if (provider === 'google') {
                            currentModel = configResult.config['google_model'] || '';
                        } else if (provider === 'ollama') {
                            currentModel = configResult.config['ollama_model'] || '';
                        } else if (provider === 'azure_openai') {
                            currentModel = configResult.config['azure_openai_deployment_name'] || '';
                        }

                        window.__ai_log.info(`从API获取到 ${provider} 的当前模型:`, currentModel);

                        if (currentModel) {
                            modelSelect.value = currentModel;
                        }
                    }
                }
            } catch (error) {
                console.error(`获取 ${provider} 当前模型失败:`, error);
            }
        }
    } catch (error) {
        console.error('加载模型列表失败:', error);
    }
}

// 保存并测试当前选择的模型
async function saveAndTestCurrentModel() {
    const modelSelect = document.getElementById('current_model_select');

    if (!modelSelect || !modelSelect.value) {
        showNotification('请先选择一个模型', 'warning');
        return;
    }

    // 显示进度条
    showButtonProgress('save_model_btn', 'save-model-progress', 'save-model-text');

    try {
        // 获取当前提供者
        let currentProvider = null;

        // 首先尝试从API获取
        try {
            const response = await fetch('/api/config/current-provider');
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.current_provider) {
                    currentProvider = result.current_provider;
                    window.__ai_log.info('从API获取到当前提供者:', currentProvider);
                }
            }
        } catch (error) {
            console.warn('API获取当前提供者失败:', error);
        }

        // 如果API获取失败，尝试从可用提供者中推断
        if (!currentProvider) {
            window.__ai_log.info('API未返回提供者，尝试从可用提供者推断...');

            // 获取可用的提供者列表
            const availableProviders = getAvailableProviders();
            window.__ai_log.info('可用提供者列表:', availableProviders);

            if (availableProviders.length > 0) {
                // 使用第一个可用的提供者作为默认值
                currentProvider = availableProviders[0];
                window.__ai_log.info('使用第一个可用提供者作为当前提供者:', currentProvider);
            }
        }

        if (!currentProvider) {
            showNotification('没有可用的提供者，请先配置并测试至少一个AI提供者', 'error');
            return;
        }

        const selectedModel = modelSelect.value;

        // 构建配置对象
        const config = {};

        // 根据提供者类型设置正确的配置键
        if (currentProvider === 'azure_openai') {
            config['azure_openai_deployment_name'] = selectedModel;
        } else {
            config[currentProvider + '_model'] = selectedModel;
        }

    window.__ai_log.info('保存模型配置:', config);

        // 保存配置 - 使用正确的API端点
        const saveResponse = await fetch('/api/config/all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                config: config
            })
        });

        if (!saveResponse.ok) {
            const errorText = await saveResponse.text();
            throw new Error(`HTTP ${saveResponse.status}: ${errorText}`);
        }

        const saveResult = await saveResponse.json();
        if (!saveResult.success) {
            throw new Error(saveResult.message || '保存失败');
        }

    window.__ai_log.info('模型配置保存成功');

        // 保存成功后，测试该提供者和模型
        const testSuccess = await testProviderSilently(currentProvider);

        if (testSuccess) {
            showNotification(`模型 ${selectedModel} 保存并测试成功！`, 'success');

            // 更新状态显示
            updateProviderStatusDisplay(currentProvider, true);

            // 刷新当前提供者下拉框
            await initCurrentProviderSelect();
        } else {
            showNotification(`模型 ${selectedModel} 已保存，但测试失败。请检查模型名称是否正确。`, 'warning');
        }

    } catch (error) {
        console.error('保存并测试模型失败:', error);
        showNotification('保存并测试失败: ' + error.message, 'error');
    } finally {
        // 隐藏进度条
        hideButtonProgress('save_model_btn', 'save-model-progress', 'save-model-text');
    }
}

// 保存当前选择的模型（原始函数，保留作为备用）
async function saveCurrentModel() {
    const modelSelect = document.getElementById('current_model_select');
    const saveBtn = document.getElementById('save_model_btn');

    if (!modelSelect || !modelSelect.value) {
        showNotification('请先选择一个模型', 'warning');
        return;
    }

    try {
        saveBtn.disabled = true;
        saveBtn.textContent = '保存中...';

        // 获取当前提供者
        let currentProvider = null;

        // 首先尝试从API获取
        try {
            const response = await fetch('/api/config/current-provider');
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.current_provider) {
                    currentProvider = result.current_provider;
                    window.__ai_log.info('从API获取到当前提供者:', currentProvider);
                }
            }
        } catch (error) {
            console.warn('API获取当前提供者失败:', error);
        }

        // 如果API获取失败，尝试从可用提供者中推断
        if (!currentProvider) {
            window.__ai_log.info('API未返回提供者，尝试从可用提供者推断...');

            // 获取可用的提供者列表
            const availableProviders = getAvailableProviders();
            window.__ai_log.info('可用提供者列表:', availableProviders);

            if (availableProviders.length > 0) {
                // 使用第一个可用的提供者作为默认值
                currentProvider = availableProviders[0];
                window.__ai_log.info('使用第一个可用提供者作为当前提供者:', currentProvider);
            }
        }

        if (!currentProvider) {
            showNotification('没有可用的提供者，请先配置并测试至少一个AI提供者', 'error');
            return;
        }

        const selectedModel = modelSelect.value;

        // 构建配置对象
        const config = {};

        // 根据提供者类型设置正确的配置键
        if (currentProvider === 'azure_openai') {
            config['azure_openai_deployment_name'] = selectedModel;
        } else {
            config[currentProvider + '_model'] = selectedModel;
        }

        // 保存配置
        const response = await fetch('/api/config/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification(`已将 ${currentProvider} 的默认模型设置为: ${selectedModel}`, 'success');

                // 更新对应提供者配置卡片中的模型输入框
                const providerCard = document.querySelector(`[data-provider="${currentProvider}"]`);
                if (providerCard) {
                    let modelInputName = currentProvider + '_model';
                    if (currentProvider === 'azure_openai') {
                        modelInputName = 'azure_openai_deployment_name';
                    }

                    const modelInput = providerCard.querySelector(`input[name="${modelInputName}"]`);
                    if (modelInput) {
                        modelInput.value = selectedModel;
                    }
                }
            } else {
                throw new Error(result.error || '保存失败');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('保存模型配置失败:', error);
        showNotification('保存失败: ' + error.message, 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
    }
}

// 质量预设映射
const QUALITY_PRESETS = {
    conservative: { temperature: 0.2, top_p: 0.8, max_tokens: 1500 },
    balanced:     { temperature: 0.7, top_p: 1.0, max_tokens: 2000 },
    creative:     { temperature: 1.1, top_p: 1.0, max_tokens: 2400 },
};

function onPageCountModeChange(mode){
    const fixedGroup = document.getElementById('fixedPagesGroup');
    const rangeGroup = document.getElementById('rangePagesGroup');
    if(mode === 'fixed'){
        fixedGroup.style.display = '';
        rangeGroup.style.display = 'none';
    }else if(mode === 'custom_range'){
        fixedGroup.style.display = 'none';
        rangeGroup.style.display = '';
    }else{
        fixedGroup.style.display = 'none';
        rangeGroup.style.display = 'none';
    }
}

// 预设选择时自动带出参数但不强制覆盖用户手动输入
(function bindQualityPreset(){
    document.addEventListener('change', function(e){
        if(e.target && e.target.name === 'generation_quality_preset'){
            const p = QUALITY_PRESETS[e.target.value];
            if(!p) return;
            const temp = document.querySelector('#generation-params input[name="temperature"]');
            const topP = document.querySelector('#generation-params input[name="top_p"]');
            const maxT = document.querySelector('#generation-params input[name="max_tokens"]');
            if(temp && !temp.dataset.userEdited){ temp.value = p.temperature; temp.dispatchEvent(new Event('input')); }
            if(topP && !topP.dataset.userEdited){ topP.value = p.top_p; topP.dispatchEvent(new Event('input')); }
            if(maxT && !maxT.dataset.userEdited){ maxT.value = p.max_tokens; maxT.dispatchEvent(new Event('input')); }
        }
    });

    ['temperature','top_p','max_tokens'].forEach(name =>{
        const el = document.querySelector(`#generation-params input[name="${name}"]`);
        if(el){ el.addEventListener('input', ()=>{ el.dataset.userEdited = '1'; }); }
    });
})();

// Apryse许可证检测功能
async function checkApryseLicense() {
    const btn = document.getElementById('checkLicenseBtn');
    const status = document.getElementById('licenseStatus');
    const input = document.getElementById('apryse_license_key');

    // 检查是否输入了许可证
    if (!input.value.trim()) {
        showLicenseStatus('请先输入Apryse许可证密钥', 'error');
        return;
    }

    // 显示检测中状态
    btn.disabled = true;
    btn.textContent = '检测中...';
    showLicenseStatus('正在验证许可证...', 'info');

    try {
        // 先保存当前配置以确保许可证被更新
        const licenseKey = input.value.trim();

        // 创建FormData对象并添加许可证密钥
        const formData = new FormData();
        formData.append('apryse_license_key', licenseKey);

        // 保存配置
        const saveResponse = await fetch('/api/config/all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                config: { apryse_license_key: licenseKey }
            })
        });

        if (!saveResponse.ok) {
            throw new Error('保存配置失败');
        }

        // 检测许可证
        const response = await fetch('/api/apryse/license/check');
        const result = await response.json();

        if (result.valid) {
            showLicenseStatus(`✅ ${result.message}`, 'success');
        } else {
            showLicenseStatus(`❌ ${result.error}`, 'error');
        }

    } catch (error) {
        console.error('许可证检测失败:', error);
        showLicenseStatus(`❌ 检测失败: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = '检测许可证';
    }
}

function showLicenseStatus(message, type) {
    const status = document.getElementById('licenseStatus');
    status.style.display = 'block';
    status.textContent = message;

    // 清除之前的样式
    status.className = '';

    // 根据类型设置样式
    switch (type) {
        case 'success':
            status.style.background = '#d4edda';
            status.style.color = '#155724';
            status.style.border = '1px solid #c3e6cb';
            break;
        case 'error':
            status.style.background = '#f8d7da';
            status.style.color = '#721c24';
            status.style.border = '1px solid #f5c6cb';
            break;
        case 'info':
            status.style.background = '#d1ecf1';
            status.style.color = '#0c5460';
            status.style.border = '1px solid #bee5eb';
            break;
        default:
            status.style.background = '#f8f9fa';
            status.style.color = '#6c757d';
            status.style.border = '1px solid #dee2e6';
    }
}

// 在加载配置后，根据 page_count_mode 控制显示
(function patchPopulate(){
    const orig = populateGenerationParams;
    window.populateGenerationParams = function(){
        orig.apply(this, arguments);
        const tab = document.getElementById('generation-params');
        if(!tab) return;
        const modeEl = tab.querySelector('select[name="page_count_mode"]');
        if(modeEl){ onPageCountModeChange(modeEl.value); }
    }
})();

// 数据备份相关功能
// 自动检测并切换到推荐的部署模式
async function autoDetectMode() {
    try {
        showNotification('正在检测环境配置...', 'info');

        // 获取可用模式列表，包含推荐信息
        const response = await fetch('/api/deployment/available-modes');
        if (!response.ok) {
            throw new Error('获取模式信息失败');
        }

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || '获取模式信息失败');
        }

        // 找到推荐的模式
        const recommendedMode = result.available_modes.find(mode => mode.recommended);
        if (!recommendedMode) {
            showNotification('未找到推荐的部署模式', 'warning');
            return;
        }

        const currentMode = result.current_mode;
        console.log('当前模式:', currentMode);
        console.log('推荐模式:', recommendedMode.mode);

        // 如果当前已经是推荐的模式
        if (currentMode === recommendedMode.mode) {
            showNotification(`当前已经是推荐模式: ${recommendedMode.name}`, 'success');
            // 仍然刷新显示以确保信息是最新的
            await refreshDeploymentMode();
            return;
        }

        // 显示检测结果并准备切换
        showNotification(`检测到推荐模式: ${recommendedMode.name} (${recommendedMode.description})`, 'info');

        // 自动切换到推荐的模式
        await switchToMode(recommendedMode.mode);

    } catch (error) {
        console.error('自动检测模式失败:', error);
        showNotification('自动检测模式失败: ' + error.message, 'error');
    }
}

// 刷新部署模式信息
async function refreshDeploymentMode() {
    try {
        const response = await fetch('/api/deployment/mode');
        if (response.ok) {
            const result = await response.json();
            // API直接返回数据，不需要检查success字段
            updateDeploymentModeDisplay(result);
        } else {
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData.detail || '获取部署模式失败';
            showNotification(errorMessage, 'error');
        }
    } catch (error) {
        console.error('刷新部署模式失败:', error);
        showNotification('刷新部署模式失败: ' + error.message, 'error');
    }
}

// 更新部署模式显示
function updateDeploymentModeDisplay(result) {
    const modeElement = document.getElementById('current-deployment-mode');
    const detailsElement = document.getElementById('deployment-mode-details');
    const currentModeDetailsElement = document.getElementById('current-mode-details');

    if (modeElement) {
        let modeText = result.current_mode || '未知';
        let bgColor = '#95a5a6'; // 默认灰色

        // 根据模式设置不同的颜色
        switch (result.current_mode) {
            case 'local_only':
                bgColor = '#e74c3c'; // 红色
                modeText = 'LOCAL_ONLY';
                break;
            case 'local_external':
                bgColor = '#f39c12'; // 橙色
                modeText = 'LOCAL_EXTERNAL';
                break;
            case 'local_r2':
                bgColor = '#27ae60'; // 绿色
                modeText = 'LOCAL_R2';
                break;
            case 'local_external_r2':
                bgColor = '#8e44ad'; // 紫色
                modeText = 'LOCAL_EXTERNAL_R2';
                break;
        }

        modeElement.textContent = modeText;
        modeElement.style.background = bgColor;
    }

    if (detailsElement) {
        let details = '';
        details += `<strong>当前模式:</strong> ${result.current_mode || '未知'}<br>`;
        details += `<strong>检测模式:</strong> ${result.detected_mode || '未知'}<br>`;
        if (result.switch_in_progress) {
            details += `<strong>状态:</strong> <span style="color: #f39c12;">模式切换中...</span><br>`;
        } else {
            details += `<strong>状态:</strong> <span style="color: #27ae60;">正常</span><br>`;
        }
        if (result.last_check) {
            // API返回的是ISO格式字符串，直接使用new Date()解析
            const lastCheckDate = new Date(result.last_check);
            details += `<strong>最后检查:</strong> ${lastCheckDate.toLocaleString()}<br>`;
        }
        detailsElement.innerHTML = details || '暂无详细信息';
    }

    // 显示当前模式的详细信息
    if (currentModeDetailsElement) {
        displayCurrentModeDetails(result.current_mode);
    }

    // 检查当前模式是否与下拉框中选中的模式相同，如果相同则隐藏右侧详细信息
    const select = document.getElementById('deployment-mode-select');
    const selectedModeInfo = document.getElementById('selected-mode-info');
    if (select && selectedModeInfo && select.value === result.current_mode) {
        // 当前模式与选中的模式相同，隐藏右侧详细信息
        selectedModeInfo.style.display = 'none';
        select.value = ''; // 清空选择

        // 禁用切换按钮
        const switchBtn = document.getElementById('switch-mode-btn');
        if (switchBtn) {
            switchBtn.disabled = true;
            switchBtn.textContent = '切换到此模式';
            switchBtn.style.background = 'var(--accent-gradient)';
        }
    }
}

// 加载可用的部署模式
async function loadAvailableModes(preserveSelection = false) {
    try {
        const response = await fetch('/api/deployment/available-modes');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // 如果需要保持选择，传递当前选中的值
                if (preserveSelection) {
                    const select = document.getElementById('deployment-mode-select');
                    const currentSelectedValue = select ? select.value : null;
                    displayAvailableModes(result, currentSelectedValue);
                } else {
                    displayAvailableModes(result);
                }
            } else {
                console.error('获取可用模式失败:', result.error);
            }
        }
    } catch (error) {
        console.error('加载可用模式失败:', error);
    }
}

// 显示可用的部署模式选项
function displayAvailableModes(data, selectedMode = null) {
    // 更新配置状态显示
    updateConfigStatusDisplay(data.config_status);

    // 更新下拉选择框
    updateModeSelectOptions(data.available_modes, data.current_mode, selectedMode);

    // 如果有当前模式，显示其信息
    if (data.current_mode) {
        showSelectedModeInfo(data.available_modes.find(m => m.mode === data.current_mode), data.current_mode);
    }
}

// 更新配置状态显示
function updateConfigStatusDisplay(config) {
    const container = document.getElementById('config-status-display');
    if (!container) return;

    let html = '<div style="font-size: 0.85em; color: #6c757d; margin-bottom: 8px;">当前配置状态:</div>';
    html += '<div style="display: flex; gap: 15px; font-size: 0.85em;">';
    html += `<span style="color: ${config.has_external_db ? '#27ae60' : '#e74c3c'}">`;
    html += `${config.has_external_db ? '✅' : '❌'} 外部数据库`;
    html += '</span>';
    html += `<span style="color: ${config.has_r2 ? '#27ae60' : '#e74c3c'}">`;
    html += `${config.has_r2 ? '✅' : '❌'} R2云存储`;
    html += '</span>';
    html += '</div>';

    container.innerHTML = html;
}

// 更新模式选择下拉框
function updateModeSelectOptions(modes, currentMode, selectedMode = null) {
    const select = document.getElementById('deployment-mode-select');
    if (!select) {
        console.error('找不到部署模式选择下拉框元素');
        return;
    }

    // 保存当前选中的值（如果没有指定selectedMode）
    const currentSelectedValue = selectedMode || select.value;

    // 记住当前选中的值
    const previousSelection = select.value;

    // 清空现有选项（保留默认选项）
    select.innerHTML = '<option value="">请选择模式...</option>';

    // 添加模式选项
    modes.forEach(mode => {
        const option = document.createElement('option');
        option.value = mode.mode;
        option.textContent = mode.name;

        // 如果是推荐模式，添加标记
        if (mode.recommended) {
            option.textContent += ' (推荐)';
            option.style.fontWeight = 'bold';
        }

        // 如果是用户当前选中的模式，选中它
        // 优先使用用户选择，其次使用当前模式（当没有用户选择时）
        if (mode.mode === currentSelectedValue && currentSelectedValue) {
            option.selected = true;
        } else if (mode.mode === currentMode && !currentSelectedValue) {
            option.selected = true;
        }

        select.appendChild(option);
    });

    // 确保至少有一个选项被选中
    if (!select.value && modes.length > 0) {
        // 如果没有选中项，默认选中当前模式
        const currentModeOption = select.querySelector(`option[value="${currentMode}"]`);
        if (currentModeOption) {
            currentModeOption.selected = true;
        } else if (select.options.length > 1) {
            // 如果找不到当前模式，选择第一个可用模式
            select.options[1].selected = true;
        }
    }

    // 如果最终选中的是当前激活的模式，隐藏右侧详细信息
    if (select.value === currentMode) {
        const modeInfo = document.getElementById('selected-mode-info');
        const switchBtn = document.getElementById('switch-mode-btn');
        if (modeInfo) {
            modeInfo.style.display = 'none';
        }
        if (switchBtn) {
            switchBtn.textContent = '✓ 已激活';
            switchBtn.disabled = true;
            switchBtn.style.background = '#27ae60';
        }
    }
}

// 处理模式选择变化
function onModeSelectionChange(selectedMode) {
    const switchBtn = document.getElementById('switch-mode-btn');
    const modeInfo = document.getElementById('selected-mode-info');

    if (!selectedMode) {
        // 没有选择模式
        switchBtn.disabled = true;
        modeInfo.style.display = 'none';
        return;
    }

    // 显示选中模式的详细信息（不刷新整个模式列表，保持用户选择）
    fetch('/api/deployment/available-modes')
        .then(response => response.json())
        .then(data => {
            const selectedModeData = data.available_modes.find(m => m.mode === selectedMode);
            if (selectedModeData) {
                const isCurrent = selectedModeData.mode === data.current_mode;
                if (isCurrent) {
                    // 如果选择的是当前激活的模式，不显示详细信息
                    modeInfo.style.display = 'none';
                    if (switchBtn) {
                        switchBtn.textContent = '✓ 已激活';
                        switchBtn.disabled = true;
                        switchBtn.style.background = '#27ae60';
                    }
                } else {
                    // 显示选中模式的详细信息
                    showSelectedModeInfo(selectedModeData, data.current_mode);
                }
            }
        })
        .catch(error => {
            console.error('获取模式详细信息失败:', error);
        });
}

// 显示选中模式的详细信息
function showSelectedModeInfo(mode, currentMode) {
    const container = document.getElementById('selected-mode-info');
    if (!container) return;

    const isCurrent = mode.mode === currentMode;

    let html = '<div style="font-size: 0.85em; color: #6c757d;">';
    html += `<strong>模式:</strong> ${mode.name}<br>`;
    html += `<strong>描述:</strong> ${mode.description}<br>`;

    if (mode.recommended) {
        html += '<strong>状态:</strong> <span style="color: #f39c12;">⭐ 推荐模式</span><br>';
    }

    if (isCurrent) {
        html += '<strong>状态:</strong> <span style="color: #27ae60;">✓ 当前激活</span><br>';
    }

    html += '</div>';

    container.innerHTML = html;
    container.style.display = 'block';

    // 更新切换按钮状态
    const switchBtn = document.getElementById('switch-mode-btn');
    if (switchBtn) {
        if (isCurrent) {
            switchBtn.textContent = '✓ 已激活';
            switchBtn.disabled = true;
            switchBtn.style.background = '#27ae60';
        } else {
            switchBtn.textContent = '切换到此模式';
            switchBtn.disabled = false;
            switchBtn.style.background = 'var(--accent-gradient)';
        }
    }
}

// 显示当前模式的详细信息
async function displayCurrentModeDetails(currentMode) {
    const container = document.getElementById('current-mode-details');
    if (!container || !currentMode) {
        if (container) {
            container.style.display = 'none';
        }
        return;
    }

    try {
        // 获取可用模式列表来找到当前模式的详细信息
        const response = await fetch('/api/deployment/available-modes');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                const currentModeData = result.available_modes.find(m => m.mode === currentMode);
                if (currentModeData) {
                    let html = '<div style="font-size: 0.85em; color: #6c757d;">';
                    html += `<strong>模式:</strong> ${currentModeData.name}<br>`;
                    html += `<strong>描述:</strong> ${currentModeData.description}<br>`;

                    if (currentModeData.recommended) {
                        html += '<strong>状态:</strong> <span style="color: #f39c12;">⭐ 推荐模式</span><br>';
                    }

                    html += '<strong>状态:</strong> <span style="color: #27ae60;">✓ 当前激活</span><br>';

                    html += '</div>';

                    container.innerHTML = html;
                    container.style.display = 'block';
                } else {
                    // 如果找不到当前模式的详细信息，显示基本信息
                    let html = '<div style="font-size: 0.85em; color: #6c757d;">';
                    html += `<strong>模式:</strong> ${currentMode}<br>`;
                    html += '<strong>状态:</strong> <span style="color: #27ae60;">✓ 当前激活</span><br>';
                    html += '</div>';

                    container.innerHTML = html;
                    container.style.display = 'block';
                }
            } else {
                container.style.display = 'none';
            }
        } else {
            container.style.display = 'none';
        }
    } catch (error) {
        console.error('获取当前模式详细信息失败:', error);
        container.style.display = 'none';
    }
}

// 切换到选中的模式
async function switchToSelectedMode() {
    const select = document.getElementById('deployment-mode-select');
    if (!select) {
        showNotification('找不到模式选择控件', 'error');
        console.error('deployment-mode-select 元素不存在');
        return;
    }

    const targetMode = select.value;
    console.log('切换模式 - 选中值:', targetMode);

    if (!targetMode) {
        showNotification('请先选择一个模式', 'warning');
        console.warn('目标模式为空，当前选项值:', select.value, '可用选项数量:', select.options.length);
        return;
    }

    // 检查是否是有效的模式值
    if (targetMode === '') {
        showNotification('请选择一个有效的模式', 'warning');
        return;
    }

    await switchToMode(targetMode);
}

// 切换到指定模式
async function switchToMode(targetMode) {
    try {
        // 验证目标模式参数
        if (!targetMode || targetMode.trim() === '') {
            showNotification('目标模式无效', 'error');
            console.error('switchToMode: 目标模式为空或无效', targetMode);
            return;
        }

        console.log('开始切换模式:', targetMode);

        // 首先检查当前模式，避免切换到相同模式
        const modeResponse = await fetch('/api/deployment/mode');
        if (modeResponse.ok) {
            const modeInfo = await modeResponse.json();
            const currentMode = modeInfo.current_mode;

            console.log('当前模式:', currentMode, '目标模式:', targetMode);

            if (currentMode === targetMode) {
                showNotification('该模式已经是当前激活模式', 'info');
                return;
            }
        }

        showNotification('正在切换部署模式...', 'info');

        const response = await fetch('/api/deployment/switch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                target_mode: targetMode,
                reason: '用户手动选择'
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'completed' || result.verified) {
                showNotification(`模式切换成功: ${result.from_mode} → ${result.to_mode}`, 'success');

                // 隐藏右侧选中模式的详细信息（因为已经切换成功）
                const selectedModeInfo = document.getElementById('selected-mode-info');
                if (selectedModeInfo) {
                    selectedModeInfo.style.display = 'none';
                }

                // 重置模式选择下拉框
                const select = document.getElementById('deployment-mode-select');
                if (select) {
                    select.value = '';
                }

                // 禁用切换按钮
                const switchBtn = document.getElementById('switch-mode-btn');
                if (switchBtn) {
                    switchBtn.disabled = true;
                    switchBtn.textContent = '切换到此模式';
                    switchBtn.style.background = 'var(--accent-gradient)';
                }

                // 立即刷新模式显示和重新加载可用模式
                await refreshDeploymentMode();
                await loadAvailableModes(true); // 传递 true 来保持选择
            } else if (result.status === 'in_progress') {
                showNotification(`模式切换已启动: ${result.from_mode} → ${result.to_mode}`, 'success');

                // 禁用切换按钮，显示切换中状态
                const switchBtn = document.getElementById('switch-mode-btn');
                if (switchBtn) {
                    switchBtn.disabled = true;
                    switchBtn.textContent = '切换中...';
                    switchBtn.style.background = '#f39c12';
                }

                // 等待一会儿后刷新模式显示和重新加载可用模式
                setTimeout(() => {
                    refreshDeploymentMode();
                    loadAvailableModes();
                }, 2000);
            } else {
                showNotification('模式切换启动失败', 'error');
            }
        } else {
            const errorData = await response.json();
            showNotification('模式切换失败: ' + (errorData.detail || '未知错误'), 'error');
        }
    } catch (error) {
        console.error('切换模式失败:', error);
        showNotification('切换失败: ' + error.message, 'error');
    }
}

// 同步到外部数据库
async function syncToExternal() {
    try {
        showNotification('正在同步到外部数据库...', 'info');

        const response = await fetch('/api/database/sync/to-external', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('同步到外部数据库成功！', 'success');
                // 刷新同步状态
                await refreshBackupHistory();
            } else {
                showNotification('同步失败: ' + (result.detail || '未知错误'), 'error');
            }
        } else {
            const errorData = await response.json();
            showNotification('同步失败: ' + (errorData.detail || '未知错误'), 'error');
        }
    } catch (error) {
        console.error('同步到外部数据库失败:', error);
        showNotification('同步失败: ' + error.message, 'error');
    }
}

// 从外部数据库恢复
async function syncFromExternal() {
    if (!confirm('确定要从外部数据库恢复数据吗？这将覆盖本地数据！')) {
        return;
    }

    try {
        showNotification('正在从外部数据库恢复...', 'info');

        const response = await fetch('/api/database/sync/from-external', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('从外部数据库恢复成功！', 'success');
                // 刷新同步状态
                await refreshBackupHistory();
            } else {
                showNotification('恢复失败: ' + (result.detail || '未知错误'), 'error');
            }
        } else {
            const errorData = await response.json();
            showNotification('恢复失败: ' + (errorData.detail || '未知错误'), 'error');
        }
    } catch (error) {
        console.error('从外部数据库恢复失败:', error);
        showNotification('恢复失败: ' + error.message, 'error');
    }
}

// 下载本地最新备份（或选择的本地备份）
async function downloadLatestBackup() {
    try {
        // 优先使用选择框中的值
        const select = document.getElementById('db-file-list');
        let backupName = select && select.value ? select.value : null;

        // 如果下拉值是R2对象key（包含/），则忽略下拉值，回退到本地最新备份
        if (backupName && backupName.includes('/')) {
            backupName = null;
        }

    if (!backupName) {
            // 回退：获取本地列表的最新一个
            const resp = await fetch('/api/backup/local/list');
            if (resp.ok) {
                const items = await resp.json();
                if (items && items.length > 0) {
                    backupName = items[0].name;
                }
            }
        }

        if (!backupName) {
            showNotification('暂无可下载的本地备份', 'warning');
            return;
        }

        const url = `/api/backup/local/download?backup_name=${encodeURIComponent(backupName)}`;
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = backupName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showNotification('已开始下载本地备份', 'success');
    } catch (error) {
        console.error('下载备份失败:', error);
        showNotification('下载备份失败: ' + error.message, 'error');
    }
}

// 同步到R2（可选：选择的本地备份，否则同步最新本地备份）
async function syncToR2() {
    try {
        showNotification('正在同步到R2云存储...', 'info');

        const select = document.getElementById('db-file-list');
        let backupName = '';
        // 仅当下拉里存的是本地文件名时才使用；若是R2对象key（包含/），则忽略，回退为同步最新本地备份
        if (select && select.value && !select.value.includes('/')) {
            backupName = select.value;
        }

        const url = backupName
            ? `/api/backup/r2/sync?backup_name=${encodeURIComponent(backupName)}`
            : '/api/backup/r2/sync';

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

    if (response.ok) {
            const result = await response.json();
            // 后端直接返回 sync_info 字段集合，不包裹 success；视 presence of filename/size as成功
            const ok = result && (result.success === true || result.filename || result.created_at || result.timestamp);
            if (ok) {
                showNotification('同步到R2成功！', 'success');
                updateR2SyncStatus(result);
                // 刷新R2状态与下拉列表
                await checkR2Status();
                await loadR2FileList();
        // 不再刷新外部数据库下拉，避免耦合
            } else {
                showNotification('同步失败: ' + (result.error || '未知错误'), 'error');
            }
        } else {
            showNotification('同步到R2失败', 'error');
        }
    } catch (error) {
        console.error('同步到R2失败:', error);
        showNotification('同步失败: ' + error.message, 'error');
    }
}

// 从R2恢复（优先使用选择的对象；否则使用R2上最新的对象）
async function restoreFromR2() {
    if (!confirm('确定要从R2云存储恢复数据吗？这将覆盖当前数据！')) {
        return;
    }

    try {
        showNotification('正在从R2恢复数据...', 'info');

        // 读取选择框
        const select = document.getElementById('r2-file-list');
        let key = select && select.value ? select.value : null;

        // 如未选择，则拉取列表取最新
        if (!key) {
            const listResp = await fetch('/api/backup/r2/list');
            if (listResp.ok) {
                const listData = await listResp.json();
                if (listData && listData.length) {
                    // 兼容 items 或直接数组
                    const items = Array.isArray(listData.items) ? listData.items : listData;
                    if (items.length > 0) key = items[0].key;
                }
            }
        }

        if (!key) {
            showNotification('R2 上暂无可恢复的备份', 'warning');
            return;
        }

        const response = await fetch(`/api/backup/r2/restore?key=${encodeURIComponent(key)}`, { method: 'POST' });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('数据恢复成功！', 'success');
                updateR2SyncStatus(result.restore_info || result);
                // 恢复后不刷新外部数据库下拉，保持解耦
            } else {
                showNotification('恢复失败: ' + (result.error || '未知错误'), 'error');
            }
        } else {
            showNotification('从R2恢复失败', 'error');
        }
    } catch (error) {
        console.error('从R2恢复失败:', error);
        showNotification('恢复失败: ' + error.message, 'error');
    }
}

// 从R2下载数据（优先使用选择的对象；否则使用最新）
async function downloadFromR2() {
    try {
        showNotification('正在从R2下载数据...', 'info');

        const select = document.getElementById('r2-file-list');
        let key = select && select.value ? select.value : null;

        if (!key) {
            const listResp = await fetch('/api/backup/r2/list');
            if (listResp.ok) {
                const listData = await listResp.json();
                const items = Array.isArray(listData.items) ? listData.items : listData;
                if (items && items.length) key = items[0].key;
            }
        }

        if (!key) {
            showNotification('R2 上暂无可下载的备份', 'warning');
            return;
        }

        const downloadUrl = `/api/backup/r2/download?key=${encodeURIComponent(key)}`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification('R2 备份下载已开始，请查看浏览器下载。', 'success');
    } catch (error) {
        console.error('从R2下载失败:', error);
        showNotification('下载失败: ' + error.message, 'error');
    }
}
// 加载“外部数据库备份”列表到左侧数据库卡片的下拉框（来源：本地备份目录）
async function loadExternalDBBackupList() {
    try {
        // 首先加载本地备份（更贴合“外部数据库”的独立性）
        const localResp = await fetch('/api/backup/local/list');
        const select = document.getElementById('db-file-list');
        if (!select) return;

        let items = [];
    if (localResp.ok) {
            const local = await localResp.json();
            // 仅展示与数据库相关的本地备份
            items = (local || []).filter(it => {
                const name = it.name || '';
        // 外部数据库备份仅展示 external_sql_only 产物
        return name.startsWith('flowslide_external_sql_');
            }).map(it => ({ key: it.name, size: it.size, last_modified: it.created }));
        }

        // 重置并填充
        select.innerHTML = '';
        if (items && items.length) {
            items.forEach(obj => {
                const opt = document.createElement('option');
                opt.value = obj.key; // 对本地，存储 name 即可
                const filename = (obj.key || '').split('/').pop() || obj.key;
                const dateStr = obj.last_modified ? new Date(obj.last_modified).toLocaleString() : '';
                const sizeStr = obj.size ? ` · ${formatFileSize(obj.size)}` : '';
                opt.textContent = `${filename}${dateStr ? ' (' + dateStr + ')' : ''}${sizeStr}`;
                select.appendChild(opt);
            });

            // 更新“最后同步时间/大小”（基于R2的最新数据库备份）
            const latest = items[0];
            if (latest) {
                const timeElement = document.getElementById('last-db-backup');
                const sizeElement = document.getElementById('db-backup-size');
                if (timeElement) {
                    const dt = latest.last_modified || latest.created || latest.created_at || latest.timestamp;
                    if (dt) timeElement.textContent = new Date(dt).toLocaleString();
                }
                if (sizeElement && latest.size) {
                    sizeElement.textContent = formatFileSize(latest.size);
                }
            }
        } else {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '暂无外数据库备份';
            select.appendChild(opt);
        }
    } catch (e) {
        console.warn('加载外部数据库备份列表失败', e);
    }
}

// 加载外部数据库备份类型
async function loadExternalDBTypes() {
    try {
        const sel = document.getElementById('external-db-type');
        if (!sel) return;
        const resp = await fetch('/api/backup/external/types');
        let types = ['db_only','external_sql_only'];
        if (resp.ok) {
            const data = await resp.json();
            if (Array.isArray(data.types)) types = data.types;
        }
        sel.innerHTML = types.map(t=>`<option value="${t}">${t}</option>`).join('');
    } catch(e) {
        console.warn('加载外部数据库类型失败', e);
    }
}

// 生成外部数据库备份（不上传到R2）
async function createExternalBackup() {
    try {
        const sel = document.getElementById('external-db-type');
        const btype = sel && sel.value ? sel.value : 'db_only';
        showNotification('正在生成外部数据库备份...', 'info');
        const resp = await fetch('/api/backup/external/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ backup_type: btype })
        });
        const data = await resp.json().catch(()=>({}));
        if (resp.ok && data.success) {
            showNotification('生成成功', 'success');
            await loadExternalDBBackupList();
        } else {
            showNotification('生成失败: ' + (data.error || data.detail || '未知错误'), 'error');
        }
    } catch(e) {
        showNotification('生成失败: ' + e.message, 'error');
    }
}

// 加载 R2 备份列表并刷新下拉框/提示
async function loadR2FileList() {
    try {
    const catSel = document.getElementById('r2-category-select');
    const selType = catSel && catSel.value ? catSel.value : '';
    let url = '/api/backup/r2/list';
    if (selType) {
        // categories/{type} 前缀
        const prefix = 'backups/categories/' + selType + '/';
        url += `?prefix=${encodeURIComponent(prefix)}`;
    } else {
        // 默认仅列出 categories 下的所有类型，避免与数据库备份混淆
        url += '?prefix=' + encodeURIComponent('backups/categories/');
    }
    const resp = await fetch(url);
        const select = document.getElementById('r2-file-list');
    if (!select) return;

        if (!resp.ok) throw new Error('获取 R2 列表失败');
        const listData = await resp.json();
        const items = Array.isArray(listData.items) ? listData.items : listData;

        // 重置
        select.innerHTML = '';
        if (items && items.length) {
            items.forEach(obj => {
                const opt = document.createElement('option');
                opt.value = obj.key;
                const dateStr = obj.last_modified ? new Date(obj.last_modified).toLocaleString() : '';
                const filename = obj.key?.split('/').pop() || obj.key;
                opt.textContent = `${filename} ${dateStr ? '(' + dateStr + ')' : ''}`;
                select.appendChild(opt);
            });
            // nothing else

            // 更新右侧“最后同步时间/大小”展示
            const latest = items[0];
            const timeEl = document.getElementById('last-r2-backup');
            const sizeEl = document.getElementById('r2-backup-size');
            if (latest && timeEl) {
                const dt = latest.last_modified || latest.backup_date || latest.timestamp;
                if (dt) timeEl.textContent = new Date(dt).toLocaleString();
            }
            if (latest && sizeEl && latest.size) {
                sizeEl.textContent = formatFileSize(latest.size);
            }
        } else {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'R2 上暂无备份';
            select.appendChild(opt);
            // keep layout clean; no inline help text
        }
    } catch (e) {
        console.warn('加载 R2 文件列表失败', e);
    }
}

// 加载备份类别
async function loadBackupCategories() {
    try {
    const resp = await fetch('/api/backup/categories');
        const sel = document.getElementById('r2-category-select');
        if (!sel || !resp.ok) return;
        const data = await resp.json();
        let cats = (data && data.categories) || [];
        if (!cats || cats.length === 0) {
            // 后端不可用时的兜底
            cats = ['db_only','config_only','media_only','templates_only','reports_only','scripts_only','data_only','full'];
        }
        sel.innerHTML = '<option value="">-- 请选择类别 --</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
        sel.onchange = async ()=>{ await loadR2FileList(); };
    } catch (e) {
        console.warn('加载备份类别失败', e);
    }
}

// 一键生成并同步选中类别
async function syncCategoryToR2() {
    const sel = document.getElementById('r2-category-select');
    const type = sel && sel.value ? sel.value : '';
    if (!type) return alert('请先选择备份类别');
    try {
        showNotification('正在生成并同步所选类别到R2...', 'info');
        const resp = await fetch('/api/backup/r2/sync-type', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ backup_type: type })
        });
        const data = await resp.json().catch(()=>({}));
        if (resp.ok && (data.success || data.filename)) {
            showNotification('生成并同步成功', 'success');
            updateR2SyncStatus(data);
            await checkR2Status();
            await loadR2FileList();
        } else {
            showNotification('生成/同步失败: ' + (data.error || data.detail || '未知错误'), 'error');
        }
    } catch (e) {
        showNotification('生成/同步失败: ' + e.message, 'error');
    }
}

// 使用当前选择的 R2 对象恢复
async function restoreSelectedFromR2() {
    const select = document.getElementById('r2-file-list');
    const key = select && select.value ? select.value : '';
    if (!key) return alert('请先选择一个 R2 备份');
    if (!confirm('确定使用所选 R2 备份进行恢复吗？此操作将覆盖当前数据。')) return;

    try {
        const resp = await fetch(`/api/backup/r2/restore?key=${encodeURIComponent(key)}`, { method: 'POST' });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && (data.success || data.filename)) {
            showNotification('恢复成功', 'success');
        } else {
            showNotification('恢复失败: ' + (data.detail || data.error || '未知错误'), 'error');
        }
    } catch (e) {
        showNotification('恢复失败: ' + e.message, 'error');
    }
}

// 删除当前选择的 R2 对象
async function deleteSelectedFromR2() {
    const select = document.getElementById('r2-file-list');
    const key = select && select.value ? select.value : '';
    if (!key) return alert('请先选择一个 R2 备份');
    if (!confirm('确定删除所选 R2 对象吗？此操作不可恢复。')) return;
    try {
        const resp = await fetch(`/api/backup/r2/object?key=${encodeURIComponent(key)}`, { method: 'DELETE' });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data.success) {
            showNotification('删除成功', 'success');
            await loadR2FileList();
        } else {
            showNotification('删除失败: ' + (data.detail || data.error || '未知错误'), 'error');
        }
    } catch (e) {
        showNotification('删除失败: ' + e.message, 'error');
    }
}
async function testDatabaseConnection() {
    const statusElement = document.getElementById('db-connection-status');
    const timeElement = document.getElementById('db-response-time');

    if (statusElement) {
        statusElement.textContent = '测试中...';
        statusElement.style.background = '#f39c12'; // 橙色
    }

    if (timeElement) {
        timeElement.textContent = '--';
    }

    try {
        const response = await fetch('/api/system/db-test');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                if (statusElement) {
                    statusElement.textContent = '✅ 正常';
                    statusElement.style.background = '#27ae60'; // 绿色
                }
                if (timeElement && result.response_time_ms) {
                    timeElement.textContent = `${result.response_time_ms}ms`;
                }

                // 更新配置状态为已配置且可用
                updateDatabaseConfigStatus({
                    configured: true,
                    tested: true,
                    available: true
                });

                showNotification('数据库连接正常！', 'success');
            } else {
                if (statusElement) {
                    statusElement.textContent = '❌ 异常';
                    statusElement.style.background = '#e74c3c'; // 红色
                }
                if (timeElement) {
                    timeElement.textContent = '--';
                }

                // 更新配置状态为已配置但不可用
                updateDatabaseConfigStatus({
                    configured: true,
                    tested: true,
                    available: false
                });

                showNotification('数据库连接异常: ' + (result.message || '未知错误'), 'error');
            }
        } else {
            if (statusElement) {
                statusElement.textContent = '❌ 失败';
                statusElement.style.background = '#e74c3c'; // 红色
            }
            if (timeElement) {
                timeElement.textContent = '--';
            }

            // 更新配置状态为已配置但不可用
            updateDatabaseConfigStatus({
                configured: true,
                tested: true,
                available: false
            });

            showNotification('数据库连接测试失败', 'error');
        }
    } catch (error) {
        console.error('测试数据库连接失败:', error);
        if (statusElement) {
            statusElement.textContent = '❌ 错误';
            statusElement.style.background = '#e74c3c'; // 红色
        }
        if (timeElement) {
            timeElement.textContent = '--';
        }

        // 更新配置状态为已配置但不可用
        updateDatabaseConfigStatus({
            configured: true,
            tested: true,
            available: false
        });

        showNotification('测试失败: ' + error.message, 'error');
    }
}

// 刷新同步历史
async function refreshBackupHistory() {
    try {
        const response = await fetch('/api/backup/history');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                const backups = result.backups || [];
                updateBackupHistory(backups);

                // 更新最后同步信息
                if (backups.length > 0) {
                    const latestBackup = backups[0]; // 最新的同步
                    updateLastBackupInfo({
                        created_at: latestBackup.created_at,
                        size: latestBackup.size
                    });
                }
            } else {
                console.error('获取同步历史失败:', result.error);
            }
        }
    } catch (error) {
        console.error('刷新同步历史失败:', error);
    }
}

// 更新同步历史显示
function updateBackupHistory(backups) {
    const historyElement = document.getElementById('backup-history');
    if (!historyElement) return;

    if (backups.length === 0) {
        historyElement.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">暂无同步记录</div>';
        return;
    }

    let html = '';
    backups.slice(0, 10).forEach(backup => { // 只显示最近10个
        const date = new Date(backup.created_at).toLocaleString();
        const size = backup.size ? formatFileSize(backup.size) : '未知';
        html += `
            <div style="padding: 8px 0; border-bottom: 1px solid var(--glass-border);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 500;">${date}</span>
                    <span style="font-size: 0.8em; color: #6c757d;">${size}</span>
                </div>
                <div style="font-size: 0.8em; color: #6c757d; margin-top: 2px;">
                    ${backup.filename || '未知文件名'}
                </div>
            </div>
        `;
    });

    historyElement.innerHTML = html;
}

// 更新最后同步信息
function updateLastBackupInfo(backupInfo) {
    const timeElement = document.getElementById('last-db-backup');
    const sizeElement = document.getElementById('db-backup-size');

    if (timeElement && backupInfo.created_at) {
        timeElement.textContent = new Date(backupInfo.created_at).toLocaleString();
    }

    if (sizeElement && backupInfo.size) {
        sizeElement.textContent = formatFileSize(backupInfo.size);
    }
}

// 更新 R2 的最后同步信息（时间和大小）
function updateR2SyncStatus(syncInfo) {
    console.log('🔄 更新R2同步信息:', syncInfo);
    const timeElement = document.getElementById('last-r2-backup');
    const sizeElement = document.getElementById('r2-backup-size');

    if (timeElement && syncInfo && syncInfo.created_at) {
        timeElement.textContent = new Date(syncInfo.created_at).toLocaleString();
    }

    if (sizeElement && syncInfo && syncInfo.size) {
        sizeElement.textContent = formatFileSize(syncInfo.size);
    }

    // 如果 syncInfo 同时包含配置状态信息，尝试更新R2配置徽章和状态
    if (syncInfo && typeof syncInfo.configured !== 'undefined') {
        updateR2ConfigStatus({
            configured: syncInfo.configured,
            tested: !!syncInfo.tested,
            available: !!syncInfo.available
        });
    }
}

// 更新数据库配置状态
function updateDatabaseConfigStatus(statusInfo) {
    console.log('🔄 更新数据库配置状态:', statusInfo);
    const badgeElement = document.getElementById('db-config-badge');
    const statusElement = document.getElementById('db-connection-status');

    // 支持页面中可能存在重复的徽章元素（不同卡片），对所有匹配元素进行更新
    const badgeElements = document.querySelectorAll('#db-config-badge');
    if (badgeElements && badgeElements.length > 0) {
        badgeElements.forEach((el) => {
            if (statusInfo.configured === false) {
                el.textContent = '❌ 未配置';
                el.style.background = '#6c757d'; // 灰色
            } else if (statusInfo.configured === true && statusInfo.tested === false) {
                el.textContent = '⏳ 未验证';
                el.style.background = '#f39c12'; // 橙色
            } else if (statusInfo.configured === true && statusInfo.tested === true && statusInfo.available === true) {
                el.textContent = '✅ 已配置且可用';
                el.style.background = '#27ae60'; // 绿色
            } else if (statusInfo.configured === true && statusInfo.tested === true && statusInfo.available === false) {
                el.textContent = '⚠️ 已配置但不可用';
                el.style.background = '#e74c3c'; // 红色
            }
        });
        console.log('✅ 数据库徽章已更新 (多个元素)');
    } else {
        console.error('❌ 找不到数据库徽章元素 #db-config-badge');
    }

    if (statusElement) {
        if (statusInfo.tested === true) {
            if (statusInfo.available === true) {
                // 统一为“可用”以与 R2 文案保持一致
                statusElement.textContent = '✅ 可用';
                statusElement.style.background = '#27ae60';
            } else {
                statusElement.textContent = '❌ 异常';
                statusElement.style.background = '#e74c3c';
            }
        } else {
            statusElement.textContent = '未测试';
            statusElement.style.background = '#f39c12';
        }
    }
}

// 更新R2配置状态
function updateR2ConfigStatus(statusInfo) {
    console.log('🔄 更新R2配置状态:', statusInfo);
    const badgeElement = document.getElementById('r2-config-badge');
    const statusElement = document.getElementById('r2-sync-status');

    // 支持页面中可能存在重复的R2徽章元素，更新所有匹配元素
    const r2BadgeElements = document.querySelectorAll('#r2-config-badge');
    if (r2BadgeElements && r2BadgeElements.length > 0) {
        r2BadgeElements.forEach((el) => {
            if (statusInfo.configured === false) {
                el.textContent = '❌ 未配置';
                el.style.background = '#6c757d'; // 灰色
            } else if (statusInfo.configured === true && statusInfo.tested === false) {
                el.textContent = '⏳ 未验证';
                el.style.background = '#f39c12'; // 橙色
            } else if (statusInfo.configured === true && statusInfo.tested === true && statusInfo.available === true) {
                el.textContent = '✅ 已配置且可用';
                el.style.background = '#27ae60'; // 绿色
            } else if (statusInfo.configured === true && statusInfo.tested === true && statusInfo.available === false) {
                el.textContent = '⚠️ 已配置但不可用';
                el.style.background = '#e74c3c'; // 红色
            }
        });
        console.log('✅ R2徽章已更新 (多个元素)');
    } else {
        console.error('❌ 找不到R2徽章元素 #r2-config-badge');
    }

    if (statusElement) {
        if (statusInfo.tested === true) {
            if (statusInfo.available === true) {
                statusElement.textContent = '✅ 可用';
                statusElement.style.background = '#27ae60';
            } else {
                statusElement.textContent = '❌ 不可用';
                statusElement.style.background = '#e74c3c';
            }
        } else {
            statusElement.textContent = '未测试';
            statusElement.style.background = '#f39c12';
        }
    }
}

// 切换自动备份
function toggleAutoBackup() {
    const checkbox = document.querySelector('input[name="auto_backup_enabled"]');
    const isEnabled = checkbox.checked;

    showNotification(isEnabled ? '自动备份已启用' : '自动备份已禁用', 'info');
}

// 清理旧备份
async function cleanupOldBackups() {
    if (!confirm('确定要清理旧备份文件吗？此操作不可恢复！')) {
        return;
    }

    try {
        showNotification('正在清理旧备份...', 'info');

        const response = await fetch('/api/backup/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification(`清理完成！删除了 ${result.deleted_count || 0} 个旧备份文件`, 'success');
                refreshBackupHistory();
            } else {
                showNotification('清理失败: ' + (result.error || '未知错误'), 'error');
            }
        } else {
            showNotification('清理旧备份失败', 'error');
        }
    } catch (error) {
        console.error('清理旧备份失败:', error);
        showNotification('清理失败: ' + error.message, 'error');
    }
}

// 保存备份配置
async function saveBackupConfig() {
    try {
        const config = {};

        // 收集自动备份设置
        const autoBackupEnabled = document.querySelector('input[name="auto_backup_enabled"]');
        if (autoBackupEnabled) {
            config.auto_backup_enabled = autoBackupEnabled.checked;
        }

        // 收集备份间隔
        const backupInterval = document.querySelector('select[name="backup_interval"]');
        if (backupInterval) {
            // 将字符串值转换为小时数
            const intervalMap = {
                'daily': 24,
                'weekly': 168,
                'monthly': 720
            };
            config.backup_interval = intervalMap[backupInterval.value] || 24;
        }

        // 收集最大备份数量
        const maxBackups = document.querySelector('input[name="max_backups"]');
        if (maxBackups) {
            config.max_backups = parseInt(maxBackups.value) || 10;
        }

        // 收集保留天数
        const retentionDays = document.querySelector('input[name="retention_days"]');
        if (retentionDays) {
            config.retention_days = parseInt(retentionDays.value) || 30;
        }

        const response = await fetch('/api/backup/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('备份配置保存成功！', 'success');
            } else {
                showNotification('保存失败: ' + (result.error || '未知错误'), 'error');
            }
        } else {
            showNotification('备份配置保存失败', 'error');
        }
    } catch (error) {
        console.error('保存备份配置失败:', error);
        showNotification('保存失败: ' + error.message, 'error');
    }
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 初始化数据备份页面
async function initDataBackupPage() {
    try {
        console.log('🚀 开始初始化数据备份页面...');

        // 刷新部署模式信息
        await refreshDeploymentMode();

        // 加载可用的部署模式选项
        await loadAvailableModes();

        // 加载备份配置
        await loadBackupConfig();

    // 刷新同步历史（如果后端未实现，可忽略错误）
    try { await refreshBackupHistory(); } catch(_) {}

        // 加载系统资源信息
        await loadSystemResources();

    // 检查R2和数据库配置状态
    console.log('🔍 调用状态检查函数...');
    await checkR2Status();
    await loadBackupCategories();
    await loadExternalDBBackupList();
    await loadR2FileList();
    await checkDatabaseStatus();

    // 非阻塞：在后台触发 R2 与 数据库 连接测试，避免阻塞页面加载
    try{
        // 将状态标记为检测中
        updateR2ConfigStatus({ configured: true, tested: false, available: false });
        updateDatabaseConfigStatus({ configured: true, tested: false, available: false });

        // Fire-and-forget tests (they will update the UI when done)
        testR2Connection().catch(e=>console.warn('后台R2检测失败', e));
        testDatabaseConnection().catch(e=>console.warn('后台DB检测失败', e));
    }catch(e){
        console.warn('启动后台检测失败', e);
    }

        console.log('✅ 数据备份页面初始化完成');
    } catch (error) {
        console.error('❌ 初始化数据备份页面失败:', error);
    }
}

// 加载备份配置
async function loadBackupConfig() {
    try {
        const response = await fetch('/api/backup/config');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                const config = result.config;

                // 更新表单值
                const autoBackupEnabled = document.querySelector('input[name="auto_backup_enabled"]');
                const backupInterval = document.querySelector('select[name="backup_interval"]');
                const maxBackups = document.querySelector('input[name="max_backups"]');
                const retentionDays = document.querySelector('input[name="retention_days"]');

                if (autoBackupEnabled) autoBackupEnabled.checked = config.auto_backup_enabled;
                if (backupInterval) {
                    // 将小时数转换为字符串值
                    const intervalReverseMap = {
                        24: 'daily',
                        168: 'weekly',
                        720: 'monthly'
                    };
                    backupInterval.value = intervalReverseMap[config.backup_interval] || 'daily';
                }
                if (maxBackups) maxBackups.value = config.max_backups;
                if (retentionDays) retentionDays.value = config.retention_days;

                // 备份配置加载完成
            }
        } else {
            console.error('加载备份配置失败:', response.status);
        }
    } catch (error) {
        console.error('加载备份配置出错:', error);
    }
}

// 加载系统资源信息
async function loadSystemResources() {
    try {
        const response = await fetch('/api/system/resources');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                updateSystemResources(result.resources);
            }
        }
    } catch (error) {
        console.error('加载系统资源信息失败:', error);
    }
}

// 更新系统资源显示
function updateSystemResources(resources) {
    const memoryElement = document.getElementById('memory-usage');
    const diskElement = document.getElementById('disk-usage');
    const uptimeElement = document.getElementById('uptime');

    if (memoryElement && resources.memory) {
        memoryElement.textContent = `${resources.memory.used} / ${resources.memory.total}`;
    }

    if (diskElement && resources.disk) {
        diskElement.textContent = `${resources.disk.used} / ${resources.disk.total}`;
    }

    if (uptimeElement && resources.uptime) {
        uptimeElement.textContent = formatUptime(resources.uptime);
    }
}

// 检查R2配置状态
async function checkR2Status() {
    try {
        console.log('🔍 检查R2配置状态...');
    const response = await fetch('/api/system/r2-status');
        if (response.ok) {
            const result = await response.json();
            console.log('✅ R2 API响应:', result);
            if (result.success) {
                const r2Status = result.r2_status;
                console.log('📊 R2状态信息:', r2Status);

                // 更新R2配置状态
                updateR2ConfigStatus({
                    configured: r2Status.configured,
                    tested: false, // 配置检查不进行连接测试
                    available: false // 配置检查不进行连接测试
                });
                console.log('✅ R2状态已更新到UI');
            }
        } else {
            console.error('❌ R2 API请求失败:', response.status);
        }
    } catch (error) {
        console.error('❌ 检查R2状态失败:', error);

        // 如果检查失败，显示为未配置状态
        updateR2ConfigStatus({
            configured: false,
            tested: false,
            available: false
        });
    }

    // 额外：获取R2上最新的备份文件，用于初始化页面上的最后同步时间和大小显示
    try {
        const listResp = await fetch('/api/backup/r2/list');
        if (listResp.ok) {
            const listData = await listResp.json();
            if (listData && listData.items && listData.items.length > 0) {
                const latest = listData.items[0];
                // items use keys: key, size, last_modified
                const created_at = latest.last_modified || latest.backup_date || null;
                const size = latest.size || null;

                updateR2SyncStatus({
                    created_at: created_at,
                    size: size,
                    filename: latest.key
                });
            }
        }
    } catch (e) {
        console.warn('无法获取R2文件列表以初始化最后同步时间:', e);
    }
}

// 检查数据库配置状态
async function checkDatabaseStatus() {
    try {
        console.log('🔍 检查数据库配置状态...');
        const response = await fetch('/api/system/db-status');
        if (response.ok) {
            const result = await response.json();
            console.log('✅ 数据库API响应:', result);
            if (result.success) {
                const dbStatus = result.db_status;
                console.log('📊 数据库状态信息:', dbStatus);

                // 更新数据库配置状态
                updateDatabaseConfigStatus({
                    configured: dbStatus.configured,
                    tested: false, // 配置检查不进行连接测试
                    available: false // 配置检查不进行连接测试
                });
                console.log('✅ 数据库状态已更新到UI');
            }
        } else {
            console.error('❌ 数据库API请求失败:', response.status);
        }
    } catch (error) {
        console.error('❌ 检查数据库状态失败:', error);

        // 如果检查失败，显示为未配置状态
        updateDatabaseConfigStatus({
            configured: false,
            tested: false,
            available: false
        });
    }
}

// 测试R2连接
async function testR2Connection() {
    const statusElement = document.getElementById('r2-sync-status');

    if (statusElement) {
        statusElement.textContent = '测试中...';
        statusElement.style.background = '#f39c12'; // 橙色
    }

    try {
        const response = await fetch('/api/system/r2-test');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // 更新配置状态为已配置且可用
                updateR2ConfigStatus({
                    configured: true,
                    tested: true,
                    available: true
                });

                // 更新响应时间显示
                const timeElement = document.getElementById('r2-response-time');
                if (timeElement && result.response_time_ms) {
                    timeElement.textContent = `${result.response_time_ms}ms`;
                }

                showNotification('R2连接正常！', 'success');
            } else {
                // 更新配置状态为已配置但不可用
                updateR2ConfigStatus({
                    configured: true,
                    tested: true,
                    available: false
                });

                // 更新响应时间显示
                const timeElement = document.getElementById('r2-response-time');
                if (timeElement && result.response_time_ms) {
                    timeElement.textContent = `${result.response_time_ms}ms`;
                } else {
                    timeElement.textContent = '--';
                }

                showNotification('R2连接异常: ' + (result.message || '未知错误'), 'error');
            }
        } else {
            // 更新配置状态为已配置但不可用
            updateR2ConfigStatus({
                configured: true,
                tested: true,
                available: false
            });

            // 更新响应时间显示
            const timeElement = document.getElementById('r2-response-time');
            if (timeElement) {
                timeElement.textContent = '--';
            }

            showNotification('R2连接测试失败', 'error');
        }
    } catch (error) {
        console.error('测试R2连接失败:', error);

        // 更新配置状态为已配置但不可用
        updateR2ConfigStatus({
            configured: true,
            tested: true,
            available: false
        });

        // 更新响应时间显示
        const timeElement = document.getElementById('r2-response-time');
        if (timeElement) {
            timeElement.textContent = '--';
        }

        showNotification('测试失败: ' + error.message, 'error');
    }
}

// 格式化运行时间
function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);

    if (days > 0) {
        return `${days}天 ${hours}小时 ${minutes}分钟`;
    } else if (hours > 0) {
        return `${hours}小时 ${minutes}分钟`;
    } else {
        return `${minutes}分钟`;
    }
}

// 页面加载时初始化数据备份功能
document.addEventListener('DOMContentLoaded', function() {
    // 检查当前是否在数据备份标签页，如果是则初始化
    const dataBackupTab = document.getElementById('data-backup');
    if (dataBackupTab && dataBackupTab.classList.contains('active')) {
        // 标签页已激活，立即初始化
        setTimeout(() => {
            initDataBackupPage();
            loadExternalDBTypes();
        }, 500);
    }
    // 如果不在数据备份标签页，不需要初始化，会在切换时初始化
});

// 监听标签页切换事件
document.addEventListener('click', function(e) {
    if (e.target.closest('[data-tab="data-backup"]')) {
        // 切换到数据备份标签页时初始化
        setTimeout(() => {
            initDataBackupPage();
            loadExternalDBTypes();
        }, 100);
    }
});

// 注意：本页面的“数据库备份”下拉展示外部（R2）数据库备份列表，已不提供本地创建入口。

// 使用下拉框选择的“外部数据库备份”（本地文件）进行恢复
async function restoreSelectedDB() {
    const select = document.getElementById('db-file-list');
    const key = select && select.value ? select.value : '';
    if (!key) return alert('请先选择一个外部数据库备份');
    if (!confirm('确定要使用所选外部数据库备份进行恢复吗？此操作将覆盖当前数据。')) return;
    try {
        // 通过本地恢复接口恢复（文件名即本地备份名）
        const params = new URLSearchParams({ backup_name: key });
        const resp = await fetch(`/api/backup/local/restore?${params.toString()}`, { method: 'POST' });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && (data.success || data.filename)) {
            showNotification('恢复成功', 'success');
        } else {
            showNotification('恢复失败: ' + (data.detail || data.error || '未知错误'), 'error');
        }
    } catch (e) {
        showNotification('恢复失败: ' + e.message, 'error');
    }
}

// 删除选择的“外部数据库备份”（本地文件）
async function deleteSelectedDB() {
    const select = document.getElementById('db-file-list');
    const key = select && select.value ? select.value : '';
    if (!key) return alert('请先选择一个外部数据库备份');
    if (!confirm('确定删除所选外部数据库备份吗？此操作不可恢复。')) return;
    try {
        const params = new URLSearchParams({ backup_name: key });
        const resp = await fetch(`/api/backup/local?${params.toString()}`, { method: 'DELETE' });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data.success) {
            showNotification('删除成功', 'success');
            await loadExternalDBBackupList();
        } else {
            showNotification('删除失败: ' + (data.detail || data.error || '未知错误'), 'error');
        }
    } catch (e) {
        showNotification('删除失败: ' + e.message, 'error');
    }
}

// 监听页面可见性变化，当用户回到页面时重新检查数据库连接
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // 页面变为可见时，重新检查数据库连接状态
        const dataBackupTab = document.getElementById('data-backup');
        if (dataBackupTab && dataBackupTab.classList.contains('active')) {
            // 只有在数据备份标签页激活时才检查
            setTimeout(() => {
                testDatabaseConnection();
            }, 500);
        }
    }
});
</script>
<script>
// 从 ai_config_buckup.html 移植的批量粘贴解析和 R2 状态绑定函数
function showBulkPasteModal(){
    const m = document.getElementById('bulk-paste-modal');
    if(m) {
        m.style.display = 'flex';
        // 重置状态
        const ta = document.getElementById('bulk-paste-text');
        if(ta) ta.value = '';
        const preview = document.getElementById('bulk-paste-preview');
        if(preview) preview.style.display = 'none';
        const status = document.getElementById('parse-status');
        if(status) status.textContent = '准备解析配置...';
        const applyBtn = document.getElementById('apply-btn-text');
        if(applyBtn) applyBtn.textContent = '✅ 解析并应用';
        const progress = document.getElementById('apply-btn-progress');
        if(progress) progress.style.display = 'none';
    }
}

function hideBulkPasteModal(){
    const m = document.getElementById('bulk-paste-modal');
    if(m) m.style.display = 'none';
}

async function refreshConfigFromServer(){
    try{
        const resp = await fetch('/api/config/all');
        if(resp.ok){
            const config = await resp.json();
            // Update form fields with current config
            for(const [key, value] of Object.entries(config)){
                const el = document.querySelector(`[name='${key}']`);
                if(el && el.type !== 'password'){ // Don't overwrite password fields
                    el.value = value || '';
                }
            }
        }
    }catch(e){
        console.warn('Failed to refresh config from server:', e);
    }
}

function parseKeyValues(raw){
    const result = {};
    if(!raw) return result;
    const lines = raw.split(/\r?\n|;/);
    for(let l of lines){
        l = l.trim();
        if(!l) continue;
        if(l.startsWith('#')) continue;
        const idx = l.indexOf('=');
        if(idx === -1) continue;
        const k = l.substring(0, idx).trim();
        let v = l.substring(idx+1).trim();
        // Strip surrounding quotes
        if((v.startsWith('"') && v.endsWith('"')) || (v.startsWith("'") && v.endsWith("'"))){
            v = v.slice(1, -1);
        }
        if(k) result[k] = v;
    }
    return result;
}

function updateBulkPastePreview(){
    const raw = document.getElementById('bulk-paste-text').value || '';
    const kv = parseKeyValues(raw);
    const preview = document.getElementById('bulk-paste-preview');
    const previewItems = document.getElementById('preview-items');
    const status = document.getElementById('parse-status');

    if(Object.keys(kv).length > 0){
        preview.style.display = 'block';
        const items = Object.entries(kv).map(([key, value]) => {
            const displayKey = key.toLowerCase();
            const isSensitive = ['secret', 'key', 'password', 'token'].some(term => displayKey.includes(term));
            const maskedValue = isSensitive ? '••••••••' : value;
            return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 12px;">
                <span style="color: #0366d6; font-weight: 500;">${key}</span>
                <span style="color: #586069; margin: 0 8px;">→</span>
                <span style="color: #24292f;">${maskedValue}</span>
            </div>`;
        }).join('');
        previewItems.innerHTML = items;
        status.textContent = `已解析 ${Object.keys(kv).length} 个配置项`;
    } else {
        preview.style.display = 'none';
        status.textContent = '准备解析配置...';
    }
}

async function applyBulkPaste(){
    const raw = document.getElementById('bulk-paste-text').value || '';
    const kv = parseKeyValues(raw);

    if(Object.keys(kv).length === 0){
        alert('未检测到有效的配置项，请检查输入格式');
        return;
    }

    // 显示加载状态
    const applyBtn = document.getElementById('apply-btn-text');
    const progress = document.getElementById('apply-btn-progress');
    const status = document.getElementById('parse-status');

    if(applyBtn) applyBtn.textContent = '处理中...';
    if(progress) progress.style.display = 'flex';
    if(status) status.textContent = '正在应用配置...';

    const mapping = {
        // General mapping: convert to lowercase
    };

    // 填充表单字段
    for(const [k,v] of Object.entries(kv)){
        const name = k.toLowerCase();
        const el = document.querySelector(`[name='${name}']`);
        if(el) el.value = v;
    }

    try{
        const resp = await fetch('/api/config/parse-and-apply',{
            method:'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({config:{raw}})
        });
        const data = await resp.json().catch(()=>null);

        if(resp.ok && data && data.success){
            if(status) status.textContent = '✅ 配置应用成功';
            setTimeout(() => {
                alert('解析并保存成功，R2 配置完整: ' + (data.r2_configured ? '是' : '否'));
                refreshConfigFromServer().catch(e => console.warn('refresh after parse failed', e));
                hideBulkPasteModal();
            }, 500);
        } else {
            if(status) status.textContent = '❌ 配置应用失败';
            if(progress) progress.style.display = 'none';
            if(applyBtn) applyBtn.textContent = '✅ 解析并应用';
            alert('解析或保存失败: ' + (data && (data.errors || data.message) ? JSON.stringify(data.errors || data.message) : 'Unknown'));
        }
    }catch(e){
        console.error(e);
        if(status) status.textContent = '❌ 网络请求失败';
        if(progress) progress.style.display = 'none';
        if(applyBtn) applyBtn.textContent = '✅ 解析并应用';
        alert('调用解析接口失败，请查看控制台');
    }
}

// 添加实时预览监听器
document.addEventListener('DOMContentLoaded', function(){
    const textarea = document.getElementById('bulk-paste-text');
    if(textarea){
        textarea.addEventListener('input', updateBulkPastePreview);
        textarea.addEventListener('paste', function(){
            setTimeout(updateBulkPastePreview, 100);
        });
    }
});
</script>
{% endblock %}