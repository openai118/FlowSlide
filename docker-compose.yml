# LandPPT Docker Compose Configuration
# Enhanced version with database health checks

version: '3.8'

services:
  landppt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: landppt-app
    ports:
      - "8000:8000"
    environment:
      # Application settings
      - PYTHONPATH=/app/src:/opt/venv
      - PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright
      
      # Database settings
      - DB_HOST=your-supabase-host
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-postgres}
      - DB_USER=your_db_user
      - DB_PASSWORD=your_secure_password
      
      # Supabase settings
      - SUPABASE_URL=https://your-project.supabase.co
      - SUPABASE_ANON_KEY=your_supabase_anon_key
      - SUPABASE_SERVICE_KEY=your_supabase_service_key
      
      # Storage settings
      - STORAGE_BUCKET=your-storage-bucket
      - STORAGE_PROVIDER=supabase
      
      # Cloudflare R2 Backup Configuration
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - BACKUP_WEBHOOK_URL=${BACKUP_WEBHOOK_URL}
      
      # Health check settings
      - SKIP_DB_CHECK=false
      - REQUIRE_DB=true
      - RUN_DB_SCHEMA_CHECK=true
      
      # Performance settings
      - PYTHONOPTIMIZE=1
      - PYTHONHASHSEED=random
      - PYTHONGC=0
      
    volumes:
      # Persistent data
      - landppt_data:/app/data
      - landppt_uploads:/app/uploads
      - landppt_temp:/app/temp
      - landppt_logs:/app/logs
      
      # Cache directories
      - playwright_cache:/root/.cache/ms-playwright
      
    restart: unless-stopped
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # Health check configuration
    healthcheck:
      test: ["CMD", "./docker-healthcheck-enhanced.sh"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 60s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Database health monitoring service
  db-monitor:
    build:
      context: .
      dockerfile: Dockerfile.enhanced
    container_name: landppt-db-monitor
    entrypoint: ["python3", "/app/tools/database_health_check.py", "--non-interactive"]
    environment:
      - DB_HOST=your-supabase-host
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-postgres}
      - DB_USER=your_db_user
      - DB_PASSWORD=your_secure_password
      - SUPABASE_URL=https://your-project.supabase.co
      - SUPABASE_SERVICE_KEY=your_supabase_service_key
    volumes:
      - landppt_logs:/app/logs
    restart: "no"
    profiles:
      - monitoring

volumes:
  landppt_data:
    driver: local
  landppt_uploads:
    driver: local
  landppt_temp:
    driver: local
  landppt_logs:
    driver: local
  playwright_cache:
    driver: local

# Network configuration
networks:
  default:
    name: landppt-network
