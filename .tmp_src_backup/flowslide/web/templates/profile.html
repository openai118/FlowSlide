{% extends "base.html" %}

{% block title %}用户资料 - FlowSlide{% endblock %}

{% block extra_css %}
<style>
    .profile-muted { color: var(--text-secondary); }
    /* Use the same surface tokens as .card for visual unity */
    .profile-panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; padding: 20px; }
    .accent-blue { color: var(--accent-blue); }
    .accent-red { color: var(--accent-red); }
    .accent-green { color: var(--accent-green); }
    .accent-yellow { color: var(--accent-yellow); }
    .badge-chip { color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; display: inline-block; }
    .chip-blue { background: var(--accent-blue); }
    .chip-red { background: var(--accent-red); }
</style>
{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 40px;">
        <h2 style="margin-bottom: 20px;">👤 用户资料</h2>
        <p class="profile-muted" style="font-size: 1.1em;">
        管理您的账户信息和安全设置
    </p>
</div>

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

{% if success %}
<div class="alert alert-success">
    {{ success }}
</div>
{% endif %}

<div class="grid">
    <div class="card">
    <h3 class="accent-blue" style="margin-bottom: 20px;">📋 基本信息</h3>
        
    <div class="profile-panel">
            <form id="basicInfoForm" onsubmit="return updateBasicInfo(event)">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" name="username" value="{{ user.username }}" minlength="3" maxlength="32" required>
                </div>
                <div class="form-group">
                    <label for="email">邮箱</label>
                    <input type="email" id="email" name="email" value="{{ user.email or '' }}" placeholder="可选">
                </div>
                <div style="text-align:center;">
                    <button type="submit" class="btn btn-primary">💾 保存基本信息</button>
                </div>
            </form>
            
            <div style="margin-bottom: 15px;">
                <strong>账户状态:</strong> 
                {% if user.is_active %}
            <span style="color: var(--accent-green);">✅ 活跃</span>
                {% else %}
            <span style="color: var(--accent-red);">❌ 已禁用</span>
                {% endif %}
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>权限级别:</strong> 
                {% if user.is_admin %}
            <span class="badge-chip chip-red">
                        👑 管理员
                    </span>
                {% else %}
            <span class="badge-chip chip-blue">
                        👤 普通用户
                    </span>
                {% endif %}
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>注册时间:</strong> 
                <span class="profile-muted js-ts" data-ts="{{ user.created_at|default(0)|int }}"></span>
            </div>
            
            {% if user.last_login %}
            <div>
                <strong>最后登录:</strong> 
                <span class="profile-muted js-ts" data-ts="{{ user.last_login|default(0)|int }}"></span>
            </div>
            {% endif %}
    </div>
    </div>
    
    <div class="card">
    <h3 class="accent-red" style="margin-bottom: 20px;">🔒 修改密码</h3>
        
        <form method="post" action="/auth/change-password">
            <div class="form-group">
                <label for="current_password">当前密码:</label>
                <input type="password" id="current_password" name="current_password" required 
                       placeholder="请输入当前密码">
            </div>
            
            <div class="form-group">
                <label for="new_password">新密码:</label>
                <input type="password" id="new_password" name="new_password" required 
                       placeholder="请输入新密码" minlength="6">
        <small class="profile-muted">密码长度至少6位</small>
            </div>
            
            <div class="form-group">
                <label for="confirm_password">确认新密码:</label>
                <input type="password" id="confirm_password" name="confirm_password" required 
                       placeholder="请再次输入新密码">
            </div>
            
            <div style="text-align: center;">
                <button type="submit" class="btn btn-warning">
                    🔒 修改密码
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card" style="margin-top: 30px;">
    <h3 class="accent-green" style="margin-bottom: 20px;">⚙️ 快速操作</h3>
    
    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <a href="/dashboard" class="btn btn-primary">
            📈 项目仪表板
        </a>
        
        <a href="/ai-config" class="btn btn-info">
            🤖 AI配置
        </a>

        {% if user.is_admin %}
        <a href="/admin/users" class="btn btn-secondary">
            👥 用户管理
        </a>
        {% endif %}
        
        <a href="/auth/logout" class="btn btn-secondary" 
           onclick="return confirm('确定要退出登录吗？')">
            🚪 退出登录
        </a>
    </div>
 </div>

<div class="profile-panel" style="margin-top: 40px; border-radius: 15px;">
    <h3 style="margin-bottom: 20px; text-align: center;">💡 安全提示</h3>
    
    <div class="grid">
        <div>
            <h4 class="accent-blue" style="margin-bottom: 10px;">🔐 密码安全</h4>
            <p class="profile-muted" style="line-height: 1.6;">
                请定期更换密码，使用包含字母、数字和特殊字符的强密码。
            </p>
        </div>
        
        <div>
            <h4 class="accent-green" style="margin-bottom: 10px;">🔒 会话管理</h4>
            <p class="profile-muted" style="line-height: 1.6;">
                在公共设备上使用后，请及时退出登录以保护账户安全。
            </p>
        </div>
        
        <div>
            <h4 class="accent-yellow" style="margin-bottom: 10px;">📧 邮箱验证</h4>
            <p class="profile-muted" style="line-height: 1.6;">
                绑定邮箱可以帮助您在忘记密码时快速恢复账户。
            </p>
        </div>
        
        <div>
            <h4 class="accent-red" style="margin-bottom: 10px;">⚠️ 异常活动</h4>
            <p class="profile-muted" style="line-height: 1.6;">
                如发现账户异常活动，请立即修改密码并联系管理员。
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 密码确认验证
document.getElementById('confirm_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;
    
    if (newPassword && confirmPassword && newPassword !== confirmPassword) {
        this.setCustomValidity('密码不匹配');
    } else {
        this.setCustomValidity('');
    }
});

document.getElementById('new_password').addEventListener('input', function() {
    const confirmPassword = document.getElementById('confirm_password');
    if (confirmPassword.value) {
        confirmPassword.dispatchEvent(new Event('input'));
    }
});

// 渲染时间戳（秒）到本地时间
(function(){
    var nodes = document.querySelectorAll('.js-ts[data-ts]');
    nodes.forEach(function(n){
        var v = parseInt(n.getAttribute('data-ts') || '0', 10);
        if (!isNaN(v) && v > 0) {
            n.textContent = new Date(v * 1000).toLocaleString('zh-CN');
        }
    });
})();

// 更新基本信息
async function updateBasicInfo(e){
    e.preventDefault();
    const form = document.getElementById('basicInfoForm');
    const fd = new FormData(form);
    try {
        const res = await fetch('/api/auth/profile/update', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.detail || '保存失败');
        // 简单刷新以获取最新 user 数据
        location.reload();
    } catch(err){
        alert('保存失败：' + err.message);
    }
    return false;
}
</script>
{% endblock %}
