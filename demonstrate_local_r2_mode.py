#!/usr/bin/env python3
"""
LOCAL_R2æ¨¡å¼æ¼”ç¤ºè„šæœ¬
å±•ç¤ºå•å‘å¤‡ä»½æœºåˆ¶å’Œæ•°æ®å¤„ç†æ–¹å¼
"""

import sys
import os
sys.path.append('src')

from flowslide.core.sync_strategy_config import DataSyncStrategy, DeploymentMode


def demonstrate_local_r2_mode():
    """æ¼”ç¤ºLOCAL_R2æ¨¡å¼çš„åŒæ­¥ç­–ç•¥"""
    print("ğŸ” LOCAL_R2æ¨¡å¼åŒæ­¥ç­–ç•¥æ¼”ç¤º")
    print("=" * 50)

    # æ¨¡æ‹ŸLOCAL_R2ç¯å¢ƒ
    original_env = dict(os.environ)
    os.environ["R2_ACCESS_KEY_ID"] = "demo_access_key"
    os.environ["R2_SECRET_ACCESS_KEY"] = "demo_secret_key"
    os.environ["R2_ENDPOINT"] = "https://demo.r2.cloudflarestorage.com"
    os.environ["R2_BUCKET_NAME"] = "demo-bucket"

    # æ¸…é™¤å¤–éƒ¨æ•°æ®åº“é…ç½®
    os.environ.pop("DATABASE_URL", None)

    try:
        # åˆ›å»ºç­–ç•¥é…ç½®å®ä¾‹
        strategy = DataSyncStrategy()

        print(f"ğŸ“Š æ£€æµ‹åˆ°çš„éƒ¨ç½²æ¨¡å¼: {strategy.deployment_mode.value}")
        print()

        # å±•ç¤ºå„æ•°æ®ç±»å‹çš„åŒæ­¥ç­–ç•¥
        print("ğŸ“‹ æ•°æ®åŒæ­¥ç­–ç•¥è¯¦æƒ…:")
        print("-" * 40)

        for data_type, config in strategy.sync_strategies.items():
            print(f"\nğŸ”¹ {data_type.upper()}:")
            print(f"   åŒæ­¥å¯ç”¨: {'âœ… æ˜¯' if config['sync_enabled'] else 'âŒ å¦'}")
            print(f"   åŒæ­¥æ–¹å‘: {config['directions']}")
            print(f"   åŒæ­¥é—´éš”: {config['interval_seconds']}ç§’ ({config['interval_seconds']//60}åˆ†é’Ÿ)")
            print(f"   æ‰¹å¤„ç†å¤§å°: {config['batch_size']}")
            print(f"   åŒæ­¥ç­–ç•¥: {config['strategy']}")

            # è§£é‡Šç­–ç•¥å«ä¹‰
            if config['strategy'] == 'backup_only':
                print("   ğŸ’¡ ç­–ç•¥è¯´æ˜: ä»…å¤‡ä»½åˆ°R2ï¼Œä¸è¿›è¡ŒåŒå‘åŒæ­¥")
            elif config['strategy'] == 'local_only':
                print("   ğŸ’¡ ç­–ç•¥è¯´æ˜: ä»…ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸åŒæ­¥")
            else:
                print(f"   ğŸ’¡ ç­–ç•¥è¯´æ˜: {config['strategy']}ç­–ç•¥")

        print("\n" + "=" * 50)
        print("ğŸ¯ LOCAL_R2æ¨¡å¼ç‰¹ç‚¹æ€»ç»“:")
        print()
        print("1ï¸âƒ£ å•å‘å¤‡ä»½æœºåˆ¶:")
        print("   â€¢ æ‰€æœ‰æ•°æ®åªä»æœ¬åœ°å¤‡ä»½åˆ°R2")
        print("   â€¢ ä¸ä»R2åŒæ­¥æ•°æ®åˆ°æœ¬åœ°")
        print("   â€¢ é¿å…äº†åŒå‘åŒæ­¥çš„å¤æ‚æ€§")
        print()
        print("2ï¸âƒ£ ç”¨æˆ·æ•°æ®å¤„ç†:")
        print("   â€¢ ç”¨æˆ·æ•°æ®å®šæœŸå¤‡ä»½åˆ°R2ï¼ˆ10åˆ†é’Ÿé—´éš”ï¼‰")
        print("   â€¢ æœ¬åœ°ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€ç­‰å¾…åŒæ­¥")
        print("   â€¢ R2å¤‡ä»½ç”¨äºç¾éš¾æ¢å¤")
        print()
        print("3ï¸âƒ£ é¡¹ç›®æ•°æ®å¤„ç†:")
        print("   â€¢ é¡¹ç›®åŸºæœ¬ä¿¡æ¯å®šæœŸå¤‡ä»½ï¼ˆ10åˆ†é’Ÿï¼‰")
        print("   â€¢ å¹»ç¯ç‰‡å†…å®¹æŒ‰éœ€å¤‡ä»½ï¼ˆ30åˆ†é’Ÿï¼‰")
        print("   â€¢ æ¨¡æ¿æ•°æ®å®šæœŸå¤‡ä»½ï¼ˆ1å°æ—¶ï¼‰")
        print()
        print("4ï¸âƒ£ æ•°æ®æ¢å¤æœºåˆ¶:")
        print("   â€¢ å¯ä»R2æ¢å¤å†å²å¤‡ä»½")
        print("   â€¢ æ¢å¤æ“ä½œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ")
        print("   â€¢ æ¢å¤æ—¶ä¼šè¦†ç›–æœ¬åœ°æ•°æ®")

    finally:
        # æ¢å¤ç¯å¢ƒå˜é‡
        os.environ.clear()
        os.environ.update(original_env)


def demonstrate_backup_operations():
    """æ¼”ç¤ºå¤‡ä»½æ“ä½œæµç¨‹"""
    print("\nğŸ”„ å¤‡ä»½æ“ä½œæµç¨‹æ¼”ç¤º")
    print("=" * 50)

    print("ğŸ“¦ æœ¬åœ°æ•°æ®å¤‡ä»½åˆ°R2çš„æµç¨‹:")
    print()
    print("1ï¸âƒ£ å®šæ—¶è§¦å‘å¤‡ä»½ä»»åŠ¡")
    print("   â€¢ æ¯10åˆ†é’Ÿæ£€æŸ¥ç”¨æˆ·/é¡¹ç›®æ•°æ®å˜æ›´")
    print("   â€¢ æ¯30åˆ†é’Ÿæ£€æŸ¥å¹»ç¯ç‰‡å†…å®¹å˜æ›´")
    print("   â€¢ æ¯1å°æ—¶æ£€æŸ¥æ¨¡æ¿æ•°æ®å˜æ›´")
    print()
    print("2ï¸âƒ£ æ•°æ®å‡†å¤‡é˜¶æ®µ")
    print("   â€¢ ä»æœ¬åœ°SQLiteæå–å˜æ›´æ•°æ®")
    print("   â€¢ å‹ç¼©æ•°æ®ä»¥å‡å°‘ä¼ è¾“é‡")
    print("   â€¢ ç”Ÿæˆå¤‡ä»½æ¸…å•å’Œå…ƒæ•°æ®")
    print()
    print("3ï¸âƒ£ R2ä¸Šä¼ é˜¶æ®µ")
    print("   â€¢ ä½¿ç”¨rcloneå·¥å…·ä¸Šä¼ åˆ°R2")
    print("   â€¢ ä¸Šä¼ è·¯å¾„: r2://bucket/backups/YYYYMMDD_HHMMSS/")
    print("   â€¢ åŒ…å«: æ•°æ®åº“ã€æ–‡ä»¶ã€é…ç½®ã€æ—¥å¿—")
    print()
    print("4ï¸âƒ£ å¤‡ä»½éªŒè¯é˜¶æ®µ")
    print("   â€¢ éªŒè¯ä¸Šä¼ æ–‡ä»¶å®Œæ•´æ€§")
    print("   â€¢ æ›´æ–°å¤‡ä»½æ¸…å•")
    print("   â€¢ å‘é€å¤‡ä»½å®Œæˆé€šçŸ¥")
    print()
    print("5ï¸âƒ£ æ¸…ç†é˜¶æ®µ")
    print("   â€¢ åˆ é™¤æœ¬åœ°ä¸´æ—¶å¤‡ä»½æ–‡ä»¶")
    print("   â€¢ æ¸…ç†è¶…è¿‡30å¤©çš„æ—§å¤‡ä»½")


def demonstrate_data_recovery():
    """æ¼”ç¤ºæ•°æ®æ¢å¤æµç¨‹"""
    print("\nğŸ”„ æ•°æ®æ¢å¤æµç¨‹æ¼”ç¤º")
    print("=" * 50)

    print("ğŸ“¥ ä»R2æ¢å¤æ•°æ®çš„æµç¨‹:")
    print()
    print("1ï¸âƒ£ é€‰æ‹©æ¢å¤ç‚¹")
    print("   â€¢ åˆ—å‡ºR2ä¸­çš„æ‰€æœ‰å¤‡ä»½ç‰ˆæœ¬")
    print("   â€¢ é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½æ—¥æœŸæ—¶é—´")
    print("   â€¢ ç¡®è®¤æ¢å¤èŒƒå›´ï¼ˆå…¨éƒ¨/æ•°æ®åº“/æ–‡ä»¶/é…ç½®ï¼‰")
    print()
    print("2ï¸âƒ£ æ¢å¤å‡†å¤‡")
    print("   â€¢ å¤‡ä»½å½“å‰æœ¬åœ°æ•°æ®ï¼ˆå®‰å…¨èµ·è§ï¼‰")
    print("   â€¢ åœæ­¢ç›¸å…³æœåŠ¡è¿›ç¨‹")
    print("   â€¢ å‡†å¤‡æ¢å¤ç¯å¢ƒ")
    print()
    print("3ï¸âƒ£ æ•°æ®ä¸‹è½½")
    print("   â€¢ ä»R2ä¸‹è½½é€‰å®šçš„å¤‡ä»½æ–‡ä»¶")
    print("   â€¢ éªŒè¯ä¸‹è½½æ–‡ä»¶å®Œæ•´æ€§")
    print("   â€¢ è§£å‹å¤‡ä»½æ–‡ä»¶")
    print()
    print("4ï¸âƒ£ æ•°æ®æ¢å¤")
    print("   â€¢ æ¢å¤æ•°æ®åº“ï¼ˆè¦†ç›–ç°æœ‰æ•°æ®ï¼‰")
    print("   â€¢ æ¢å¤åº”ç”¨æ–‡ä»¶å’Œé…ç½®")
    print("   â€¢ æ¢å¤æ—¥å¿—æ–‡ä»¶")
    print()
    print("5ï¸âƒ£ æ¢å¤éªŒè¯")
    print("   â€¢ æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§")
    print("   â€¢ éªŒè¯åº”ç”¨åŠŸèƒ½")
    print("   â€¢ é‡å¯ç›¸å…³æœåŠ¡")
    print()
    print("6ï¸âƒ£ æ¸…ç†å·¥ä½œ")
    print("   â€¢ åˆ é™¤ä¸‹è½½çš„ä¸´æ—¶æ–‡ä»¶")
    print("   â€¢ è®°å½•æ¢å¤æ“ä½œæ—¥å¿—")


def show_user_data_handling():
    """å±•ç¤ºç”¨æˆ·æ•°æ®å¤„ç†æ–¹å¼"""
    print("\nğŸ‘¤ LOCAL_R2æ¨¡å¼ä¸‹çš„ç”¨æˆ·æ•°æ®å¤„ç†")
    print("=" * 50)

    print("ğŸ” ç”¨æˆ·è®¤è¯å’Œæ•°æ®å¤„ç†:")
    print()
    print("1ï¸âƒ£ ç”¨æˆ·æ³¨å†Œ/ç™»å½•:")
    print("   â€¢ åœ¨æœ¬åœ°SQLiteä¸­ç«‹å³åˆ›å»º/éªŒè¯ç”¨æˆ·")
    print("   â€¢ ç”¨æˆ·å¯ä»¥ç«‹å³ä½¿ç”¨ç³»ç»Ÿ")
    print("   â€¢ æ— éœ€ç­‰å¾…ä»»ä½•åŒæ­¥æ“ä½œ")
    print()
    print("2ï¸âƒ£ ç”¨æˆ·æ•°æ®å˜æ›´:")
    print("   â€¢ å¯†ç ä¿®æ”¹ã€é‚®ç®±æ›´æ–°ç­‰ç«‹å³ç”Ÿæ•ˆ")
    print("   â€¢ æœ¬åœ°æ•°æ®åº“å®æ—¶æ›´æ–°")
    print("   â€¢ ç”¨æˆ·ä½“éªŒä¸çº¯æœ¬åœ°æ¨¡å¼ç›¸åŒ")
    print()
    print("3ï¸âƒ£ å®šæœŸå¤‡ä»½:")
    print("   â€¢ æ¯10åˆ†é’Ÿè‡ªåŠ¨å¤‡ä»½ç”¨æˆ·æ•°æ®åˆ°R2")
    print("   â€¢ å¤‡ä»½åŒ…å«æ‰€æœ‰ç”¨æˆ·è´¦æˆ·ä¿¡æ¯")
    print("   â€¢ ç”¨äºç¾éš¾æ¢å¤å’Œæ•°æ®å®‰å…¨")
    print()
    print("4ï¸âƒ£ ç¾éš¾æ¢å¤:")
    print("   â€¢ ä»R2æ¢å¤ç”¨æˆ·æ•°æ®")
    print("   â€¢ æ¢å¤åç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨")
    print("   â€¢ æ¢å¤æœŸé—´æœåŠ¡å¯èƒ½çŸ­æš‚ä¸­æ–­")
    print()
    print("ğŸ’¡ å…³é”®ä¼˜åŠ¿:")
    print("   â€¢ ç”¨æˆ·ä½“éªŒä¸çº¯æœ¬åœ°æ¨¡å¼æ— å·®å¼‚")
    print("   â€¢ æ•°æ®å®‰å…¨æ€§é€šè¿‡äº‘å¤‡ä»½å¾—åˆ°ä¿è¯")
    print("   â€¢ æˆæœ¬ä½å»‰ï¼ˆä»…å¤‡ä»½ï¼Œä¸åŒæ­¥ï¼‰")
    print("   â€¢ é€‚åˆä¸ªäººç”¨æˆ·å’Œå°å‹å›¢é˜Ÿ")


def show_backup_data_access():
    """å±•ç¤ºå¤‡ä»½æ•°æ®çš„è®¿é—®æ–¹å¼"""
    print("\nğŸ“‚ å¤‡ä»½æ•°æ®çš„è®¿é—®å’ŒæŸ¥çœ‹")
    print("=" * 50)

    print("ğŸ” R2å¤‡ä»½æ•°æ®çš„è®¿é—®æ–¹å¼:")
    print()
    print("1ï¸âƒ£ å¤‡ä»½æ¸…å•æŸ¥çœ‹:")
    print("   â€¢ ä½¿ç”¨ restore_from_r2.sh -l æŸ¥çœ‹æ‰€æœ‰å¤‡ä»½")
    print("   â€¢ æ˜¾ç¤ºå¤‡ä»½æ—¶é—´ã€å¤§å°ã€åŒ…å«çš„å†…å®¹")
    print("   â€¢ å¤‡ä»½è·¯å¾„æ ¼å¼: YYYYMMDD_HHMMSS")
    print()
    print("2ï¸âƒ£ å¤‡ä»½å†…å®¹é¢„è§ˆ:")
    print("   â€¢ ä½¿ç”¨ restore_from_r2.sh -i <æ—¥æœŸ> æŸ¥çœ‹è¯¦æƒ…")
    print("   â€¢ æ˜¾ç¤ºå¤‡ä»½æ¸…å•JSONæ–‡ä»¶")
    print("   â€¢ åŒ…å«æ•°æ®åº“ã€æ–‡ä»¶ã€é…ç½®ç­‰ä¿¡æ¯")
    print()
    print("3ï¸âƒ£ é€‰æ‹©æ€§æ¢å¤:")
    print("   â€¢ -d: åªæ¢å¤æ•°æ®åº“")
    print("   â€¢ -f: åªæ¢å¤æ–‡ä»¶")
    print("   â€¢ -c: åªæ¢å¤é…ç½®")
    print("   â€¢ æ— å‚æ•°: å®Œæ•´æ¢å¤")
    print()
    print("4ï¸âƒ£ å‰ç«¯æŸ¥çœ‹å†å²PPT:")
    print("   â€¢ æ¢å¤å¤‡ä»½åˆ°æœ¬åœ°åå¯æ­£å¸¸æŸ¥çœ‹")
    print("   â€¢ å¤‡ä»½ä¸­çš„PPTæ–‡ä»¶å¯ç›´æ¥æ‰“å¼€")
    print("   â€¢ å†å²ç‰ˆæœ¬å¯é€šè¿‡é¡¹ç›®ç‰ˆæœ¬ç®¡ç†æŸ¥çœ‹")
    print()
    print("âš ï¸ é‡è¦è¯´æ˜:")
    print("   â€¢ R2ä¸­çš„å¤‡ä»½æ•°æ®ä¸ä¼šç›´æ¥åœ¨å‰ç«¯æ˜¾ç¤º")
    print("   â€¢ éœ€è¦å…ˆæ¢å¤åˆ°æœ¬åœ°æ‰èƒ½æŸ¥çœ‹å’Œä½¿ç”¨")
    print("   â€¢ æ¢å¤æ“ä½œä¼šè¦†ç›–å½“å‰æœ¬åœ°æ•°æ®")
    print("   â€¢ å»ºè®®åœ¨æ¢å¤å‰å¤‡ä»½å½“å‰æ•°æ®")


def main():
    """ä¸»æ¼”ç¤ºå‡½æ•°"""
    print("ğŸ¬ FlowSlide LOCAL_R2æ¨¡å¼è¯¦ç»†æ¼”ç¤º")
    print("=" * 60)

    demonstrate_local_r2_mode()
    demonstrate_backup_operations()
    demonstrate_data_recovery()
    show_user_data_handling()
    show_backup_data_access()

    print("\n" + "=" * 60)
    print("ğŸ¯ LOCAL_R2æ¨¡å¼æ€»ç»“:")
    print()
    print("âœ… ä¼˜ç‚¹:")
    print("   â€¢ æ€§èƒ½æœ€ä¼˜ï¼šæœ¬åœ°æ“ä½œæ— å»¶è¿Ÿ")
    print("   â€¢ æˆæœ¬æ§åˆ¶ï¼šä»…å¤‡ä»½ä¸åŒå‘åŒæ­¥")
    print("   â€¢ æ•°æ®å®‰å…¨ï¼šäº‘ç«¯å¤‡ä»½ä¿éšœ")
    print("   â€¢ ç®€å•å¯é ï¼šå•å‘å¤‡ä»½é€»è¾‘ç®€å•")
    print()
    print("âš ï¸ é™åˆ¶:")
    print("   â€¢ æ— å®æ—¶æ•°æ®åŒæ­¥")
    print("   â€¢ å¤‡ä»½æ•°æ®éœ€æ‰‹åŠ¨æ¢å¤æŸ¥çœ‹")
    print("   â€¢ ä¸é€‚åˆå¤šè®¾å¤‡åä½œåœºæ™¯")
    print()
    print("ğŸ¯ é€‚ç”¨åœºæ™¯:")
    print("   â€¢ ä¸ªäººç”¨æˆ·æ•°æ®å¤‡ä»½")
    print("   â€¢ å•æœºä½¿ç”¨ç¯å¢ƒ")
    print("   â€¢ å¯¹æˆæœ¬æ•æ„Ÿçš„åº”ç”¨")
    print("   â€¢ æ•°æ®å®‰å…¨æ€§è¦æ±‚é«˜ä½†åä½œéœ€æ±‚ä½çš„åœºæ™¯")


if __name__ == "__main__":
    main()
